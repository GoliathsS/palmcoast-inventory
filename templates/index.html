<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Palm Coast Inventory ¬∑ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Manage products, vehicles, pricing, and scans in one clean dashboard." />
  <meta property="og:title" content="Palm Coast Inventory ¬∑ Dashboard" />
  <meta property="og:description" content="Fast, mobile-first inventory control with scanning and analytics." />
  <meta name="theme-color" content="#14532d" />

  <!-- Fonts + Bootstrap -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- App assets -->
  <link rel="manifest" href="/static/manifest.json">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/palm_icon_180.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/static/palm_icon_192.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ========= Tokens ========= */
    :root{
      --pc-brand:#14532d; --pc-brand-2:#0e5a34; --pc-ink:#101418; --pc-muted:#6b7280;
      --pc-bg:#f5f7fa; --pc-card:#ffffff; --pc-ring:rgba(20,83,45,.35);
      --ok:#198754; --low:#dc3545; --warn:#f59e0b;
    }
    @media (prefers-color-scheme: dark){
      :root{ --pc-bg:#0d1117; --pc-card:#0f141c; --pc-ink:#e6edf3; --pc-muted:#9aa4b2; }
      .table thead th{background:#111827!important}
    }
    html{scroll-behavior:smooth}
    body{background:var(--pc-bg); color:var(--pc-ink); font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    /* Header */
    .app-header{position:sticky; top:0; z-index:1030; background:rgba(255,255,255,.92); backdrop-filter:blur(8px); border-bottom:1px solid rgba(0,0,0,.06)}
    .brand-logo{width:32px; height:32px; border-radius:6px; object-fit:cover}
    .kpi{display:flex; gap:.5rem; align-items:baseline; padding:.35rem .6rem; border:1px solid rgba(0,0,0,.08); border-radius:8px; background:#f1f8f4}

    /* Hero */
    .hero{background:linear-gradient(135deg,var(--pc-brand),var(--pc-brand-2)); color:#fff; border-radius:16px; padding:16px; display:flex; align-items:center; justify-content:space-between; gap:12px; box-shadow:0 10px 24px rgba(0,0,0,.14)}
    .hero .value{font-weight:800; font-size:clamp(1.25rem,1.2vw+1rem,1.6rem)}

    /* Cards / Actions */
    .card-soft{background:var(--pc-card); border:1px solid rgba(0,0,0,.06); border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .actions{display:grid; grid-template-columns:repeat(2,1fr); gap:.75rem}
    @media(min-width:768px){.actions{grid-template-columns:repeat(6,1fr)}}
    .action{background:var(--pc-card); border:1px solid rgba(0,0,0,.06); border-radius:12px; padding:.85rem .9rem; display:flex; gap:.6rem; align-items:center; text-decoration:none; color:inherit; transition:transform .12s ease, box-shadow .12s ease}
    .action:hover{transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.08)}
    .action i{width:28px; height:28px; display:grid; place-items:center; border-radius:8px; font-size:14px}
    .i-gray{background:#eef2f7; color:#374151} .i-blue{background:#e7efff; color:#1d4ed8} .i-green{background:#e7f7ec; color:#15803d}
    .i-orange{background:#fff1e6; color:#b45309} .i-red{background:#ffe8e8; color:#b91c1c} .i-cyan{background:#e6fbff; color:#0e7490}

    /* Filters / Chips */
    .chipbar{display:flex; gap:.5rem; flex-wrap:wrap}
    .chip input{display:none}
    .chip label{cursor:pointer; padding:.45rem .7rem; border-radius:999px; border:1px solid rgba(0,0,0,.08); background:#fff; font-weight:600; font-size:.9rem}
    .chip input:checked + label{background:#e9f6ee; border-color:var(--pc-brand); color:#0f5132}

    /* Table */
    .table-wrap{max-height:65vh; overflow:auto}
    .table thead th{position:sticky; top:0; z-index:1; background:#fff}
    .table tbody tr:hover{background:rgba(20,83,45,.03)}
    .status-pill{padding:.25rem .5rem; border-radius:999px; font-weight:700; font-size:.8rem}
    .pill-ok{background:#eaf7ef; color:#0f5132; border:1px solid rgba(16,81,50,.2)}
    .pill-low{background:#fdecec; color:#b91c1c; border:1px solid rgba(185,28,28,.2)}
    .pill-out{background:#2b0b0b; color:#fff}

    /* Small helpers */
    .form-control:focus, .form-select:focus, .btn:focus{box-shadow:0 0 0 .2rem var(--pc-ring)!important; outline:none!important}
    .sticky-bottom-bar{position:sticky; bottom:0; z-index:1030; background:rgba(255,255,255,.98); border-top:1px solid rgba(0,0,0,.08); backdrop-filter:blur(6px)}
    @media (prefers-reduced-motion: reduce){*{transition:none!important; animation:none!important; scroll-behavior:auto!important}}
  </style>
</head>
<body>

  <!-- ===== Header ===== -->
  <div class="app-header">
    <div class="container py-2 d-flex align-items-center justify-content-between gap-2">
      <div class="d-flex align-items-center gap-2">
        <img src="/static/LOGO.jpg" alt="Palm Coast" class="brand-logo" />
        <strong>Palm Coast Inventory</strong>
      </div>
      <form method="get" action="/" class="d-none d-md-flex align-items-center gap-2">
        <input name="q" value="{{ request.args.get('q','') }}" class="form-control form-control-sm" placeholder="Search products..." aria-label="Search products" />
        <button class="btn btn-sm btn-outline-secondary">Search</button>
      </form>
      <div class="kpi">
        <span class="text-muted small">Total Value</span>
        <span class="fw-bold">${{ '%.2f' | format(total_value or 0.00) }}</span>
      </div>
    </div>
  </div>

  <div class="container py-3">

    <!-- ===== Hero ===== -->
    <section class="hero mb-4">
      <div>
        <h1 class="m-0" style="font-size:clamp(1.1rem,1.2vw+1rem,1.6rem);">Inventory Dashboard</h1>
        <small>Manage products, vehicles, scans & pricing</small>
      </div>
      <div class="text-end">
        <div class="value">${{ '%.2f' | format(total_value or 0.00) }}</div>
        <small>üåø Lawn {{ lawn_count }} ‚Ä¢ üêú Pest {{ pest_count }} ‚Ä¢ ü¶ù Wildlife {{ wildlife_count }}</small>
      </div>
    </section>

    <!-- ===== Actions ===== -->
    <section class="actions mb-4" aria-label="Quick actions">
      <a href="/scan" class="action"><i class="i-green fa-solid fa-barcode"></i><span>Open Scanner</span></a>
      <a href="/history" class="action"><i class="i-gray fa-solid fa-receipt"></i><span>View History</span></a>
      <a href="/export-products" class="action"><i class="i-green fa-solid fa-file-export"></i><span>Export to Excel</span></a>
      <a href="/print-report" target="_blank" class="action"><i class="i-orange fa-solid fa-print"></i><span>Print Report</span></a>
      <a href="/upload-invoice" class="action"><i class="i-blue fa-solid fa-paperclip"></i><span>Upload Invoice (Sync)</span></a>
      <a href="/corrections" class="action"><i class="i-red fa-solid fa-screwdriver-wrench"></i><span>Corrections</span></a>
      <a href="/sds" class="action"><i class="i-cyan fa-solid fa-file-lines"></i><span>SDS & Labels</span></a>
      <a href="/vehicles" class="action"><i class="i-blue fa-solid fa-truck"></i><span>Vehicle Profiles</span></a>
      <a href="/inspections" class="action"><i class="i-gray fa-solid fa-clipboard-check"></i><span>Vehicle Inspections</span></a>
      <a href="{{ url_for('inventory_analytics') }}" class="action"><i class="i-blue fa-solid fa-chart-line"></i><span>Inventory Analytics</span></a>
      <a href="/settings" class="action"><i class="i-gray fa-solid fa-gear"></i><span>Settings</span></a>
    </section>

    <!-- ===== Filters ===== -->
    <section class="card-soft p-3 mb-3">
      <form method="get" action="/" class="d-flex flex-wrap align-items-center gap-2">
        <span class="fw-semibold me-1">Category:</span>
        <div class="chipbar">
          {% set cat = category_filter or 'All' %}
          <div class="chip">
            <input type="radio" id="c-all" name="category" value="All" {% if cat=='All' %}checked{% endif %} onchange="this.form.submit()">
            <label for="c-all">All</label>
          </div>
          <div class="chip">
            <input type="radio" id="c-pest" name="category" value="Pest" {% if cat=='Pest' %}checked{% endif %} onchange="this.form.submit()">
            <label for="c-pest">Pest</label>
          </div>
          <div class="chip">
            <input type="radio" id="c-lawn" name="category" value="Lawn" {% if cat=='Lawn' %}checked{% endif %} onchange="this.form.submit()">
            <label for="c-lawn">Lawn</label>
          </div>
          <div class="chip">
            <input type="radio" id="c-wild" name="category" value="Wildlife" {% if cat=='Wildlife' %}checked{% endif %} onchange="this.form.submit()">
            <label for="c-wild">Wildlife</label>
          </div>
        </div>

        <!-- NEW: Low stock first toggle -->
        <div class="form-check form-switch ms-auto">
          <input class="form-check-input" type="checkbox" id="lowFirstToggle" aria-label="Sort low stock first">
          <label class="form-check-label" for="lowFirstToggle">Low stock first</label>
        </div>
      </form>
    </section>

    <!-- ===== Add Product ===== -->
    <section class="card-soft p-3 mb-4">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h5 class="mb-0">Add Product</h5>
        <small class="text-muted">Barcodes scan straight into the field</small>
      </div>
      <form method="POST" action="/add-product" class="row g-2">
        <div class="col-12 col-md-4">
          <input type="text" class="form-control" placeholder="Product Name" name="name" required aria-label="Product name">
        </div>
        <div class="col-12 col-md-3 position-relative">
          <input type="text" class="form-control" placeholder="Barcode" name="barcode" id="barcode-field" required aria-label="Barcode">
          <button type="button" id="scan-btn" class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 mt-1 me-1" aria-label="Scan barcode">üì∑</button>
        </div>
        <div class="col-6 col-md-2">
          <input type="number" class="form-control" placeholder="Min Stock" name="min_stock" required aria-label="Minimum stock">
        </div>
        <div class="col-6 col-md-2">
          <input type="number" step="0.01" class="form-control" placeholder="Cost per Item" name="cost_per_unit" required aria-label="Cost per item">
        </div>
        <div class="col-6 col-md-2">
          <input type="number" min="1" class="form-control" placeholder="Units per Item" name="units_per_item" value="1" required aria-label="Units per item">
        </div>
        <div class="col-6 col-md-2">
          <input type="number" step="0.01" class="form-control" placeholder="Auto Unit Cost" name="unit_cost" readonly aria-label="Auto-calculated unit cost">
        </div>
        <div class="col-12 col-md-3">
          <input type="text" class="form-control" placeholder="SiteOne SKU (optional)" name="siteone_sku" aria-label="SiteOne SKU">
        </div>
        <div class="col-6 col-md-2">
          <select class="form-select" name="category" aria-label="Category">
            <option value="Pest">Pest</option>
            <option value="Lawn">Lawn</option>
            <option value="Wildlife">Wildlife</option>
          </select>
        </div>
        <div class="col-12 col-md-3 ms-auto">
          <button type="submit" class="btn btn-success w-100">‚ûï Add Product</button>
        </div>
      </form>
    </section>

    <!-- ===== Products ===== -->
    <section class="card-soft p-0">
      <div class="p-3 pb-0 d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h5 class="mb-0">Products</h5>
        <small class="text-muted">Status: OK / Low / Out</small>
      </div>

      <!-- NEW: Per-category totals (current table view) -->
      <div class="px-3 pb-2">
        <div id="catTotals" class="d-flex flex-wrap gap-2 small"></div>
      </div>

      <div class="table-wrap">
        <table id="productsTable" class="table table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th>Barcode</th>
              <th>In Stock</th>
              <th>Units Remaining</th>
              <th>Min Stock</th>
              <th>Status</th>
              <th>Price</th>
              <th>Category</th>
              <th style="min-width:120px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for product in products %}
            <tr data-category="{{ product[7] }}">
              <td class="fw-semibold">{{ product[1] }}</td>
              <td class="text-muted">{{ product[2] }}</td>
              <td>{{ product[3] }}</td>
              <td>{{ product[10] or 0 }}</td>
              <td>{{ product[4] }}</td>
              <td>
                {% if product[3] == 0 %}
                  <span class="status-pill pill-out">Out</span>
                {% elif product[3] < product[4] %}
                  <span class="status-pill pill-low">Low</span>
                {% else %}
                  <span class="status-pill pill-ok">OK</span>
                {% endif %}
              </td>
              <td>${{ '%.2f' | format(product[5] or 0.00) }}</td>
              <td>
                {% if product[7] == 'Lawn' %}
                  <span class="badge bg-success">Lawn</span>
                {% elif product[7] == 'Wildlife' %}
                  <span class="badge bg-warning text-dark">Wildlife</span>
                {% else %}
                  <span class="badge bg-info text-dark">Pest</span>
                {% endif %}
              </td>
              <td>
                <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#editModal{{ product[0] }}">‚úèÔ∏è Edit</button>
                <form action="/delete-product/{{ product[0] }}" method="post" style="display:inline-block" onsubmit="return confirm('Are you sure?')">
                  <button class="btn btn-sm btn-outline-danger">üóë Delete</button>
                </form>
              </td>
            </tr>

            <!-- Edit Modal -->
            <div class="modal fade" id="editModal{{ product[0] }}" tabindex="-1" aria-labelledby="editModalLabel{{ product[0] }}" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form method="POST" action="/edit-product/{{ product[0] }}">
                    <div class="modal-header">
                      <h5 class="modal-title" id="editModalLabel{{ product[0] }}">Edit Product</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-2">
                        <label class="form-label">Product Name</label>
                        <input type="text" name="name" class="form-control" value="{{ product[1] }}" required>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Barcode</label>
                        <input type="text" name="barcode" class="form-control" value="{{ product[2] }}" required>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Min Stock</label>
                        <input type="number" name="min_stock" class="form-control" value="{{ product[4] }}" required>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Cost per Item</label>
                        <input type="number" step="0.01" name="cost_per_unit" class="form-control" value="{{ product[5] or 0.00 }}" required>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Units per Item</label>
                        <input type="number" name="units_per_item" class="form-control" value="{{ product[8] or 1 }}" min="1" required>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Auto Unit Cost</label>
                        <input type="number" step="0.01" name="unit_cost" class="form-control" value="{{ product[9] or '' }}" readonly>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-select">
                          <option value="Pest" {% if product[7] == 'Pest' %}selected{% endif %}>Pest</option>
                          <option value="Lawn" {% if product[7] == 'Lawn' %}selected{% endif %}>Lawn</option>
                          <option value="Wildlife" {% if product[7] == 'Wildlife' %}selected{% endif %}>Wildlife</option>
                        </select>
                      </div>
                      <div class="mb-1">
                        <label class="form-label">SiteOne SKU</label>
                        <input type="text" name="siteone_sku" class="form-control" value="{{ product[6] or '' }}">
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

  </div>

  <!-- Sticky bottom (mobile) -->
  <div class="sticky-bottom-bar d-md-none">
    <div class="container py-2 d-flex gap-2">
      <a href="/scan" class="btn btn-success w-50">üì¶ Scan</a>
      <a href="/history" class="btn btn-outline-secondary w-50">üßæ History</a>
    </div>
  </div>

  <!-- Audio -->
  <audio id="beep-sound" src="/static/beep.mp3" preload="auto"></audio>

  <!-- Scanner Modal -->
  <div class="modal fade" id="scannerModal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="scannerModalLabel">Scan Barcode</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeModalBtn"></button>
        </div>
        <div class="modal-body text-center">
          <video id="scannerPreview" autoplay muted playsinline style="width:100%; border-radius:12px;"></video>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ZXing (scanner) -->
  <script type="module">
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm';
    const barcodeField = document.getElementById("barcode-field");
    const scanBtn = document.getElementById("scan-btn");
    const videoElem = document.getElementById("scannerPreview");
    const modalElem = new bootstrap.Modal(document.getElementById("scannerModal"));
    const closeModalBtn = document.getElementById("closeModalBtn");
    const beep = document.getElementById("beep-sound");
    const reader = new BrowserMultiFormatReader();

    scanBtn?.addEventListener("click", async () => {
      modalElem.show();
      try {
        const result = await reader.decodeOnceFromVideoDevice(undefined, videoElem);
        barcodeField.value = result.getText();
        beep?.play();
      } catch(e){ console.error(e); }
      finally { modalElem.hide(); reader.reset(); }
    });
    closeModalBtn?.addEventListener("click", () => reader.reset());
  </script>

  <!-- Low-first sorting + category totals -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const table = document.getElementById('productsTable');
      const tbody = table?.querySelector('tbody');
      const lowToggle = document.getElementById('lowFirstToggle');
      const totalsBox = document.getElementById('catTotals');

      function statusPriority(stock, min){
        if (isNaN(stock) || isNaN(min)) return 0;
        if (stock === 0) return 3;       // highest priority
        if (stock < min) return 2;
        return 1;                        // OK
      }

      function sortLowFirst(on){
        if (!tbody) return;
        const rows = Array.from(tbody.querySelectorAll('tr'));
        if (!on){
          // restore to original DOM order (by original index)
          rows.sort((a,b)=> (a._idx??0) - (b._idx??0));
        }else{
          rows.sort((a,b)=>{
            const aStock = parseFloat(a.children[2]?.textContent) || 0;
            const aMin   = parseFloat(a.children[4]?.textContent) || 0;
            const bStock = parseFloat(b.children[2]?.textContent) || 0;
            const bMin   = parseFloat(b.children[4]?.textContent) || 0;

            const ap = statusPriority(aStock,aMin);
            const bp = statusPriority(bStock,bMin);
            if (bp !== ap) return bp - ap;    // Out/Low first

            // tie-breaker: closer to zero (stock - min)
            const ad = aStock - aMin;
            const bd = bStock - bMin;
            return ad - bd;
          });
        }
        rows.forEach(r => tbody.appendChild(r));
        updateTotals(); // totals unchanged, but cheap to recompute
      }

      function updateTotals(){
        if (!totalsBox || !tbody) return;
        const counts = {All:0, Pest:0, Lawn:0, Wildlife:0};
        tbody.querySelectorAll('tr').forEach(tr=>{
          counts.All++;
          const cat = tr.dataset.category || tr.children[7]?.innerText.trim();
          if (counts[cat] !== undefined) counts[cat]++; 
        });
        totalsBox.innerHTML = `
          <span class="badge bg-secondary-subtle text-secondary-emphasis">All: ${counts.All}</span>
          <span class="badge bg-info text-dark">Pest: ${counts.Pest}</span>
          <span class="badge bg-success">Lawn: ${counts.Lawn}</span>
          <span class="badge bg-warning text-dark">Wildlife: ${counts.Wildlife}</span>
        `;
      }

      // store original order
      tbody?.querySelectorAll('tr').forEach((tr,i)=> tr._idx = i);

      // initialize from URL ?sort=low
      const params = new URLSearchParams(location.search);
      const startLow = params.get('sort') === 'low';
      if (lowToggle) lowToggle.checked = startLow;

      sortLowFirst(startLow);
      updateTotals();

      lowToggle?.addEventListener('change', e => sortLowFirst(e.target.checked));
    });
  </script>

  <footer class="container text-center py-4 text-muted" style="font-size:.9rem;">
    Developed for Palm Coast Pest Control by <strong>Cole Laczynski</strong>
  </footer>
</body>
</html>
