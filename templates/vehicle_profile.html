<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vehicle Profile · Palm Coast Fleet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Live vehicle profile with inventory, inspections, maintenance reminders, and service history." />
  <meta property="og:title" content="Vehicle Profile · Palm Coast Fleet" />
  <meta property="og:description" content="Track inventory, inspections, and maintenance in one clean view." />
  <meta property="og:type" content="website" />
  <meta name="theme-color" content="#198754" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Global styles if any -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    /* ===== Design Tokens (Light Only) ===== */
    :root{
      --brand:#198754;          /* Bootstrap success as brand */
      --ink:#0b1220;            /* Primary text */
      --muted:#6b7280;          /* Secondary text */
      --bg:#f7f8fa;             /* Page background */
      --card:#ffffff;           /* Panels/cards */
      --border:#e6e7eb;         /* Strokes */
      --ring:rgba(25,135,84,.25);
      --radius:14px;
      --shadow:0 8px 24px rgba(17,24,39,.06), 0 2px 6px rgba(17,24,39,.04);
    }

    html{scroll-behavior:smooth;}
    body{background:var(--bg); color:var(--ink); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;}

    h1,h2,h3{line-height:1.25; letter-spacing:.2px}
    h1{font-size:clamp(1.4rem,1.8vw+1rem,2rem)}
    h2{font-size:clamp(1.2rem,1.2vw+1rem,1.4rem)}
    .lead{color:var(--muted)}
    .small-muted{color:var(--muted); font-size:.95rem}

    /* ===== Header / Top Nav ===== */
    .app-header{
      position:sticky; top:0; z-index:1030;
      background:rgba(255,255,255,.9);
      backdrop-filter:saturate(1.2) blur(6px);
      border-bottom:1px solid var(--border);
      transition:padding .2s ease;
    }
    .app-header .brand{
      display:flex; align-items:center; gap:.6rem; font-weight:700;
    }
    .brand-dot{width:.55rem; height:.55rem; border-radius:50%; background:var(--brand)}
    .app-header.shrink{padding-block:.25rem}

    /* Top section pills */
    .top-tabs{overflow-x:auto; white-space:nowrap; -webkit-overflow-scrolling:touch}
    .top-tabs .nav-link{
      border:1px solid var(--border);
      border-radius:999px;
      padding:.4rem .9rem;
      margin-right:.5rem;
      color:#111;
      background:#fff;
    }
    .top-tabs .nav-link:hover{background:#f5f7f6}
    .top-tabs .nav-link.active{
      color:#fff; background:var(--brand); border-color:var(--brand);
    }

    /* ===== Surfaces ===== */
    .card-lite{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    /* ===== KPI chips ===== */
    .kpi{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.35rem .6rem; border-radius:999px; border:1px solid #cfe7db;
      background:#f1fbf5; color:#0f5132; font-weight:600; font-size:.95rem;
    }

    /* ===== Photo Grid ===== */
    .photo-gallery{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:.75rem;
    }
    .photo-gallery img{
      width:100%; height:120px; object-fit:cover;
      border-radius:.6rem; border:1px solid var(--border); background:#eef1f4;
    }

    /* ===== Tables ===== */
    .table thead th{background:#f3f7f4; border-bottom:1px solid var(--border)}
    .table-bordered{border-color:var(--border)}
    .table>:not(caption)>*>*{vertical-align:middle}
    .table-hover tbody tr:hover{background:rgba(25,135,84,.04)}

    /* ===== Progress ===== */
    .due-wrap{min-width:220px}
    .due-bar{height:.6rem; background:#eef1f4; border-radius:999px; overflow:hidden}
    .due-bar>span{display:block; height:100%; background:var(--brand); transition:width .25s ease}

    /* ===== Forms / Focus ===== */
    .form-control:focus,.form-select:focus,.btn:focus{
      box-shadow:0 0 0 .2rem var(--ring)!important; outline:none!important;
    }

    /* ===== Sticky bottom actions ===== */
    .sticky-actions{
      position:sticky; bottom:0; z-index:1020;
      background:rgba(255,255,255,.92); backdrop-filter:blur(6px);
      border-top:1px solid var(--border);
    }

    /* Spacing tweaks */
    @media (max-width:576px){
      .table td,.table th{padding:.6rem .5rem; font-size:.95rem}
      .accordion-button{padding:.85rem 1rem}
    }
  </style>
</head>
<body>
  {# ===== Role helpers ===== #}
  {% set is_admin = current_user.is_authenticated and current_user.role == 'ADMIN' %}
  {% set is_tech  = current_user.is_authenticated and current_user.role == 'TECH' %}

  <!-- ===== Header ===== -->
  <header class="app-header py-2">
    <div class="container d-flex align-items-center justify-content-between gap-2">
      <div class="brand">
        <span class="brand-dot" aria-hidden="true"></span>
        <span>Palm Coast Fleet</span>
        <span class="small-muted">/ Vehicle</span>
      </div>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        {% if reminders and reminders|length > 0 %}
          {% set overdue = reminders|selectattr('status','equalto','overdue')|list|length %}
          <span class="kpi" aria-label="Maintenance status">Overdue: {{ overdue }} · Total: {{ reminders|length }}</span>
        {% endif %}
        {% if inventory %}
          <span class="kpi" aria-label="Inventory items">Inventory Items: {{ inventory|length }}</span>
        {% endif %}
      </div>
    </div>

    <div class="border-top mt-2">
      <nav class="container py-2 top-tabs">
        <ul class="nav">
          <li class="nav-item"><a class="nav-link active" href="#profile">Vehicle</a></li>
          <li class="nav-item"><a class="nav-link" href="#inventory">Inventory</a></li>
          <li class="nav-item"><a class="nav-link" href="#inspections">Inspections</a></li>
          <li class="nav-item"><a class="nav-link" href="#upcoming">Upcoming</a></li>
          <li class="nav-item"><a class="nav-link" href="#history">History</a></li>
          <li class="nav-item"><a class="nav-link" href="#services">Services</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main id="content" class="container py-3" role="main">
    {% if is_tech %}
      <p class="mb-2"><a href="{{ url_for('tech_home') }}" class="link-secondary">← Back to Tech Home</a></p>
    {% endif %}

    <!-- Vehicle Summary -->
    <section id="profile" class="card-lite p-3 p-md-4 mb-3" aria-labelledby="veh-title">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <h1 id="veh-title" class="mb-1">Vehicle Profile</h1>
          <p class="lead mb-0">All details, inspections, inventory, and maintenance in one place.</p>
        </div>
        {% set hero = (inspections[0].photo_front if inspections and inspections[0].photo_front else None) %}
        <div class="ms-auto">
          {% if hero %}
            <img src="{{ hero }}" alt="Latest front photo of vehicle" width="360" height="200"
                 style="object-fit:cover; border-radius:12px; border:1px solid var(--border)" loading="lazy" decoding="async" />
          {% endif %}
        </div>
      </div>

      <hr class="my-3">

      <div class="row g-3">
        <div class="col-12 col-md-4">
          <div class="p-3 border rounded-3 bg-white h-100">
            <div class="small-muted mb-1">License Plate</div>
            <div class="fw-semibold">{{ vehicle[1] }}</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="p-3 border rounded-3 bg-white h-100">
            <div class="small-muted mb-1">Vehicle Type</div>
            <div class="fw-semibold">{{ vehicle[2] }}</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="p-3 border rounded-3 bg-white h-100">
            <div class="small-muted mb-1">Assigned Technician</div>
            <div class="fw-semibold">{{ vehicle[3] or 'Unassigned' }}</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Accordion -->
    <div class="accordion" id="vehicleAccordion" aria-label="Vehicle sections">

      <!-- Permanent Equipment -->
      <section class="accordion-item">
        <h2 class="accordion-header" id="headingEquipment">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEquipment" aria-expanded="false" aria-controls="collapseEquipment">
            Permanent Equipment
          </button>
        </h2>
        <div id="collapseEquipment" class="accordion-collapse collapse" aria-labelledby="headingEquipment" data-bs-parent="#vehicleAccordion">
          <div class="accordion-body">
            {% if equipment and equipment|length > 0 %}
              <div class="table-responsive">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Item</th>
                      <th scope="col">Status</th>
                      <th scope="col">Last Verified</th>
                      <th scope="col">Notes</th>
                      <th scope="col" class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for item in equipment %}
                    <tr>
                      <td class="fw-semibold">{{ item.item_name }}</td>
                      <td style="min-width:150px">
                        {% if is_admin %}
                          <form class="d-flex align-items-center gap-2" action="{{ url_for('update_single_equipment', vehicle_id=vehicle[0], equipment_id=item.id) }}" method="POST">
                            <label for="status_{{ item.id }}" class="visually-hidden">Status</label>
                            <select id="status_{{ item.id }}" name="status" class="form-select form-select-sm">
                              <option value="Assigned" {% if item.status == 'Assigned' %}selected{% endif %}>Assigned</option>
                              <option value="Missing" {% if item.status == 'Missing' %}selected{% endif %}>Missing</option>
                              <option value="Needs Repair" {% if item.status == 'Needs Repair' %}selected{% endif %}>Needs Repair</option>
                            </select>
                        {% else %}
                          {{ item.status or '—' }}
                        {% endif %}
                      </td>
                      <td>{{ item.last_verified.strftime('%Y-%m-%d') if item.last_verified else '—' }}</td>
                      <td style="min-width:220px">
                        {% if is_admin %}
                          <label for="notes_{{ item.id }}" class="visually-hidden">Notes</label>
                          <input id="notes_{{ item.id }}" type="text" name="notes" value="{{ item.notes or '' }}" class="form-control form-control-sm" placeholder="Optional notes" />
                        {% else %}
                          {{ item.notes or '—' }}
                        {% endif %}
                      </td>
                      <td class="text-end">
                        {% if is_admin %}
                          <button class="btn btn-sm btn-primary">Save</button>
                          <a href="{{ url_for('delete_equipment', vehicle_id=vehicle[0], equipment_id=item.id) }}"
                             class="btn btn-sm btn-outline-danger ms-1"
                             onclick="return confirm('Remove this tool?')"
                             aria-label="Delete {{ item.item_name }}">Delete</a>
                          </form>
                        {% else %}
                          —
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="small-muted mb-0">No permanent equipment recorded yet.</p>
            {% endif %}

            <hr class="my-3">
            {% if is_admin %}
              <h3 class="h5 mb-3">Add Custom Tool</h3>
              <form method="POST" action="{{ url_for('add_equipment', vehicle_id=vehicle[0]) }}" class="row g-2" aria-label="Add tool">
                <div class="col-12 col-sm-5 col-md-4">
                  <label for="item_name" class="form-label visually-hidden">Item Name</label>
                  <input id="item_name" type="text" name="item_name" class="form-control" placeholder="Item Name" required>
                </div>
                <div class="col-6 col-sm-3 col-md-3">
                  <label for="status_new" class="form-label visually-hidden">Status</label>
                  <select id="status_new" name="status" class="form-select">
                    <option value="Assigned">Assigned</option>
                    <option value="Missing">Missing</option>
                    <option value="Needs Repair">Needs Repair</option>
                  </select>
                </div>
                <div class="col-12 col-sm-4 col-md-3">
                  <label for="notes_new" class="form-label visually-hidden">Notes</label>
                  <input id="notes_new" type="text" name="notes" class="form-control" placeholder="Optional Notes">
                </div>
                <div class="col-6 col-sm-2 col-md-2">
                  <button class="btn btn-success w-100">Add</button>
                </div>
              </form>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- Truck Inventory -->
      <section class="accordion-item" id="inventory">
        <h2 class="accordion-header" id="headingInventory">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInventory" aria-expanded="true" aria-controls="collapseInventory">
            Truck Inventory
          </button>
        </h2>
        <div id="collapseInventory" class="accordion-collapse collapse show" data-bs-parent="#vehicleAccordion">
          <div class="accordion-body">
            {% if inventory and inventory|length > 0 %}
              <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Product</th>
                      <th scope="col">Quantity</th>
                      <th scope="col">Last Scanned</th>
                      <th scope="col">Expires On</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for item in inventory %}
                    <tr>
                      <td class="fw-semibold">{{ item[0] }}</td>
                      <td>{{ item[1] }}</td>
                      <td>{{ item[2].strftime('%Y-%m-%d') if item[2] else '—' }}</td>
                      <td>{{ item[3].strftime('%Y-%m-%d') if item[3] else '—' }}</td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="small-muted mb-0">This truck currently has no products assigned.</p>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- Inspections -->
      <section class="accordion-item" id="inspections">
        <h2 class="accordion-header" id="headingInspections">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInspections" aria-expanded="false" aria-controls="collapseInspections">
            Recent Inspections
          </button>
        </h2>
        <div id="collapseInspections" class="accordion-collapse collapse" data-bs-parent="#vehicleAccordion">
          <div class="accordion-body">
            {% if inspections and inspections|length > 0 %}
              {% for i in inspections %}
                <article class="card-lite p-3 mb-3">
                  <div class="row g-2">
                    <div class="col-6 col-md-3"><strong>Date:</strong> {{ i.date.strftime('%Y-%m-%d') }}</div>
                    <div class="col-6 col-md-3"><strong>Mileage:</strong> {{ i.mileage }} mi</div>
                    <div class="col-6 col-md-3"><strong>Cleanliness:</strong> {{ i.cleanliness }}</div>
                    <div class="col-6 col-md-3"><strong>Wrap:</strong> {{ i.wrap_condition }}</div>
                  </div>
                  <div class="photo-gallery mt-3">
                    {% for label, path in [
                      ('Front', i.photo_front), ('Back', i.photo_back), ('Left Side', i.photo_side_left),
                      ('Right Side', i.photo_side_right), ('Tire FL', i.photo_tire_front_left),
                      ('Tire FR', i.photo_tire_front_right), ('Tire RL', i.photo_tire_rear_left),
                      ('Tire RR', i.photo_tire_rear_right)
                    ] %}
                      {% if path %}
                        <figure class="text-center small m-0">
                          <img src="{{ path }}" alt="{{ label }} photo" loading="lazy" decoding="async" width="220" height="120">
                          <figcaption class="mt-1">{{ label }}</figcaption>
                        </figure>
                      {% endif %}
                    {% endfor %}
                  </div>
                </article>
              {% endfor %}
            {% else %}
              <p class="small-muted mb-0">No inspections recorded yet.</p>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- Upcoming Maintenance -->
      <section class="accordion-item" id="upcoming">
        <h2 class="accordion-header" id="headingUpcoming">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUpcoming" aria-expanded="false" aria-controls="collapseUpcoming">
            Upcoming Maintenance
          </button>
        </h2>
        <div id="collapseUpcoming" class="accordion-collapse collapse" data-bs-parent="#vehicleAccordion">
          <div class="accordion-body">
            {% if reminders and reminders|length > 0 %}
              <div class="table-responsive">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Service</th>
                      <th scope="col" class="due-wrap">Due at</th>
                      <th scope="col">Current Mileage</th>
                      <th scope="col">Status</th>
                      <th scope="col">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for r in reminders %}
                    {% set miles_remaining = r.miles_remaining if r.miles_remaining is defined else None %}
                    {% set pct = 0 %}
                    <tr>
                      <td class="fw-semibold">{{ r.service_type }}</td>
                      <td>
                        <div class="d-flex align-items-center justify-content-between">
                          <span>{{ r.due_at }} mi</span>
                          {% if miles_remaining is not none and r.due_at > 0 %}
                            {% set pct = (((r.due_at - miles_remaining) / r.due_at) * 100)|round(0, 'floor') %}
                            <span class="small-muted">{{ miles_remaining }} mi left</span>
                          {% endif %}
                        </div>
                        <div class="due-bar mt-1" aria-hidden="true">
                          <span style="width: {{ pct }}%"></span>
                        </div>
                      </td>
                      <td style="min-width: 160px;">
                        {% if is_admin %}
                          <form class="d-flex align-items-center gap-2" action="/mark-maintenance-complete/{{ vehicle[0] }}" method="POST">
                            <input type="hidden" name="service_type" value="{{ r.service_type }}">
                            <label for="odo_{{ loop.index }}" class="visually-hidden">Odometer</label>
                            <input id="odo_{{ loop.index }}" type="number" inputmode="numeric" pattern="[0-9]*" name="odometer" class="form-control form-control-sm" required placeholder="Enter miles">
                        {% else %}
                          {{ vehicle[4] or '—' }}
                        {% endif %}
                      </td>
                      <td>
                        {% if r.status == 'overdue' %}
                          <span class="badge bg-danger">Overdue</span>
                        {% elif r.status == 'due_soon' %}
                          <span class="badge bg-warning text-dark">Due in {{ r.miles_remaining }} mi</span>
                        {% else %}
                          <span class="badge bg-success">OK</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if is_admin %}
                          <button type="submit" class="btn btn-sm btn-outline-primary">Mark Complete</button>
                          </form>
                        {% else %}
                          —
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="small-muted mb-0">No active reminders yet.</p>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- Maintenance History -->
      <section class="accordion-item" id="history">
        <h2 class="accordion-header" id="headingHistory">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHistory" aria-expanded="false" aria-controls="collapseHistory">
            Maintenance History
          </button>
        </h2>
        <div id="collapseHistory" class="accordion-collapse collapse" data-bs-parent="#vehicleAccordion">
          <div class="accordion-body">
            {% if maintenance_logs and maintenance_logs|length > 0 %}
              <div class="table-responsive">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Service Type</th>
                      <th scope="col">Due at Odometer</th>
                      <th scope="col">Logged On</th>
                      <th scope="col">Invoice</th>
                      <th scope="col">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for m in maintenance_logs if m.received_at %}
                    <tr>
                      <td class="fw-semibold">{{ m.service_type }}</td>
                      <td>{{ m.odometer_due }} mi</td>
                      <td>{{ m.received_at.strftime('%Y-%m-%d') }}</td>
                      <td style="min-width: 180px;">
                        {% if m.invoice_url %}
                          <a href="{{ m.invoice_url }}" target="_blank" class="link-primary">View</a>
                        {% else %}
                          {% if is_admin %}
                            <form action="{{ url_for('upload_vehicle_invoice', maintenance_id=m.id) }}" method="POST" enctype="multipart/form-data" class="d-flex gap-1">
                              <label for="inv_{{ m.id }}" class="visually-hidden">Invoice</label>
                              <input id="inv_{{ m.id }}" type="file" name="invoice" accept="application/pdf" class="form-control form-control-sm" required>
                              <button type="submit" class="btn btn-sm btn-secondary">Upload</button>
                            </form>
                          {% else %}
                            —
                          {% endif %}
                        {% endif %}
                      </td>
                      <td><span class="badge bg-success">Completed</span></td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="small-muted mb-0">No maintenance records yet.</p>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- General Services -->
      <section class="accordion-item" id="services">
        <h2 class="accordion-header" id="headingServices">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseServices" aria-expanded="false" aria-controls="collapseServices">
            General Service History & Add New
          </button>
        </h2>
        <div id="collapseServices" class="accordion-collapse collapse" data-bs-parent="#vehicleAccordion">
          <div class="accordion-body">
            {% if vehicle_services and vehicle_services|length > 0 %}
              <div class="table-responsive">
                <table class="table table-striped table-bordered mb-4 align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Date</th>
                      <th scope="col">Service</th>
                      <th scope="col">Odometer</th>
                      <th scope="col">Notes</th>
                      <th scope="col">Invoice</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for svc in vehicle_services %}
                    <tr>
                      <td>{{ svc.logged_on.strftime('%Y-%m-%d') }}</td>
                      <td class="fw-semibold">{{ svc.service_type }}</td>
                      <td>{{ svc.odometer }} mi</td>
                      <td>{{ svc.notes or '' }}</td>
                      <td>{% if svc.invoice_url %}<a href="{{ svc.invoice_url }}" target="_blank" class="link-primary">View</a>{% else %}—{% endif %}</td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="small-muted">No general services logged yet.</p>
            {% endif %}

            {% if is_admin %}
              <form action="/add-vehicle-service" method="POST" enctype="multipart/form-data" class="card-lite p-3">
                <input type="hidden" name="vehicle_id" value="{{ vehicle[0] }}">
                <div class="row g-3">
                  <div class="col-12 col-md-4">
                    <label class="form-label" for="svc_type">Service Type</label>
                    <input id="svc_type" type="text" name="service_type" class="form-control" required>
                  </div>
                  <div class="col-12 col-md-3">
                    <label class="form-label" for="svc_odometer">Odometer</label>
                    <input id="svc_odometer" type="number" inputmode="numeric" pattern="[0-9]*" name="odometer" class="form-control" required>
                  </div>
                  <div class="col-12 col-md-5">
                    <label class="form-label" for="svc_notes">Notes</label>
                    <textarea id="svc_notes" name="notes" class="form-control" rows="1" placeholder="Optional"></textarea>
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label" for="svc_invoice">Invoice File (PDF or Image)</label>
                    <input id="svc_invoice" type="file" name="invoice_file" accept="application/pdf,image/*" class="form-control">
                  </div>
                  <div class="col-12 col-md-6 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Add Service</button>
                  </div>
                </div>
              </form>
            {% endif %}
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- ===== Sticky Bottom Actions ===== -->
  {% if is_admin %}
    <div class="sticky-actions" role="navigation" aria-label="Admin actions">
      <div class="container py-2 d-flex gap-2 justify-content-between">
        <a href="/vehicles" class="btn btn-outline-secondary w-50" aria-label="Back to vehicles">← Vehicles</a>
        <a href="/vehicle-inspection/{{ vehicle[0] }}" class="btn btn-success w-50" aria-label="Start a new inspection">Start Inspection</a>
      </div>
    </div>
  {% elif is_tech %}
    <div class="sticky-actions" role="navigation" aria-label="Tech actions">
      <div class="container py-2">
        <a href="{{ url_for('tech_home') }}" class="btn btn-outline-secondary w-100" aria-label="Back to Tech Home">
          ← Back to Tech Home
        </a>
      </div>
    </div>
  {% endif %}

  <!-- ===== Footer ===== -->
  <footer class="container py-4 small-muted">
    <div class="d-flex flex-wrap justify-content-between">
      <div>© {{  now().year  if now else '' }} Palm Coast Pest Control</div>
      <div class="d-flex gap-3">
        <a class="link-secondary" href="#profile">Top</a>
        <a class="link-secondary" href="/support">Support</a>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Header shrink on scroll
    const header = document.querySelector('.app-header');
    let lastY = 0;
    const onScroll = () => {
      const y = window.scrollY || document.documentElement.scrollTop;
      if (y > 60 && y > lastY){ header.classList.add('shrink'); }
      else if (y < 40){ header.classList.remove('shrink'); }
      lastY = y;
    };
    document.addEventListener('scroll', onScroll, {passive:true});

    // Keyboard focus ring once tab is used
    (function(){
      function handleFirstTab(e){
        if (e.key === 'Tab'){
          document.body.classList.add('user-is-tabbing');
          window.removeEventListener('keydown', handleFirstTab);
        }
      }
      window.addEventListener('keydown', handleFirstTab);
    })();
  </script>
</body>
</html>
