<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vehicle Profile · Palm Coast Fleet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Live vehicle profile with inventory, inspections, maintenance reminders, and service history." />
  <meta property="og:title" content="Vehicle Profile · Palm Coast Fleet" />
  <meta property="og:description" content="Track inventory, inspections, and maintenance in one clean view." />
  <meta property="og:type" content="website" />
  <meta name="theme-color" content="#0f5132" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Global styles if any -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    /* ============ Design Tokens ============ */
    :root{
      --brand:#198754;        /* Bootstrap 'success' as brand */
      --brand-ink:#0f5132;    /* darker for text/borders */
      --ink:#111;
      --muted:#6c757d;
      --bg:#f6f7f8;
      --card:#ffffff;
      --ring:rgba(25,135,84,.35);
    }

    /* ---------- COLOR / THEME FIXES ---------- */
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0d1117;
        --card:#0f141c;
        --ink:#e6edf3;
        --muted:#9aa4b2;
        --brand-ink:#88f0be;
      }
      body{background:var(--bg); color:var(--ink);}
      .app-header{background:rgba(15,20,28,.9); border-bottom:1px solid rgba(255,255,255,.06);}
      .sticky-actions{background:rgba(15,20,28,.92); border-top:1px solid rgba(255,255,255,.08);}
      .card-lite{background:var(--card); border:1px solid rgba(255,255,255,.06); box-shadow:0 2px 16px rgba(0,0,0,.35);}
      .bg-white{ background:var(--card)!important; }
      .table{color:var(--ink);}
      .table-bordered{border-color:rgba(255,255,255,.08);}
      .table thead th,
      .table-light{background:#111923!important; color:var(--ink); border-color:rgba(255,255,255,.08);}
      .table tbody tr:hover{background:rgba(136,240,190,.08);}
      .accordion-button{background:var(--card); color:var(--ink); border-bottom:1px solid rgba(255,255,255,.06);}
      .accordion-button:not(.collapsed){box-shadow:none;}
      .accordion-item{background:var(--card); border-color:rgba(255,255,255,.08);}
      .top-tabs .btn{
        --bs-btn-color: var(--ink);
        --bs-btn-border-color: rgba(255,255,255,.18);
        --bs-btn-hover-bg: rgba(255,255,255,.06);
        --bs-btn-hover-border-color: rgba(255,255,255,.28);
      }
      .kpi{
        background:rgba(25,135,84,.15);
        color:var(--brand-ink);
        border:1px solid rgba(136,240,190,.30);
      }
      .due-bar{background:rgba(255,255,255,.12);}
      .due-bar > span{background:var(--brand);}
      a.link-primary{color:#6ab7ff;}
      a.link-primary:hover{color:#9bcdff;}
    }

    /* ============ Base / Type ============ */
    html{scroll-behavior:smooth;}
    body{background:var(--bg); color:var(--ink); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;}
    h1,h2,h3,h4{line-height:1.25; letter-spacing:.2px;}
    h1{font-size:clamp(1.4rem,2.2vw+1rem,2rem)}
    h2{font-size:clamp(1.2rem,1.4vw+1rem,1.5rem)}
    .lead{color:var(--muted)}
    .small-muted{color:var(--muted); font-size:.9rem}

    /* ============ Header / Nav ============ */
    .app-header{
      position:sticky; top:0; z-index:1030; background:rgba(255,255,255,.9);
      backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid rgba(0,0,0,.06);
      transition:all .25s ease;
    }
    .app-header.shrink{padding-block:.25rem}
    .brand-dot{width:.5rem; height:.5rem; border-radius:50%; background:var(--brand)}
    .top-tabs{
      overflow-x:auto; -webkit-overflow-scrolling:touch; white-space:nowrap; gap:.5rem;
    }
    .top-tabs .btn{--bs-btn-border-color:rgba(0,0,0,.08)}
    .nav-kpi{
      display:flex; gap:1rem; align-items:center; flex-wrap:wrap;
    }
    .kpi{
      padding:.4rem .6rem; border-radius:.6rem; background:#f0faf4; color:#0f5132; border:1px solid rgba(25,135,84,.2);
    }

    /* ============ Cards / Surfaces ============ */
    .card-lite{
      background:var(--card);
      border:1px solid rgba(0,0,0,.06);
      border-radius:12px;
      box-shadow:0 2px 16px rgba(0,0,0,.04);
    }

    /* Light-mode fix for forced whites */
    .bg-white{ background:var(--card)!important; }

    /* ============ Photo Grid ============ */
    .photo-gallery{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:.75rem;
    }
    .photo-gallery img{
      width:100%; height:110px; object-fit:cover; border-radius:.5rem; border:1px solid rgba(0,0,0,.08);
      background:#e9ecef;
    }

    /* ============ Tables ============ */
    .table thead th{background:#f3f7f4}
    .table tbody tr:hover{background:rgba(25,135,84,.03)}
    .table>:not(caption)>*>*{vertical-align:middle}

    /* ============ Sticky Footer Actions ============ */
    .sticky-actions{
      position:sticky; bottom:0; z-index:1020;
      background:rgba(255,255,255,.92); backdrop-filter:blur(6px);
      border-top:1px solid rgba(0,0,0,.08);
    }

    /* ============ Progress / Status ============ */
    .due-wrap{min-width:220px}
    .due-bar{height:.6rem; background:#e9ecef; border-radius:999px; overflow:hidden}
    .due-bar > span{display:block; height:100%; background:var(--brand); transition:width .3s ease}

    /* ============ Forms / Focus ============ */
    .form-control:focus, .form-select:focus, .btn:focus{
      box-shadow:0 0 0 .2rem var(--ring) !important; outline:none !important;
    }

    /* ============ Accessibility / Motion ============ */
    @media (prefers-reduced-motion: reduce){
      *{animation:none!important; transition:none!important; scroll-behavior:auto!important}
    }

    /* Tighten on small screens */
    @media (max-width:576px){
      .table td, .table th{padding:.55rem .5rem; font-size:.95rem}
      .accordion-button{padding:.8rem 1rem}
    }
    /* === Recent Inspections readability (dark mode) === */
  @media (prefers-color-scheme: dark){
    /* meta labels and values */
    #inspections .accordion-body,
    #inspections .card-lite,
    #inspections .row { color: #fff !important; }

    #inspections strong { 
      color: #fff !important; 
      font-weight: 700;
    }

    /* photo captions */
    #inspections figcaption {
      color: #fff !important;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <!-- ===== Header ===== -->
  <header class="app-header py-2">
    <div class="container d-flex align-items-center justify-content-between gap-2">
      <div class="d-flex align-items-center gap-2">
        <span class="brand-dot" aria-hidden="true"></span>
        <strong class="text-body-emphasis">Palm Coast Fleet</strong>
        <span class="small-muted">/ Vehicle</span>
      </div>

      <!-- KPIs / Quick glance -->
      <div class="nav-kpi">
        {% if reminders and reminders|length > 0 %}
          {% set overdue = reminders|selectattr('status','equalto','overdue')|list|length %}
          {% set dueSoon = reminders|selectattr('status','equalto','due_soon')|list|length %}
          <span class="kpi" aria-label="Maintenance status">
            🔧 {{ overdue }} overdue · {{ reminders|length }} total
          </span>
        {% endif %}
        {% if inventory %}
          <span class="kpi" aria-label="Inventory items">📦 {{ inventory|length }} items</span>
        {% endif %}
      </div>
    </div>

    <!-- Sticky tab bar -->
    <div class="border-top mt-2">
      <div class="container py-2 top-tabs d-flex">
        <a class="btn btn-sm btn-outline-dark" href="#profile">Vehicle</a>
        <a class="btn btn-sm btn-outline-dark" href="#inventory">Inventory</a>
        <a class="btn btn-sm btn-outline-dark" href="#inspections">Inspections</a>
        <a class="btn btn-sm btn-outline-dark" href="#upcoming">Upcoming</a>
        <a class="btn btn-sm btn-outline-dark" href="#history">History</a>
        <a class="btn btn-sm btn-outline-dark" href="#services">Services</a>
      </div>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main id="content" class="container py-3" role="main">
    <!-- Vehicle Summary -->
    <section id="profile" class="card-lite p-3 p-md-4 mb-3" aria-labelledby="veh-title">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <h1 id="veh-title" class="mb-1">Vehicle Profile</h1>
          <p class="lead mb-0">All details, inspections, inventory, and maintenance in one place.</p>
        </div>
        {% set hero = (inspections[0].photo_front if inspections and inspections[0].photo_front else None) %}
        <div class="ms-auto">
          {% if hero %}
            <img src="{{ hero }}" alt="Latest front photo of vehicle" width="360" height="200" style="object-fit:cover; border-radius:12px; border:1px solid rgba(0,0,0,.08)" loading="lazy" decoding="async" />
          {% endif %}
        </div>
      </div>

      <hr class="my-3">

      <div class="row g-3">
        <div class="col-12 col-md-4">
          <div class="p-3 border rounded-3 bg-white h-100">
            <div class="small-muted mb-1">License Plate</div>
            <div class="fw-semibold">{{ vehicle[1] }}</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="p-3 border rounded-3 bg-white h-100">
            <div class="small-muted mb-1">Vehicle Type</div>
            <div class="fw-semibold">{{ vehicle[2] }}</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="p-3 border rounded-3 bg-white h-100">
            <div class="small-muted mb-1">Assigned Technician</div>
            <div class="fw-semibold">{{ vehicle[3] or 'Unassigned' }}</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Accordion -->
    <div class="accordion" id="vehicleAccordion" aria-label="Vehicle sections">

      <!-- Permanent Equipment -->
      <section class="accordion-item">
        <h2 class="accordion-header" id="headingEquipment">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEquipment" aria-expanded="false" aria-controls="collapseEquipment">
            📦 Permanent Equipment
          </button>
        </h2>
        <div id="collapseEquipment" class="accordion-collapse collapse" aria-labelledby="headingEquipment" data-bs-parent="#vehicleAccordion">
          <div class="accordion-body">
            {% if equipment and equipment|length > 0 %}
              <div class="table-responsive">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Item</th>
                      <th scope="col">Status</th>
                      <th scope="col">Last Verified</th>
                      <th scope="col">Notes</th>
                      <th scope="col" class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for item in equipment %}
                    <tr>
                      <td class="fw-semibold">{{ item.item_name }}</td>
                      <td style="min-width:150px">
                        <form class="d-flex align-items-center gap-2" action="{{ url_for('update_single_equipment', vehicle_id=vehicle[0], equipment_id=item.id) }}" method="POST">
                          <label for="status_{{ item.id }}" class="visually-hidden">Status</label>
                          <select id="status_{{ item.id }}" name="status" class="form-select form-select-sm">
                            <option value="Assigned" {% if item.status == 'Assigned' %}selected{% endif %}>Assigned</option>
                            <option value="Missing" {% if item.status == 'Missing' %}selected{% endif %}>Missing</option>
                            <option value="Needs Repair" {% if item.status == 'Needs Repair' %}selected{% endif %}>Needs Repair</option>
                          </select>
                      </td>
                      <td>{{ item.last_verified.strftime('%Y-%m-%d') if item.last_verified else '—' }}</td>
                      <td style="min-width:220px">
                          <label for="notes_{{ item.id }}" class="visually-hidden">Notes</label>
                          <input id="notes_{{ item.id }}" type="text" name="notes" value="{{ item.notes or '' }}" class="form-control form-control-sm" placeholder="Optional notes" />
                      </td>
                      <td class="text-end">
                          <button class="btn btn-sm btn-primary">Save</button>
                          <a href="{{ url_for('delete_equipment', vehicle_id=vehicle[0], equipment_id=item.id) }}"
                             class="btn btn-sm btn-outline-danger ms-1"
                             onclick="return confirm('Remove this tool?')"
                             aria-label="Delete {{ item.item_name }}">🗑️</a>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="small-muted mb-0">No permanent equipment recorded yet.</p>
            {% endif %}

            <hr class="my-3">
            <h3 class="h5 mb-3">Add Custom Tool</h3>
            <form method="POST" action="{{ url_for('add_equipment', vehicle_id=vehicle[0]) }}" class="row g-2" aria-label="Add tool">
              <div class="col-12 col-sm-5 col-md-4">
                <label for="item_name" class="form-label visually-hidden">Item Name</label>
                <input id="item_name" type="text" name="item_name" class="form-control" placeholder="Item Name" required>
              </div>
              <div class="col-6 col-sm-3 col-md-3">
                <label for="status_new" class="form-label visually-hidden">Status</label>
                <select id="status_new" name="status" class="form-select">
                  <option value="Assigned">Assigned</option>
                  <option value="Missing">Missing</option>
                  <option value="Needs Repair">Needs Repair</option>
                </select>
              </div>
              <div class="col-12 col-sm-4 col-md-3">
                <label for="notes_new" class="form-label visually-hidden">Notes</label>
                <input id="notes_new" type="text" name="notes" class="form-control" placeholder="Optional Notes">
              </div>
              <div class="col-6 col-sm-2 col-md-2">
                <button class="btn btn-success w-100">➕ Add</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Truck Inventory -->
      <section class="accordion-item" id="inventory">
        <h2 class="accordion-header" id="headingInventory">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInventory" aria-expanded="true" aria-controls="collapseInventory">
            📦 Truck Inventory
          </button>
        </h2>
        <div id="collapseInventory" class="accordion-collapse collapse show" data-bs-parent="#vehicleAccordion">
          <div class="accordion-body">
            {% if inventory and inventory|length > 0 %}
              <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Product</th>
                      <th scope="col">Quantity</th>
                      <th scope="col">Last Scanned</th>
                      <th scope="col">Expires On</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for item in inventory %}
                    <tr>
                      <td class="fw-semibold">{{ item[0] }}</td>
                      <td>{{ item[1] }}</td>
                      <td>{{ item[2].strftime('%Y-%m-%d') if item[2] else '—' }}</td>
                      <td>{{ item[3].strftime('%Y-%m-%d') if item[3] else '—' }}</td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="small-muted mb-0">This truck currently has no products assigned.</p>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- Inspections -->
      <section class="accordion-item" id="inspections">
        <h2 class="accordion-header" id="headingInspections">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInspections" aria-expanded="false" aria-controls="collapseInspections">
            🧾 Recent Inspections
          </button>
        </h2>
        <div id="collapseInspections" class="accordion-collapse collapse" data-bs-parent="#vehicleAccordion">
          <div class="accordion-body">
            {% if inspections and inspections|length > 0 %}
              {% for i in inspections %}
                <article class="card-lite p-3 mb-3">
                  <div class="row g-2">
                    <div class="col-6 col-md-3"><strong>Date:</strong> {{ i.date.strftime('%Y-%m-%d') }}</div>
                    <div class="col-6 col-md-3"><strong>Mileage:</strong> {{ i.mileage }} mi</div>
                    <div class="col-6 col-md-3"><strong>Cleanliness:</strong> {{ i.cleanliness }}</div>
                    <div class="col-6 col-md-3"><strong>Wrap:</strong> {{ i.wrap_condition }}</div>
                  </div>
                  <div class="photo-gallery mt-3">
                    {% for label, path in [
                      ('Front', i.photo_front), ('Back', i.photo_back), ('Left Side', i.photo_side_left),
                      ('Right Side', i.photo_side_right), ('Tire FL', i.photo_tire_front_left),
                      ('Tire FR', i.photo_tire_front_right), ('Tire RL', i.photo_tire_rear_left),
                      ('Tire RR', i.photo_tire_rear_right)
                    ] %}
                      {% if path %}
                        <figure class="text-center small m-0">
                          <img src="{{ path }}" alt="{{ label }} photo" loading="lazy" decoding="async" width="220" height="110">
                          <figcaption class="mt-1">{{ label }}</figcaption>
                        </figure>
                      {% endif %}
                    {% endfor %}
                  </div>
                </article>
              {% endfor %}
            {% else %}
              <p class="small-muted mb-0">No inspections recorded yet.</p>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- Upcoming Maintenance -->
      <section class="accordion-item" id="upcoming">
        <h2 class="accordion-header" id="headingUpcoming">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUpcoming" aria-expanded="false" aria-controls="collapseUpcoming">
            ⏱ Upcoming Maintenance
          </button>
        </h2>
        <div id="collapseUpcoming" class="accordion-collapse collapse" data-bs-parent="#vehicleAccordion">
          <div class="accordion-body">
            {% if reminders and reminders|length > 0 %}
              <div class="table-responsive">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Service</th>
                      <th scope="col" class="due-wrap">Due at</th>
                      <th scope="col">Current Mileage</th>
                      <th scope="col">Status</th>
                      <th scope="col">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for r in reminders %}
                    {% set miles_remaining = r.miles_remaining if r.miles_remaining is defined else None %}
                    {% set pct = 0 %}
                    <tr>
                      <td class="fw-semibold">{{ r.service_type }}</td>
                      <td>
                        <div class="d-flex align-items-center justify-content-between">
                          <span>{{ r.due_at }} mi</span>
                          {% if miles_remaining is not none and r.due_at > 0 %}
                            {% set pct = (((r.due_at - miles_remaining) / r.due_at) * 100)|round(0, 'floor') %}
                            <span class="small-muted">{{ miles_remaining }} mi left</span>
                          {% endif %}
                        </div>
                        <div class="due-bar mt-1" aria-hidden="true">
                          <span style="width: {{ pct }}%"></span>
                        </div>
                      </td>
                      <td style="min-width: 160px;">
                        <form class="d-flex align-items-center gap-2" action="/mark-maintenance-complete/{{ vehicle[0] }}" method="POST">
                          <input type="hidden" name="service_type" value="{{ r.service_type }}">
                          <label for="odo_{{ loop.index }}" class="visually-hidden">Odometer</label>
                          <input id="odo_{{ loop.index }}" type="number" inputmode="numeric" pattern="[0-9]*" name="odometer" class="form-control form-control-sm" required placeholder="Enter miles">
                      </td>
                      <td>
                        {% if r.status == 'overdue' %}
                          <span class="badge bg-danger">🔴 Overdue</span>
                        {% elif r.status == 'due_soon' %}
                          <span class="badge bg-warning text-dark">⚠ Due in {{ r.miles_remaining }} mi</span>
                        {% else %}
                          <span class="badge bg-success">🟢 OK</span>
                        {% endif %}
                      </td>
                      <td>
                          <button type="submit" class="btn btn-sm btn-outline-primary">✔ Complete</button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="small-muted mb-0">No active reminders yet.</p>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- Maintenance History -->
      <section class="accordion-item" id="history">
        <h2 class="accordion-header" id="headingHistory">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHistory" aria-expanded="false" aria-controls="collapseHistory">
            🛠 Maintenance History
          </button>
        </h2>
        <div id="collapseHistory" class="accordion-collapse collapse" data-bs-parent="#vehicleAccordion">
          <div class="accordion-body">
            {% if maintenance_logs and maintenance_logs|length > 0 %}
              <div class="table-responsive">
                <table class="table table-bordered align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Service Type</th>
                      <th scope="col">Due at Odometer</th>
                      <th scope="col">Logged On</th>
                      <th scope="col">Invoice</th>
                      <th scope="col">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for m in maintenance_logs if m.received_at %}
                    <tr>
                      <td class="fw-semibold">{{ m.service_type }}</td>
                      <td>{{ m.odometer_due }} mi</td>
                      <td>{{ m.received_at.strftime('%Y-%m-%d') }}</td>
                      <td style="min-width: 180px;">
                        {% if m.invoice_url %}
                          <a href="{{ m.invoice_url }}" target="_blank" class="link-primary">📎 View</a>
                        {% else %}
                          <form action="{{ url_for('upload_vehicle_invoice', maintenance_id=m.id) }}" method="POST" enctype="multipart/form-data" class="d-flex gap-1">
                            <label for="inv_{{ m.id }}" class="visually-hidden">Invoice</label>
                            <input id="inv_{{ m.id }}" type="file" name="invoice" accept="application/pdf" class="form-control form-control-sm" required>
                            <button type="submit" class="btn btn-sm btn-secondary">Upload</button>
                          </form>
                        {% endif %}
                      </td>
                      <td><span class="badge bg-success">✅ Completed</span></td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="small-muted mb-0">No maintenance records yet.</p>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- General Services -->
      <section class="accordion-item" id="services">
        <h2 class="accordion-header" id="headingServices">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseServices" aria-expanded="false" aria-controls="collapseServices">
            📋 General Service History + Add New
          </button>
        </h2>
        <div id="collapseServices" class="accordion-collapse collapse" data-bs-parent="#vehicleAccordion">
          <div class="accordion-body">
            {% if vehicle_services and vehicle_services|length > 0 %}
              <div class="table-responsive">
                <table class="table table-striped table-bordered mb-4 align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Date</th>
                      <th scope="col">Service</th>
                      <th scope="col">Odometer</th>
                      <th scope="col">Notes</th>
                      <th scope="col">Invoice</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for svc in vehicle_services %}
                    <tr>
                      <td>{{ svc.logged_on.strftime('%Y-%m-%d') }}</td>
                      <td class="fw-semibold">{{ svc.service_type }}</td>
                      <td>{{ svc.odometer }} mi</td>
                      <td>{{ svc.notes or '' }}</td>
                      <td>{% if svc.invoice_url %}<a href="{{ svc.invoice_url }}" target="_blank" class="link-primary">📎 View</a>{% else %}—{% endif %}</td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="small-muted">No general services logged yet.</p>
            {% endif %}

            <form action="/add-vehicle-service" method="POST" enctype="multipart/form-data" class="card-lite p-3">
              <input type="hidden" name="vehicle_id" value="{{ vehicle[0] }}">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label" for="svc_type">Service Type</label>
                  <input id="svc_type" type="text" name="service_type" class="form-control" required>
                </div>
                <div class="col-12 col-md-3">
                  <label class="form-label" for="svc_odometer">Odometer</label>
                  <input id="svc_odometer" type="number" inputmode="numeric" pattern="[0-9]*" name="odometer" class="form-control" required>
                </div>
                <div class="col-12 col-md-5">
                  <label class="form-label" for="svc_notes">Notes</label>
                  <textarea id="svc_notes" name="notes" class="form-control" rows="1" placeholder="Optional"></textarea>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label" for="svc_invoice">Invoice File (PDF or Image)</label>
                  <input id="svc_invoice" type="file" name="invoice_file" accept="application/pdf,image/*" class="form-control">
                </div>
                <div class="col-12 col-md-6 d-flex align-items-end">
                  <button type="submit" class="btn btn-primary w-100">➕ Add Service</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- ===== Sticky Bottom Actions ===== -->
  <div class="sticky-actions">
    <div class="container py-2 d-flex gap-2 justify-content-between">
      <a href="/vehicles" class="btn btn-outline-secondary w-50" aria-label="Back to vehicles">← Vehicles</a>
      <a href="/vehicle-inspection/{{ vehicle[0] }}" class="btn btn-success w-50" aria-label="Start a new inspection">📝 Start Inspection</a>
    </div>
  </div>

  <!-- ===== Footer ===== -->
  <footer class="container py-4 small-muted">
    <div class="d-flex flex-wrap justify-content-between">
      <div>© {{  now().year  if now else '' }} Palm Coast Pest Control</div>
      <div class="d-flex gap-3">
        <a class="link-secondary" href="#profile">Top</a>
        <a class="link-secondary" href="/support">Support</a>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Header shrink on scroll
    const header = document.querySelector('.app-header');
    let lastY = 0;
    const onScroll = () => {
      const y = window.scrollY || document.documentElement.scrollTop;
      if (y > 60 && y > lastY){ header.classList.add('shrink'); }
      else if (y < 40){ header.classList.remove('shrink'); }
      lastY = y;
    };
    document.addEventListener('scroll', onScroll, {passive:true});

    // Keyboard focus ring once tab is used
    (function(){
      function handleFirstTab(e){
        if (e.key === 'Tab'){
          document.body.classList.add('user-is-tabbing');
          window.removeEventListener('keydown', handleFirstTab);
        }
      }
      window.addEventListener('keydown', handleFirstTab);
    })();
  </script>
</body>
</html>
