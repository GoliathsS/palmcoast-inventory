<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vehicle Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    /* --- Mobile-first polish --- */
    .profile-box {
      background: #fff;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: .75rem;
      padding: 1rem;
      box-shadow: 0 .125rem .5rem rgba(0,0,0,.05);
      margin-bottom: 1rem;
    }

    /* Sticky, swipeable tab bar (great on iPhone) */
    .top-tabs {
      position: sticky;
      top: 0;
      z-index: 1020;
      background: #fff;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .top-tabs .tabs-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      white-space: nowrap;
      padding: .5rem .75rem;
      gap: .5rem;
    }
    .top-tabs .tabs-scroll a {
      display: inline-block;
      margin-right: .5rem;
    }

    /* Photo gallery becomes a tidy grid on phones */
    .photo-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: .75rem;
    }
    .photo-gallery img {
      width: 100%;
      height: 110px;
      object-fit: cover;
      border-radius: .5rem;
      border: 1px solid rgba(0,0,0,.08);
    }

    /* Sticky bottom action bar for easy reach on mobile */
    .sticky-actions {
      position: sticky;
      bottom: 0;
      z-index: 1020;
      background: rgba(255,255,255,.96);
      backdrop-filter: blur(4px);
      border-top: 1px solid rgba(0,0,0,.08);
      padding: .5rem .75rem;
    }

    /* Tighten spacing on small screens */
    @media (max-width: 576px) {
      h3 { font-size: 1.1rem; }
      .accordion-button { padding: .75rem; }
      .table td, .table th { padding: .5rem .5rem; font-size: .95rem; }
      .btn-sm { padding: .35rem .6rem; }
    }
  </style>
</head>
<body class="bg-light">

<!-- TOP NAVIGATION (sticky + swipeable on mobile) -->
<nav class="top-tabs">
  <div class="tabs-scroll d-flex align-items-center">
    <a href="#inventory"   class="btn btn-outline-dark btn-sm">üì¶ Inventory</a>
    <a href="#inspections" class="btn btn-outline-dark btn-sm">üßæ Inspections</a>
    <a href="#upcoming"    class="btn btn-outline-dark btn-sm">‚è± Upcoming</a>
    <a href="#history"     class="btn btn-outline-dark btn-sm">üõ† History</a>
    <a href="#services"    class="btn btn-outline-dark btn-sm">üìã Services</a>
  </div>
</nav>

<div class="container py-3">
  <!-- COLLAPSIBLE ACCORDION -->
  <div class="accordion" id="vehicleAccordion">

    <!-- VEHICLE DETAILS -->
    <div class="profile-box">
      <h3 class="text-success mb-2">üöõ Vehicle Profile</h3>
      <div class="row g-2">
        <div class="col-12 col-sm-4"><strong>License Plate:</strong> {{ vehicle[1] }}</div>
        <div class="col-12 col-sm-4"><strong>Vehicle Type:</strong> {{ vehicle[2] }}</div>
        <div class="col-12 col-sm-4"><strong>Assigned Technician:</strong> {{ vehicle[3] or 'Unassigned' }}</div>
      </div>
    </div>

    <!-- PERMANENT EQUIPMENT -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingEquipment">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEquipment" aria-expanded="false" aria-controls="collapseEquipment">
          üì¶ Permanent Equipment
        </button>
      </h2>
      <div id="collapseEquipment" class="accordion-collapse collapse" aria-labelledby="headingEquipment" data-bs-parent="#vehicleAccordion">
        <div class="accordion-body">

          <form action="{{ url_for('update_equipment', vehicle_id=vehicle.vehicle_id) }}" method="post">
            <div class="table-responsive">
              <table class="table table-bordered align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Item</th>
                    <th>Status</th>
                    <th>Last Verified</th>
                    <th>Notes</th>
                    <th>Delete</th>
                  </tr>
                </thead>
                <tbody>
                {% for item in equipment %}
                  <tr>
                    <td class="fw-semibold">{{ item.item_name }}</td>
                    <td style="min-width:140px;">
                      <select name="status_{{ item.id }}" class="form-select form-select-sm">
                        <option value="Assigned" {% if item.status == 'Assigned' %}selected{% endif %}>Assigned</option>
                        <option value="Missing" {% if item.status == 'Missing' %}selected{% endif %}>Missing</option>
                        <option value="Needs Repair" {% if item.status == 'Needs Repair' %}selected{% endif %}>Needs Repair</option>
                      </select>
                    </td>
                    <td>{{ item.last_verified.strftime('%Y-%m-%d') if item.last_verified else '' }}</td>
                    <td><input type="text" name="notes_{{ item.id }}" value="{{ item.notes or '' }}" class="form-control form-control-sm" placeholder="Optional notes"></td>
                    <td style="min-width:90px;">
                      <form id="deleteForm{{ item.id }}" method="POST" action="{{ url_for('delete_equipment', vehicle_id=vehicle.vehicle_id, equipment_id=item.id) }}" onsubmit="return confirm('Remove this tool?')" class="d-inline">
                        <button class="btn btn-danger btn-sm">üóëÔ∏è</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
            <button type="submit" class="btn btn-sm btn-primary mt-2">üíæ Save Equipment Changes</button>
          </form>

          <hr>
          <h5 class="mb-3">Add Custom Tool</h5>
          <form method="POST" action="{{ url_for('add_equipment', vehicle_id=vehicle.vehicle_id) }}">
            <div class="row g-2">
              <div class="col-12 col-sm-5 col-md-4">
                <input type="text" name="item_name" class="form-control" placeholder="Item Name" required>
              </div>
              <div class="col-6 col-sm-3 col-md-3">
                <select name="status" class="form-select">
                  <option value="Assigned">Assigned</option>
                  <option value="Missing">Missing</option>
                  <option value="Needs Repair">Needs Repair</option>
                </select>
              </div>
              <div class="col-12 col-sm-4 col-md-3">
                <input type="text" name="notes" class="form-control" placeholder="Optional Notes">
              </div>
              <div class="col-6 col-sm-2 col-md-2">
                <button class="btn btn-success w-100">‚ûï Add</button>
              </div>
            </div>
          </form>

        </div>
      </div>
    </div>

    <!-- TRUCK INVENTORY -->
    <div class="accordion-item" id="inventory">
      <h2 class="accordion-header" id="headingInventory">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInventory" aria-expanded="true" aria-controls="collapseInventory">
          üì¶ Truck Inventory
        </button>
      </h2>
      <div id="collapseInventory" class="accordion-collapse collapse show" data-bs-parent="#vehicleAccordion">
        <div class="accordion-body">
          {% if inventory %}
            <div class="table-responsive">
              <table class="table table-bordered table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Last Scanned</th>
                    <th>Expires On</th>
                  </tr>
                </thead>
                <tbody>
                {% for item in inventory %}
                  <tr>
                    <td class="fw-semibold">{{ item[0] }}</td>
                    <td>{{ item[1] }}</td>
                    <td>{{ item[2].strftime('%Y-%m-%d') if item[2] else '‚Äî' }}</td>
                    <td>{{ item[3].strftime('%Y-%m-%d') if item[3] else '‚Äî' }}</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted mb-0">This truck currently has no products assigned.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- INSPECTIONS -->
    <div class="accordion-item" id="inspections">
      <h2 class="accordion-header" id="headingInspections">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInspections">
          üßæ Recent Inspections
        </button>
      </h2>
      <div id="collapseInspections" class="accordion-collapse collapse" data-bs-parent="#vehicleAccordion">
        <div class="accordion-body">
          {% if inspections %}
            {% for i in inspections %}
              <div class="border rounded-3 p-3 mb-4 bg-white">
                <div class="row g-2">
                  <div class="col-6 col-md-3"><strong>Date:</strong> {{ i.date.strftime('%Y-%m-%d') }}</div>
                  <div class="col-6 col-md-3"><strong>Mileage:</strong> {{ i.mileage }} mi</div>
                  <div class="col-6 col-md-3"><strong>Cleanliness:</strong> {{ i.cleanliness }}</div>
                  <div class="col-6 col-md-3"><strong>Wrap:</strong> {{ i.wrap_condition }}</div>
                </div>

                <div class="photo-gallery mt-3">
                  {% for label, path in [
                    ('Front', i.photo_front), ('Back', i.photo_back), ('Left Side', i.photo_side_left),
                    ('Right Side', i.photo_side_right), ('Tire FL', i.photo_tire_front_left),
                    ('Tire FR', i.photo_tire_front_right), ('Tire RL', i.photo_tire_rear_left),
                    ('Tire RR', i.photo_tire_rear_right)
                  ] %}
                    {% if path %}
                      <div class="text-center small">
                        <img src="{{ path }}" alt="{{ label }}" loading="lazy" decoding="async">
                        <div class="mt-1">{{ label }}</div>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p class="mb-0">No inspections recorded yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- UPCOMING MAINTENANCE -->
    <div class="accordion-item" id="upcoming">
      <h2 class="accordion-header" id="headingUpcoming">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUpcoming">
          ‚è± Upcoming Maintenance
        </button>
      </h2>
      <div id="collapseUpcoming" class="accordion-collapse collapse" data-bs-parent="#vehicleAccordion">
        <div class="accordion-body">
          {% if reminders %}
            <div class="table-responsive">
              <table class="table table-bordered align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Service</th>
                    <th>Due at</th>
                    <th>Current Mileage</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                {% for r in reminders %}
                  <!-- use display: contents to keep valid structure while having a form per row -->
                  <form class="d-contents" action="/mark-maintenance-complete/{{ vehicle[0] }}" method="POST">
                    <tr>
                      <td>
                        {{ r.service_type }}
                        <input type="hidden" name="service_type" value="{{ r.service_type }}">
                      </td>
                      <td>{{ r.due_at }} mi</td>
                      <td style="min-width: 150px;">
                        <input type="number" inputmode="numeric" pattern="[0-9]*"
                               name="odometer" class="form-control form-control-sm" required
                               placeholder="Enter miles">
                      </td>
                      <td>
                        {% if r.status == 'overdue' %}
                          <span class="badge bg-danger">üî¥ Overdue</span>
                        {% elif r.status.startswith('due_soon') %}
                          <span class="badge bg-warning text-dark">‚ö† Due in {{ r.miles_remaining }} mi</span>
                        {% else %}
                          <span class="badge bg-success">üü¢ OK</span>
                        {% endif %}
                      </td>
                      <td><button type="submit" class="btn btn-sm btn-outline-primary">‚úî Complete</button></td>
                    </tr>
                  </form>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="mb-0">No active reminders yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- MAINTENANCE HISTORY -->
    <div class="accordion-item" id="history">
      <h2 class="accordion-header" id="headingHistory">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHistory">
          üõ† Maintenance History
        </button>
      </h2>
      <div id="collapseHistory" class="accordion-collapse collapse" data-bs-parent="#vehicleAccordion">
        <div class="accordion-body">
          {% if maintenance_logs %}
            <div class="table-responsive">
              <table class="table table-bordered align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Service Type</th>
                    <th>Due at Odometer</th>
                    <th>Logged On</th>
                    <th>Invoice</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                {% for m in maintenance_logs if m.received_at %}
                  <tr>
                    <td class="fw-semibold">{{ m.service_type }}</td>
                    <td>{{ m.odometer_due }} mi</td>
                    <td>{{ m.received_at.strftime('%Y-%m-%d') }}</td>
                    <td style="min-width: 160px;">
                      {% if m.invoice_url %}
                        <a href="{{ m.invoice_url }}" target="_blank">üìé View</a>
                      {% else %}
                        <form action="{{ url_for('upload_vehicle_invoice', maintenance_id=m.id) }}" method="POST" enctype="multipart/form-data" class="d-flex gap-1">
                          <input type="file" name="invoice" accept="application/pdf" class="form-control form-control-sm" required>
                          <button type="submit" class="btn btn-sm btn-secondary">Upload</button>
                        </form>
                      {% endif %}
                    </td>
                    <td><span class="badge bg-success">‚úÖ Completed</span></td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="mb-0">No maintenance records available yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- GENERAL SERVICE HISTORY & FORM -->
    <div class="accordion-item" id="services">
      <h2 class="accordion-header" id="headingServices">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseServices">
          üìã General Service History + Add New
        </button>
      </h2>
      <div id="collapseServices" class="accordion-collapse collapse" data-bs-parent="#vehicleAccordion">
        <div class="accordion-body">
          {% if vehicle_services %}
            <div class="table-responsive">
              <table class="table table-striped table-bordered mb-4 align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Date</th>
                    <th>Service</th>
                    <th>Odometer</th>
                    <th>Notes</th>
                    <th>Invoice</th>
                  </tr>
                </thead>
                <tbody>
                {% for svc in vehicle_services %}
                  <tr>
                    <td>{{ svc.logged_on.strftime('%Y-%m-%d') }}</td>
                    <td class="fw-semibold">{{ svc.service_type }}</td>
                    <td>{{ svc.odometer }} mi</td>
                    <td>{{ svc.notes or '' }}</td>
                    <td>{% if svc.invoice_url %}<a href="{{ svc.invoice_url }}" target="_blank">üìé View</a>{% else %}‚Äî{% endif %}</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="mb-3">No general services logged yet.</p>
          {% endif %}

          <form action="/add-vehicle-service" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="vehicle_id" value="{{ vehicle[0] }}">
            <div class="mb-3">
              <label class="form-label">Service Type</label>
              <input type="text" name="service_type" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Odometer</label>
              <input type="number" inputmode="numeric" pattern="[0-9]*" name="odometer" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Notes</label>
              <textarea name="notes" class="form-control" rows="3" placeholder="Optional"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Invoice File (PDF or Image)</label>
              <input type="file" name="invoice_file" accept="application/pdf,image/*" class="form-control">
            </div>
            <button type="submit" class="btn btn-primary">‚ûï Add Service</button>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- BOTTOM ACTIONS (sticky on mobile) -->
<div class="sticky-actions">
  <div class="container d-flex gap-2 justify-content-between">
    <a href="/vehicles" class="btn btn-outline-secondary w-50">‚Üê Vehicles</a>
    <a href="/vehicle-inspection/{{ vehicle[0] }}" class="btn btn-primary w-50">üìù Start Inspection</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
