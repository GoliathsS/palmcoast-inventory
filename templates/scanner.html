<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scan Product | Palm Coast Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#14532d">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/palm_icon_180.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="/static/palm_icon_192.png" />
  <link rel="stylesheet" href="/static/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --pc-bg:#f6f7fb; --pc-card:#fff; --pc-border:#e6e7ec;
      --pc-text:#0b1220; --pc-muted:#667085; --pc-green:#14532d;
      --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
      --radius:14px; --shadow:0 8px 24px rgba(17,24,39,.06), 0 2px 6px rgba(17,24,39,.04);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--pc-bg);color:var(--pc-text);
         font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}

    header{
      position:sticky; top:0; z-index:10; background:#fff;
      border-bottom:1px solid var(--pc-border);
      padding:.75rem .75rem; text-align:center;
    }
    header .brand{display:flex; flex-direction:column; align-items:center; gap:.25rem}
    header img{height:40px;border-radius:8px}
    header h1{margin:0; font-size:1.15rem; letter-spacing:.2px}

    .wrap{max-width:720px; margin:16px auto; padding:0 14px}
    .card{background:var(--pc-card); border:1px solid var(--pc-border); border-radius:var(--radius);
          box-shadow:var(--shadow); padding:16px;}

    .row{display:grid; gap:.75rem}
    @media (min-width:640px){ .row{ grid-template-columns: 1fr 1fr } }

    label{display:block; font-size:.9rem; color:var(--pc-muted); margin-bottom:.4rem}

    select,button,input[type=range]{
      width:100%; padding:12px; font-size:1rem; border-radius:10px; border:1px solid var(--pc-border);
      background:#fff; outline:none;
    }
    select:focus, button:focus, input[type=range]:focus{ box-shadow:0 0 0 3px rgba(20,83,45,.15) }

    .btn-primary{ background:var(--pc-green); color:#fff; border:none; font-weight:700 }
    .btn-ghost{ background:#f2f4f8; border:1px solid var(--pc-border); color:#111; font-weight:600 }
    .btn-danger{ background:#fee2e2; border:1px solid #fca5a5; color:#b91c1c }

    .controls{ display:grid; gap:.8rem; margin-top:.5rem }
    .controls .row-btns{ display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:.6rem } /* +1 for Low-light */

    .seg-wrap{display:grid; gap:.5rem}
    .hint{font-size:.85rem; color:var(--pc-muted)}

    #scanner-container{ display:none; position:relative; margin-top:.75rem }
    #scanner-container video{
      width:100%; height:auto; border-radius:16px; display:block;
      box-shadow:0 0 12px rgba(0,0,0,.08);
    }

    .overlay{ pointer-events:none; position:absolute; inset:0; display:grid; place-items:center; }
    .frame{
      width:72%; max-width:460px; aspect-ratio: 1.6 / 1;
      border:3px solid rgba(255,255,255,.9); border-radius:12px;
      box-shadow:0 0 0 9999px rgba(0,0,0,.22) inset; position:relative;
    }
    .scanline{
      position:absolute; left:4%; right:4%; height:2px; background:rgba(56,189,248,.92);
      box-shadow:0 0 12px rgba(56,189,248,.7); border-radius:2px; animation:slide 2.2s linear infinite;
    }
    @keyframes slide{ 0%{ top:10% } 50%{ top:50% } 100%{ top:90% } }

    #status{ margin:.75rem 0 .25rem; text-align:center; font-weight:800 }
    .success{ color:var(--ok) } .error{ color:var(--err) } .warning{ color:var(--warn) }

    .toggle-log{ width:100%; background:#f2f4f8; border:1px solid var(--pc-border); color:#111; font-weight:600 }
    .log{ background:#f9fafb; border:1px solid var(--pc-border); border-radius:12px; padding:12px; margin-top:.6rem }
    .log h3{ margin:.2rem 0 .5rem; font-size:1rem }
    .log ul{ margin:0; padding-left:1.1rem; font-size:.95rem }
    .hidden{ display:none }

    .footer-link{
      display:inline-block; margin:18px auto 24px; background:var(--pc-green); color:#fff;
      padding:12px 20px; border-radius:10px; font-weight:700; text-decoration:none;
    }

    .toast-stack{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; z-index:2000; display:grid; gap:8px;
      width:min(92vw,520px); pointer-events:none;
    }
    .toast{
      pointer-events:auto; display:flex; align-items:center; gap:.6rem;
      background:#111; color:#fff; padding:10px 12px; border-radius:12px;
      box-shadow:0 10px 20px rgba(0,0,0,.2); animation:toast-in .18s ease-out;
    }
    .toast.success{ background: var(--pc-green); }
    .toast.error{ background:#b91c1c; }
    .toast .msg{ font-weight:700 }
    .toast .sub{ font-size:.85rem; opacity:.9 }
    @keyframes toast-in{ from{ transform:translateY(8px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="/static/LOGO.jpg" alt="Palm Coast Pest Control Logo" />
      <h1>Scan Product</h1>
    </div>
  </header>

  <div class="wrap">
    <div class="card" role="region" aria-label="Scan controls">
      <!-- Direction + Technician -->
      <div class="row">
        <div class="seg-wrap">
          <label for="direction">Direction</label>
          <select id="direction" aria-label="Scan direction">
            <option value="in">Scan In</option>
            <option value="out">Scan Out</option>
          </select>
        </div>

        <div>
          <label for="technician">Technician</label>
          <select id="technician" name="technician" aria-label="Technician">
            <option value="">-- Select Technician --</option>
            {% for tech in technicians %}
              <option value="{{ tech.id }}">{{ tech.name }}</option>
            {% endfor %}
          </select>
          <div class="hint" id="tech-hint">
            For <strong>Scan Out</strong>, a technician is required. For <strong>Scan In</strong>, it’s optional.
          </div>
        </div>
      </div>

      <!-- Camera/device & actions -->
      <div class="controls">
        <div class="row">
          <div>
            <label for="cameraSelect">Camera</label>
            <select id="cameraSelect" aria-label="Camera device">
              <option value="">Default Camera</option>
            </select>
          </div>

          <div class="row-btns" aria-label="Scanner actions">
            <button id="start-btn" class="btn-primary" type="button">Start</button>
            <button id="pause-btn" class="btn-ghost" type="button" disabled>Pause</button>
            <button id="torch-btn" class="btn-ghost" type="button" disabled>Flash</button>
            <button id="lowlight-btn" class="btn-ghost" type="button" disabled>Low-light</button>
          </div>
        </div>

        <!-- Zoom control (only shown if supported) -->
        <div id="zoom-wrap" class="row hidden">
          <div>
            <label for="zoom">Zoom</label>
            <input id="zoom" type="range" min="1" max="1" step="0.01" />
          </div>
        </div>

        <div id="scanner-container">
          <video id="preview" playsinline autoplay muted></video>
          <div class="overlay" aria-hidden="true">
            <div class="frame"><div class="scanline"></div></div>
          </div>
          <!-- Hidden ROI canvas for decoding -->
          <canvas id="roi" width="640" height="360" style="display:none"></canvas>
        </div>
      </div>

      <p id="status" class=""></p>

      <button class="toggle-log" type="button" id="toggleLog">Checkout List</button>
      <div id="log-panel" class="log hidden">
        <h3>Scanned Items</h3>
        <ul id="scanned-items"></ul>
      </div>
    </div>

    <div style="text-align:center">
      <a href="/" class="footer-link">← Back to Dashboard</a>
    </div>
  </div>

  <div id="toasts" class="toast-stack" aria-live="polite" aria-atomic="true"></div>
  <audio id="beep" src="/static/beep.mp3" preload="auto"></audio>

  <script type="module">
    // === Polyfills / helpers ===
    if (!HTMLVideoElement.prototype.requestVideoFrameCallback) {
      HTMLVideoElement.prototype.requestVideoFrameCallback = function (cb) {
        let last = performance.now();
        return setTimeout(() => {
          const now = performance.now();
          cb(now, { mediaTime: (this.currentTime || 0) });
        }, 50);
      };
    }

    // Import ZXing (browser-friendly bundle)
    import {
      BrowserMultiFormatReader,
      DecodeHintType,
      BarcodeFormat
    } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/+esm";

    // --- Toast helper ---
    function toast(message, {sub=null, variant='success', ttl=2600} = {}){
      const stack = document.getElementById('toasts');
      const el = document.createElement('div');
      el.className = `toast ${variant}`;
      el.innerHTML = `<span>${variant==='success'?'✅':'❌'}</span>
                      <div><div class="msg">${message}</div>${sub?`<div class="sub">${sub}</div>`:''}</div>`;
      stack.appendChild(el);
      while (stack.children.length > 3) stack.firstElementChild.remove();
      setTimeout(() => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(8px)';
        setTimeout(() => el.remove(), 300);
      }, ttl);
    }

    // --- DOM refs ---
    const statusEl   = document.getElementById("status");
    const directionEl= document.getElementById("direction");
    const techEl     = document.getElementById("technician");
    const camSelect  = document.getElementById("cameraSelect");

    const startBtn   = document.getElementById("start-btn");
    const pauseBtn   = document.getElementById("pause-btn");
    const torchBtn   = document.getElementById("torch-btn");
    const lowlightBtn= document.getElementById("lowlight-btn");
    const toggleLogBtn = document.getElementById("toggleLog");

    const container  = document.getElementById("scanner-container");
    const video      = document.getElementById("preview");
    const list       = document.getElementById("scanned-items");
    const beep       = document.getElementById("beep");
    const logPanel   = document.getElementById("log-panel");
    const zoomWrap   = document.getElementById("zoom-wrap");
    const zoomInput  = document.getElementById("zoom");
    const roiCanvas  = document.getElementById("roi");
    const roiCtx     = roiCanvas.getContext("2d", { willReadFrequently: true });

    // --- ZXing with hints ---
    const reader = new BrowserMultiFormatReader();
    const hints = new Map();
    hints.set(DecodeHintType.POSSIBLE_FORMATS, [
      BarcodeFormat.EAN_13, BarcodeFormat.UPC_A, BarcodeFormat.CODE_128, BarcodeFormat.CODE_39
    ]);
    hints.set(DecodeHintType.TRY_HARDER, true);
    reader.setHints(hints);

    // --- State ---
    let stream = null;
    let active = false;
    let lastBarcode = "";
    let lastTime = 0;
    let currentTrack = null;
    let torchOn = false;
    let lowLight = false;
    let caps = {};
    let settings = {};
    let rafId = null;

    // stability gate
    let lastCandidate = null;
    let lastCandidateAt = 0;

    const SCAN_COOLDOWN_MS = 1500;
    const CONFIRM_WINDOW_MS = 600;

    function setStatus(msg, cls=""){
      statusEl.textContent = msg || "";
      statusEl.className = cls;
    }

    function updateTechHint(){
      const isOut = directionEl.value === "out";
      const hint = document.getElementById("tech-hint");
      hint.innerHTML = isOut
        ? 'For <strong>Scan Out</strong>, a technician is <strong>required</strong>.'
        : 'For <strong>Scan In</strong>, selecting a technician is <strong>optional</strong>.';
    }
    updateTechHint();
    directionEl.addEventListener("change", updateTechHint);

    toggleLogBtn.addEventListener("click", () => logPanel.classList.toggle("hidden"));

    async function listCameras(){
      try{
        // Some browsers require a prior getUserMedia to reveal labels
        const devices = await navigator.mediaDevices.enumerateDevices();
        const vids = devices.filter(d => d.kind === "videoinput");
        camSelect.innerHTML = '<option value="">Default Camera</option>';
        vids.forEach((v, i) => {
          const opt = document.createElement("option");
          opt.value = v.deviceId || "";
          opt.textContent = v.label || `Camera ${i+1}`;
          camSelect.appendChild(opt);
        });
      }catch(e){ /* ignore */ }
    }

    async function startCamera(){
      const constraints = {
        audio:false,
        video:{
          deviceId: camSelect.value || undefined,
          facingMode: camSelect.value ? undefined : { ideal: "environment" },
          width: { ideal: 1280 },
          height: { ideal: 720 },
          frameRate: { ideal: 30, max: 60 }
        }
      };

      // get stream
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;

      // Safari sometimes needs a tiny await before play()
      await Promise.resolve();
      await video.play().catch(()=>{});

      currentTrack = stream.getVideoTracks()[0];
      caps = (currentTrack && currentTrack.getCapabilities) ? currentTrack.getCapabilities() : {};
      settings = (currentTrack && currentTrack.getSettings) ? currentTrack.getSettings() : {};

      // Torch availability
      torchBtn.disabled = !caps || !('torch' in caps);
      torchBtn.textContent = "Flash";

      // Low-light button enabled if we can change frameRate or torch
      lowlightBtn.disabled = !(('torch' in (caps||{})) || ('frameRate' in (caps||{})));
      lowlightBtn.textContent = "Low-light";

      // Zoom support
      if (caps && 'zoom' in caps) {
        zoomWrap.classList.remove("hidden");
        zoomInput.min  = caps.zoom.min ?? 1;
        zoomInput.max  = caps.zoom.max ?? 1;
        zoomInput.step = caps.zoom.step ?? 0.01;
        zoomInput.value= settings.zoom ?? zoomInput.min;
      } else {
        zoomWrap.classList.add("hidden");
      }

      container.style.display = "block";
    }

    async function stopCamera(){
      if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
      if (stream){
        try { stream.getTracks().forEach(t => t.stop()); } catch {}
        stream = null;
        currentTrack = null;
      }
      container.style.display = "none";
      torchOn = false;
      lowLight = false;
      torchBtn.textContent = "Flash";
      torchBtn.disabled = true;
      lowlightBtn.textContent = "Low-light";
      lowlightBtn.disabled = true;
    }

    async function toggleTorch(){
      try{
        if (!currentTrack || !caps || !('torch' in caps)) return;
        torchOn = !torchOn;
        await currentTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
        settings = currentTrack.getSettings?.() || settings;
        torchBtn.textContent = torchOn ? "Flash: On" : "Flash";
      }catch(e){
        torchBtn.disabled = true;
      }
    }

    async function setLowLightMode(on){
      if (!currentTrack) return;
      lowLight = on;
      const adv = [];
      // lower framerate to allow more exposure
      adv.push({ frameRate: on ? 15 : 30 });
      if (caps && 'torch' in caps) adv.push({ torch: on || torchOn });
      try { await currentTrack.applyConstraints({ advanced: adv }); } catch {}
      lowlightBtn.textContent = on ? "Low-light: On" : "Low-light";
    }

    zoomInput?.addEventListener("input", async (e) => {
      if (!currentTrack || !caps || !('zoom' in caps)) return;
      try{
        await currentTrack.applyConstraints({ advanced: [{ zoom: Number(e.target.value) }] });
        settings = currentTrack.getSettings?.() || settings;
      }catch(err){}
    });

    async function sendScan(barcode, direction, technician){
      try{
        const res = await fetch("/scan-action",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ barcode, direction, technician })
        });
        const data = await res.json().catch(() => ({}));
        const name = data.product_name || data.name || "";

        if (data.status === "success"){
          setStatus(`✓ ${name ? name + " • " : ""}${barcode} ${direction} successful`, "success");
          const verb = direction === 'out' ? 'Checked out' : 'Checked in';
          toast(verb, { sub: name ? `${name} • ${barcode}` : barcode, variant:'success' });
        } else if (data.status === "not_enough_units"){
          setStatus(`Not enough units for ${barcode}`, "warning");
          toast("Not enough units", { sub: barcode, variant:'error' });
        } else if (data.status === "not_found"){
          setStatus(`Product ${barcode} not found`, "error");
          toast("Not found", { sub: barcode, variant:'error' });
        } else {
          setStatus(`Error processing ${barcode}`, "error");
          toast("Error", { sub: barcode, variant:'error' });
        }
      }catch(e){
        setStatus(`Network error`, "error");
        toast("Network error", { variant:'error' });
      }
    }

    // ROI draw
    function drawROI() {
      const vw = video.videoWidth, vh = video.videoHeight;
      if (!vw || !vh) return false;
      const sw = Math.floor(vw * 0.6), sh = Math.floor(vh * 0.6);
      const sx = Math.floor((vw - sw) / 2), sy = Math.floor((vh - sh) / 2);
      roiCanvas.width = sw; roiCanvas.height = sh;
      roiCtx.drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);
      return true;
    }

    // Decode loop (safe fallback to setTimeout if rVFC polyfilled)
    function decodeLoop() {
      if (!active) return;

      const tick = async () => {
        try {
          if (video.readyState >= 2 && drawROI()) {
            try {
              const result = await reader.decodeFromCanvas(roiCanvas);
              const text = result?.text || result?.getText?.() || "";
              if (text) {
                const now = performance.now();
                if (text === lastCandidate && (now - lastCandidateAt) < CONFIRM_WINDOW_MS) {
                  const direction = directionEl.value;
                  const technician = techEl.value;

                  if (direction === "out" && !technician){
                    setStatus("Technician required for Scan Out.", "warning");
                  } else {
                    if (!(text === lastBarcode && (now - lastTime) < SCAN_COOLDOWN_MS)) {
                      lastBarcode = text; lastTime = now;
                      beep?.play().catch(()=>{});
                      const li = document.createElement("li");
                      const t = new Date().toLocaleTimeString();
                      li.textContent = `${t} — ${text} (${direction}${technician?` • tech:${technician}`:''})`;
                      list.appendChild(li);
                      await sendScan(text, direction, technician);
                    }
                  }
                  lastCandidate = null;
                } else {
                  lastCandidate = text;
                  lastCandidateAt = now;
                }
              }
            } catch (_) { /* no code this frame */ }
          }
        } catch (_) { /* ignore */ }

        // schedule next
        video.requestVideoFrameCallback(() => decodeLoop());
      };

      // Start one tick immediately
      tick();
    }

    startBtn.addEventListener("click", async () => {
      try{
        startBtn.disabled = true;
        setStatus("Starting camera…");
        await listCameras();                  // safe even if empty labels
        await startCamera();                  // may prompt for permission
        active = true;
        pauseBtn.disabled = false;
        setStatus("Fill the box and hold 6–10 inches away");
        decodeLoop();
      }catch(e){
        console.error(e);
        setStatus(`${e?.message || "Camera access failed"}`, "error");
        toast("Camera error", { sub: e?.message || "Unable to start", variant: 'error' });
        startBtn.disabled = false;           // re-enable if failed
      }
    });

    pauseBtn.addEventListener("click", async () => {
      if (!active){
        active = true;
        pauseBtn.textContent = "Pause";
        setStatus("Resumed");
        decodeLoop();
      } else {
        active = false;
        pauseBtn.textContent = "Resume";
        setStatus("Paused");
      }
    });

    torchBtn.addEventListener("click", toggleTorch);
    lowlightBtn.addEventListener("click", () => setLowLightMode(!lowLight));

    camSelect.addEventListener("change", async () => {
      const wasActive = active;
      active = false;
      await stopCamera();
      try{
        await startCamera();
        if (wasActive){
          active = true;
          decodeLoop();
        }
      }catch(e){
        setStatus("Failed to switch camera", "error");
        toast("Camera switch failed", { variant: 'error' });
      }
    });

    // Cleanup on page unload
    window.addEventListener("beforeunload", stopCamera);
  </script>

    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/static/service-worker.js').catch(()=>{});
      }
    </script>
  </body>
  </html>
