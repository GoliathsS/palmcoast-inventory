<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Palm Coast ‚Ä¢ Tech Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="color-scheme" content="light" />
  <style>
    :root{
      --page:#f7f7f9; --card:#ffffff; --border:#e6e7eb; --text:#0b1220; --muted:#6b7280;
      --brand:#0ea5e9; --brand-2:#10b981; --good:#16a34a;
      --shadow:0 8px 24px rgba(17,24,39,.08), 0 2px 6px rgba(17,24,39,.06);
      --radius:16px; --ring:0 0 0 4px rgba(14,165,233,.15); --header-h:64px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;
      background:var(--page);color:var(--text);
      display:flex;flex-direction:column;
      -webkit-tap-highlight-color:rgba(0,0,0,0);
      padding-top:env(safe-area-inset-top);
    }

    /* Header */
    header{
      position:sticky;top:0;z-index:10;
      background:rgba(255,255,255,.8);
      backdrop-filter:saturate(1.2) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .bar{max-width:min(1100px,94vw);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:16px 0;min-height:var(--header-h)}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px}
    .brand img{height:22px;width:auto;display:block}

    .meta{display:flex;align-items:center;gap:12px;color:var(--muted);font-size:.95rem;flex-wrap:wrap;row-gap:6px;word-break:break-word}
    .logout{color:#2563eb;text-decoration:none;border:1px solid #dbe4ff;padding:8px 12px;border-radius:12px;min-height:44px;display:inline-flex;align-items:center}
    .logout:hover{background:#eef2ff}

    /* Layout */
    .wrap{width:min(1100px,94vw);margin:20px auto 40px;flex:1;display:grid;gap:18px}

    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    .subpanel{
      background:#fff;
      border:1px dashed var(--border);
      border-radius:12px;
      padding:12px;
    }

    h2{margin:0 0 12px;font-size:1.2rem;letter-spacing:-.01em}
    .subtle{color:var(--muted)}

    .tiles{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .tile{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      text-decoration:none;color:inherit;
      background:linear-gradient(180deg,#fff,#fafafa);
      border:1px solid var(--border);border-radius:14px;
      padding:18px;min-height:140px;
      transition:transform .12s ease, box-shadow .15s ease, border-color .15s ease
    }
    .tile:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(16,24,40,.06);border-color:#d6d9df}
    .tile h3{margin:0 0 6px;font-size:1.1rem}
    .tile p{margin:0;color:var(--muted);font-size:.95rem}

    .cta{margin-top:6px;display:inline-block;font-weight:700;letter-spacing:.3px;font-size:.9rem;color:white;background:linear-gradient(90deg,var(--brand),var(--brand-2));padding:9px 12px;border-radius:10px;box-shadow:0 8px 20px rgba(16,185,129,.18)}

    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid #cdebd8;color:#065f46;background:#ecfdf5;border-radius:999px;font-size:.88rem}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good)}

    .footer{color:var(--muted);font-size:.9rem;text-align:center;padding:24px 0 34px}

    /* Utility */
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid var(--border);background:#fff;border-radius:10px;
      padding:8px 12px;text-decoration:none;color:#111;font-weight:600;min-height:44px;cursor:pointer
    }
    .btn:hover{box-shadow:var(--shadow)}
    .btn[disabled], .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff;border:none}
    .btn-danger{border-color:#fecaca;background:#fee2e2}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem}
    .badge-ok{background:#dcfce7;color:#065f46}
    .badge-warn{background:#fef3c7;color:#92400e}
    .badge-crit{background:#fee2e2;color:#991b1b}
    .list{list-style:none;padding:0;margin:0}
    .list li{border-top:1px dashed #e5e7eb;padding:10px 0}
    .list li:first-child{border-top:none}

    /* Accessibility */
    a:focus-visible, .tile:focus-visible, .logout:focus-visible, .btn:focus-visible{outline:none;box-shadow:var(--ring)}
    #rinseTimer[aria-live]{outline:0}

    /* Motion preference */
    @media (prefers-reduced-motion: reduce){
      .tile{transition:none}
      .tile:hover{transform:none;box-shadow:var(--shadow)}
    }

    /* Mobile polish */
    @media (max-width: 720px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .tiles { grid-template-columns: 1fr; gap: 12px; }
      .tile { min-height: 120px; padding: 16px; }
      .panel, .tile {
        background: rgba(255,255,255,.8);
        backdrop-filter: saturate(1.1) blur(10px);
        -webkit-backdrop-filter: saturate(1.1) blur(10px);
        box-shadow: 0 6px 16px rgba(17,24,39,.06), 0 1px 3px rgba(17,24,39,.06);
      }
      .bar { padding: 12px 0; }
      :root { --header-h: 56px; }
      .tile p, .subtle { font-size: clamp(14px, 3.4vw, 15px); }
    }

    /* Anchor offset for sticky header */
    #emergency { scroll-margin-top: calc(var(--header-h) + 18px); }

    @supports (padding-top: constant(safe-area-inset-top)) {
      body { padding-top: constant(safe-area-inset-top); }
    }
  </style>
</head>
<body>
  {% set is_admin = current_user.is_authenticated and current_user.role == 'ADMIN' %}
  {% set is_tech  = current_user.is_authenticated and current_user.role == 'TECH' %}

  <header>
    <div class="bar">
      <div class="brand" aria-label="Palm Coast Tech Portal">
        <!-- <img src="{{ url_for('static', filename='LOGO.jpg') }}" alt="Palm Coast" /> -->
        Palm Coast ‚Ä¢ Tech Portal
      </div>
      <div class="meta">
        {% if current_user.is_authenticated %}{{ current_user.email }}{% endif %}
        ‚Ä¢
        <a class="logout" href="{{ url_for('logout') }}">Sign out</a>
      </div>
    </div>
  </header>

  <div class="wrap">

    <!-- Quick actions / tiles -->
    <section class="panel" role="region" aria-label="Quick actions">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:10px">
        <h2>Welcome{% if current_user.is_authenticated %}, {{ current_user.email.split('@')[0] | capitalize }}{% endif %}</h2>
        {% if vehicle_id %}
          <span class="pill"><span class="dot"></span> Vehicle assigned</span>
        {% else %}
          <span class="pill" style="opacity:.8;border-color:#e5e7eb;background:#f9fafb;color:#6b7280"><span class="dot" style="background:#9ca3af"></span> No vehicle assigned</span>
        {% endif %}
      </div>

      <div class="tiles">
        <!-- SDS -->
        <a href="{{ url_for('sds_portal') }}" class="tile" aria-label="Open Safety Data Sheets and Labels">
          <div>
            <h3>SDS &amp; Labels</h3>
            <p>Quick access to product safety docs &amp; labels.</p>
            <span class="cta">Open</span>
          </div>
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 3h7l4 4v14a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z" stroke="#60a5fa" stroke-width="1.5"/>
            <path d="M14 3v4h4" stroke="#93c5fd" stroke-width="1.5"/>
            <path d="M8 12h8M8 16h8M8 8h4" stroke="#bae6fd" stroke-width="1.5"/>
          </svg>
        </a>

        <!-- My Vehicle -->
        {% if vehicle_id %}
        <a href="{{ url_for('vehicle_profile', vehicle_id=vehicle_id) }}" class="tile" aria-label="Open My Vehicle Profile">
          <div>
            <h3>My Vehicle</h3>
            <p>Inventory, inspections, reminders &amp; services.</p>
            <span class="cta">Open</span>
          </div>
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 13h15l3 3v3H3v-6z" stroke="#34d399" stroke-width="1.5"/>
            <circle cx="7" cy="19" r="2" stroke="#a7f3d0" stroke-width="1.5"/>
            <circle cx="17" cy="19" r="2" stroke="#a7f3d0" stroke-width="1.5"/>
            <path d="M6 13l2-5h8l2 5" stroke="#10b981" stroke-width="1.5"/>
          </svg>
        </a>
        {% else %}
        <div class="tile" aria-label="No vehicle assigned">
          <div>
            <h3>My Vehicle</h3>
            <p>No vehicle assigned yet. Contact your manager.</p>
            <span class="cta" style="opacity:.55;pointer-events:none">Unavailable</span>
          </div>
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" aria-hidden="true" opacity=".45">
            <path d="M3 13h15l3 3v3H3v-6z" stroke="#94a3b8" stroke-width="1.5"/>
            <circle cx="7" cy="19" r="2" stroke="#cbd5e1" stroke-width="1.5"/>
            <circle cx="17" cy="19" r="2" stroke="#cbd5e1" stroke-width="1.5"/>
            <path d="M6 13l2-5h8l2 5" stroke="#94a3b8" stroke-width="1.5"/>
          </svg>
        </div>
        {% endif %}

        <!-- Emergency (global) -->
        <a href="#emergency" class="tile" aria-label="Emergency info">
          <div>
            <h3>Emergency</h3>
            <p>Spill procedures, poison control, nearest hospitals.</p>
            <span class="cta">Open</span>
          </div>
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <circle cx="12" cy="12" r="9" stroke="#fb7185" stroke-width="1.5"/>
            <path d="M12 7v6M12 16.5v.5" stroke="#fecaca" stroke-width="1.5"/>
          </svg>
        </a>
      </div>
    </section>

    <!-- Main grid -->
    <section class="grid grid-2">
      <!-- Left Column -->
      <div class="grid" style="gap:18px">
        <!-- Notifications -->
        <div class="panel" role="region" aria-label="Notifications">
          <h2>Notifications</h2>
          {% if notifications %}
            <ul class="list">
              {% for n in notifications %}
              <li class="row" style="justify-content:space-between;align-items:flex-start">
                <div>
                  <div style="font-weight:700">
                    {% if n.severity == 'critical' %}
                      <span class="badge badge-crit">Critical</span>
                    {% elif n.severity == 'high' %}
                      <span class="badge badge-warn">High</span>
                    {% else %}
                      <span class="badge badge-ok">Normal</span>
                    {% endif %}
                    {{ n.title }}
                  </div>
                  {% if n.body %}<div class="subtle" style="margin-top:4px">{{ n.body }}</div>{% endif %}
                  {% if n.due_at %}<div class="subtle" style="margin-top:4px">Due: {{ n.due_at.strftime('%Y-%m-%d') }}</div>{% endif %}
                </div>
                <div>
                  {% if not n.is_read %}
                  <form method="POST" action="{{ url_for('ack_notification', nid=n.id) }}">
                    <button class="btn" type="submit">Mark Read</button>
                  </form>
                  {% else %}
                  <span class="badge badge-ok">Done</span>
                  {% endif %}
                </div>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="subtle">No notifications.</div>
          {% endif %}
        </div>

        <!-- Pre-Inspection Checklist -->
        <div class="panel" role="region" aria-label="Pre-Inspection Checklist">
          <h2>Pre-Inspection Checklist</h2>
          <form method="POST" action="{{ url_for('checklist_add') }}" class="row" style="gap:10px;margin-top:6px;margin-bottom:10px">
            <input class="btn" style="flex:1;text-align:left" type="text" name="label" placeholder="Add item (e.g., Wash vehicle)" required autocomplete="off">
            <input class="btn" style="width:200px" type="date" name="due_at">
            <button class="btn btn-primary" type="submit">Add</button>
          </form>

          {% if checklist %}
            <ul class="list">
              {% for c in checklist %}
              <li class="row" style="justify-content:space-between;align-items:center">
                <div class="row" style="align-items:center;gap:10px">
                  <form method="POST" action="{{ url_for('checklist_toggle', item_id=c.id) }}">
                    <button class="btn" title="Toggle" aria-label="Toggle" type="submit">{{ '‚òë' if c.is_done else '‚òê' }}</button>
                  </form>
                  <div>
                    <div{% if c.is_done %} class="subtle" style="text-decoration:line-through"{% endif %}>
                      {{ c.label }}
                    </div>
                    {% if c.due_at %}<div class="subtle">Due {{ c.due_at.strftime('%Y-%m-%d') }}</div>{% endif %}
                  </div>
                </div>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="subtle">No checklist items yet.</div>
          {% endif %}
        </div>
      </div>

      <!-- Right Column -->
      <div class="grid" style="gap:18px">

        <!-- Sales & Commissions (Personal Ledger) -->
        <div class="panel" role="region" aria-label="Sales & Commissions">
          <h2>Sales &amp; Commissions</h2>

          <!-- Filters + Summary -->
          <form method="GET" action="{{ url_for('tech_home') }}" class="row" style="gap:10px;align-items:center;margin-bottom:10px">
            <input class="btn" type="month" name="m" value="{{ selected_month or '' }}" style="width:180px" aria-label="Month">
            <button class="btn" type="submit">Apply</button>
            <a class="btn" href="{{ url_for('commission_export_csv', m=selected_month) }}">Export CSV</a>
            <div class="row" style="gap:8px;margin-left:auto">
              <span class="pill" title="Month-to-date booked sales">
                üíµ MTD Sales: <strong>${{ '{:,.2f}'.format(comm_summary.mtd_sales or 0) }}</strong>
              </span>
              <span class="pill" title="Calculated commission for this month">
                ‚úÖ MTD Commission: <strong>${{ '{:,.2f}'.format(comm_summary.mtd_commission or 0) }}</strong>
              </span>
              <span class="pill" title="Commission for entries not marked paid">
                ‚è≥ Unpaid: <strong>${{ '{:,.2f}'.format(comm_summary.unpaid_commission or 0) }}</strong>
              </span>
              <span class="pill" title="Year-to-date commission you marked paid">
                üßæ YTD Paid: <strong>${{ '{:,.2f}'.format(comm_summary.ytd_commission_paid or 0) }}</strong>
              </span>
            </div>
          </form>

          <!-- Add a sale (Initial Price + Source included) -->
          <form method="POST" action="{{ url_for('commission_new') }}" enctype="multipart/form-data" class="grid" style="gap:10px;margin-bottom:12px">
            <!-- Date + Customer -->
            <div class="row" style="gap:10px">
              <input class="btn" type="date" name="sold_on" value="{{ current_date or '' }}" style="width:170px" />
              <input class="btn" type="text" name="customer_name" placeholder="Customer name" autocomplete="off" required style="flex:1" />
            </div>

            <!-- Payment + account/address -->
            <div class="row" style="gap:10px">
              <select class="btn" name="payment_method" required style="width:180px" aria-label="Paid via">
                <option value="" disabled selected>Paid via‚Ä¶</option>
                <option value="cc">CC</option>
                <option value="check">Check</option>
              </select>
              <input class="btn" type="text" name="account_number" placeholder="Account Number" autocomplete="off" style="width:200px" />
              <input class="btn" type="text" name="street_address" placeholder="Street Address" autocomplete="off" style="flex:1" />
            </div>

            <!-- Service + Initial + Ongoing + Frequency + Source + Estimator -->
            <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap">
              {% if service_options %}
                <select class="btn" name="service_type" required style="flex:1;min-width:220px">
                  {% for s in service_options %}
                    <option value="{{ s.code }}">{{ s.label }}</option>
                  {% endfor %}
                </select>
              {% else %}
                <input class="btn" type="text" name="service_type" placeholder="Service Sold (e.g., Quarterly Pest)" required style="flex:1;min-width:220px" />
              {% endif %}

              <input class="btn" type="number" step="0.01" min="0" name="initial_amount" id="comm_initial" placeholder="Initial Price ($)" style="width:170px" />
              <input class="btn" type="number" step="0.01" min="0" name="amount" id="comm_amount" placeholder="Ongoing Price ($)" required style="width:170px" />

              <select class="btn" name="frequency" required style="width:180px">
                <option value="" disabled selected>Frequency‚Ä¶</option>
                <option>One-time</option>
                <option>Monthly</option>
                <option>Bi-Monthly</option>
                <option>Quarterly</option>
                <option>Semi-Annual</option>
                <option>Annual</option>
              </select>

              <input class="btn" type="text" name="source" list="sourceOptions" placeholder="Source (e.g., Referral)" autocomplete="off" style="width:200px" />
              <datalist id="sourceOptions">
                <option value="Door-to-door"></option>
                <option value="Web"></option>
                <option value="Referral"></option>
                <option value="Inbound call"></option>
                <option value="Technician upsell"></option>
                <option value="Flyer/Ad"></option>
                <option value="Other"></option>
              </datalist>

              <div class="btn" id="comm_preview" aria-live="polite" style="min-width:260px">
                Est. Commission ({{ default_commission_rate or 10 }}%): $0.00
              </div>
            </div>

            <textarea class="btn" name="notes" rows="2" placeholder="Notes (lead source details, scope, etc.)"></textarea>

            <div class="row" style="gap:10px;align-items:center">
              <input class="btn" type="file" name="attachment" accept=".pdf,image/*" style="flex:1" />
              <button class="btn btn-primary" type="submit">Add Sale</button>
            </div>
          </form>

          <!-- Recent entries (selected month) -->
          {% if comm_entries %}
            <ul class="list">
              {% for c in comm_entries %}
              <li class="row" style="justify-content:space-between;align-items:flex-start">
                <div>
                  <div style="font-weight:700">
                    {{ c.sold_on.strftime('%Y-%m-%d') }} ¬∑ {{ c.service_type }}
                    <span class="subtle">‚Äî {{ c.customer_name }}</span>
                  </div>
                  <div class="subtle">
                    {% if c.initial_amount and c.initial_amount > 0 %}
                      Initial: ${{ '{:,.2f}'.format(c.initial_amount) }} ¬∑
                    {% endif %}
                    Ongoing: ${{ '{:,.2f}'.format(c.amount) }} ¬∑
                    Freq: {{ c.frequency or '‚Äî' }} ¬∑
                    Paid via: {{ 'CC' if c.payment_method == 'cc' else ('Check' if c.payment_method == 'check' else '‚Äî') }}
                    {% if c.source %} ¬∑ Source: {{ c.source }}{% endif %}
                  </div>
                  <div class="subtle">
                    Commission ({{ default_commission_rate or 10 }}%):
                    <strong>${{ '{:,.2f}'.format(c.commission_amount) }}</strong>
                  </div>
                  {% if c.account_number or c.street_address %}
                    <div class="subtle">
                      {% if c.account_number %}Acct #: {{ c.account_number }}{% endif %}
                      {% if c.account_number and c.street_address %} ¬∑ {% endif %}
                      {% if c.street_address %}{{ c.street_address }}{% endif %}
                    </div>
                  {% endif %}
                  {% if c.notes %}
                    <div class="subtle" style="max-width:560px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">{{ c.notes }}</div>
                  {% endif %}
                </div>
                <div class="row" style="gap:8px;align-items:center">
                  {% if c.paid %}
                    <span class="badge badge-ok">Paid</span>
                  {% else %}
                    <span class="badge badge-warn">Unpaid</span>
                  {% endif %}

                  <form method="POST" action="{{ url_for('commission_toggle_paid', entry_id=c.id) }}">
                    <button class="btn" type="submit">{{ 'Mark Unpaid' if c.paid else 'Mark Paid' }}</button>
                  </form>

                  {% if c.attachment_id %}
                    <a class="btn" href="{{ url_for('commission_media_proxy', att_id=c.attachment_id) }}" target="_blank" rel="noopener noreferrer">Attachment</a>
                  {% endif %}

                  <form method="POST" action="{{ url_for('commission_delete', entry_id=c.id) }}" onsubmit="return confirm('Delete this entry? This will also delete the attachment.');">
                    <button class="btn" type="submit">Delete</button>
                  </form>
                </div>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="subtle">No entries for this month.</div>
          {% endif %}
        </div>

        <!-- Technician Requests -->
        <div class="panel" role="region" aria-label="Technician Requests">
          <h2>Technician Requests</h2>
          <form method="POST" action="{{ url_for('tech_request_new') }}" class="grid" style="gap:10px;margin-bottom:10px">
            <select class="btn" name="request_type" aria-label="Request type">
              <option value="new_chemical">Request to Try New Chemical</option>
              <option value="equipment">Request Equipment / Something Needed</option>
              <option value="other">Other</option>
            </select>
            <textarea class="btn" name="description" rows="2" placeholder="Describe what you need‚Ä¶" required></textarea>
            <button class="btn btn-primary" type="submit">Submit Request</button>
          </form>

          {% if requests_rows %}
            <ul class="list">
              {% for r in requests_rows %}
              <li class="row" style="justify-content:space-between;align-items:center">
                <div>
                  <div style="font-weight:700;text-transform:capitalize">
                    {{ r.request_type.replace('_',' ') }}
                    {% if r.tech_name %}<span class="subtle">¬∑ {{ r.tech_name }}</span>{% endif %}
                  </div>
                  <div class="subtle">{{ r.description }}</div>
                  {% if r.created_at %}<div class="subtle">Opened {{ r.created_at.strftime('%Y-%m-%d') }}</div>{% endif %}
                </div>
                <div>
                  {% if r.status == 'open' %}
                    {% if is_admin %}
                      <form method="POST" action="{{ url_for('tech_request_close', req_id=r.id) }}">
                        <button class="btn" type="submit">Close</button>
                      </form>
                    {% else %}
                      <span class="badge badge-warn">Open</span>
                    {% endif %}
                  {% else %}
                    <span class="badge badge-ok">Closed</span>
                  {% endif %}
                </div>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="subtle">No requests yet.</div>
          {% endif %}
        </div>

        <!-- CEU & Training Records -->
        <div class="panel" role="region" aria-label="CEU & Training">
          <h2>CEU &amp; Training Records</h2>
          {% if training %}
            <ul class="list">
              {% for t in training %}
              <li class="row" style="justify-content:space-between;align-items:center">
                <div>
                  <a href="{{ t.url }}" target="_blank" rel="noopener noreferrer" style="font-weight:700;text-decoration:none">{{ t.title }}</a>
                  {% if t.ceu_hours %}<span class="subtle"> ¬∑ {{ t.ceu_hours }} CEU</span>{% endif %}
                  {% if t.expires_on %}<div class="subtle">Expires {{ t.expires_on.strftime('%Y-%m-%d') }}</div>{% endif %}
                </div>
                <a class="btn" href="{{ t.url }}" target="_blank" rel="noopener noreferrer">Open</a>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="subtle">No records available.</div>
          {% endif %}
        </div>

        <!-- Field Bug Photos -->
        <div class="panel" role="region" aria-label="Field Bug Photos">
          <h2>Field Bug Photos</h2>
          <form method="POST" action="{{ url_for('bug_report_upload') }}" enctype="multipart/form-data" class="grid" style="gap:10px;margin-bottom:12px">
            <div class="row" style="gap:10px; align-items:center">
              <input class="btn" type="file" id="photosInput" name="photos" accept="image/*" capture="environment" multiple required style="flex:1" />
            </div>

            <div class="row" style="gap:10px">
              <input class="btn" type="text" name="suspected_pest" placeholder="Suspected pest (optional)" autocomplete="off" style="flex:1" />
              <button type="button" id="btnAttachLocation" class="btn" title="Attach GPS">üìç Add Location</button>
            </div>

            <textarea class="btn" name="notes" rows="2" placeholder="Notes (where found, behavior, host plant, etc.)"></textarea>

            <!-- hidden geolocation fields -->
            <input type="hidden" id="bug_lat" name="lat" />
            <input type="hidden" id="bug_lng" name="lng" />

            <div id="photoPreview" class="row" style="gap:8px"></div>

            <div class="row" style="gap:10px">
              <button class="btn btn-primary" type="submit">Upload</button>
              <div class="subtle">Max 5 photos ¬∑ JPG/PNG ¬∑ Originals stored securely</div>
            </div>
          </form>

          {% if bug_reports %}
            <h3 style="margin:6px 0 8px;font-size:1.05rem">Recent submissions</h3>
            <ul class="list">
              {% for br in bug_reports %}
                <li class="row" style="justify-content:space-between;align-items:center">
                  <div class="row" style="gap:10px;align-items:center">
                    {% if br.photo_id %}
                      <img src="{{ url_for('bug_media_proxy', photo_id=br.photo_id) }}" alt="Bug photo" style="width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid var(--border)" loading="lazy" referrerpolicy="no-referrer">
                    {% endif %}
                    <div>
                      <div style="font-weight:700">{{ br.suspected_pest or 'Unspecified' }}</div>
                      <div class="subtle">{{ br.created_at.strftime('%Y-%m-%d %H:%M') }} ¬∑ {{ br.status|capitalize }}</div>
                      {% if br.notes %}<div class="subtle" style="max-width:520px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">{{ br.notes }}</div>{% endif %}
                    </div>
                  </div>
                  {% if br.lat and br.lng %}
                    <a class="btn" target="_blank" rel="noopener noreferrer"
                       href="https://maps.google.com/?q={{ br.lat }},{{ br.lng }}">Map</a>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="subtle">No submissions yet.</div>
          {% endif %}
        </div>

        <!-- Emergency -->
        <div id="emergency" class="panel" role="region" aria-label="Emergency">
          <h2>Emergency</h2>
          <div class="subtle" style="margin-bottom:12px">
            One-tap help, live directions, and quick procedures.
          </div>

          <!-- Panic actions -->
          <div class="row" style="gap:10px; margin-bottom:12px">
            <a href="tel:911" class="btn btn-danger" style="flex:1; font-weight:800">üö® Call 911</a>
            <a href="tel:18002221222" class="btn btn-danger" style="flex:1">‚ò†Ô∏è Poison Control</a>
            {% if office_phone %}
              <a href="tel:{{ office_phone }}" class="btn" style="flex:1">üè¢ Office {{ office_phone }}</a>
            {% endif %}
          </div>

          <!-- Location-aware actions -->
          <div class="row" style="gap:10px; margin-bottom:14px">
            <a id="btnNearestER" class="btn" style="flex:1" target="_blank" rel="noopener noreferrer">üß≠ Open Nearest ER</a>
            <a id="btnShareSMS" class="btn" style="flex:1">üìç Share My Location (SMS)</a>
          </div>

          <!-- Quick procedures -->
          <div class="grid" style="gap:12px">
            <details class="subpanel">
              <summary style="font-weight:700; cursor:pointer">Chemical Spill ‚Äî Immediate Steps</summary>
              <ol class="subtle" style="margin-top:8px">
                <li>Isolate area; keep people away. Ventilate if safe.</li>
                <li>Wear PPE; avoid contact. Stop leak if you can safely.</li>
                <li>Contain with absorbent. Prevent entry to drains/water.</li>
                <li>Use product SDS for cleanup/disposal specifics.</li>
                <li>Report to office/supervisor and complete incident log.</li>
              </ol>
              <div class="row" style="gap:8px; margin-top:8px">
                <a class="btn" href="{{ url_for('sds_portal') }}">Open SDS Portal</a>
                {% if admin_emergency_url %}<a class="btn" href="{{ admin_emergency_url }}">Manage Procedures</a>{% endif %}
              </div>
            </details>

            <details class="subpanel">
              <summary style="font-weight:700; cursor:pointer">Exposure / Eye Contact</summary>
              <ol class="subtle" style="margin-top:8px">
                <li>Remove contaminated clothing; rinse skin with water.</li>
                <li><strong>Eyes:</strong> Use eyewash, rinse continuously for 15 minutes.</li>
                <li>Call Poison Control; seek medical attention as needed.</li>
                <li>Bring product label/SDS to healthcare provider.</li>
              </ol>
              <!-- Eye-wash timer -->
              <div style="margin-top:10px">
                <div class="subtle">Eye-Rinse Timer</div>
                <div id="rinseTimer" aria-live="polite" style="font-size:1.6rem;font-weight:800;letter-spacing:.5px">15:00</div>
                <div class="row" style="gap:8px; margin-top:6px">
                  <button id="startRinse" type="button" class="btn">Start 15:00</button>
                  <button id="resetRinse" type="button" class="btn">Reset</button>
                </div>
              </div>
            </details>

            <details class="subpanel">
              <summary style="font-weight:700; cursor:pointer">Vehicle Accident</summary>
              <ol class="subtle" style="margin-top:8px">
                <li>Move to safety; call 911 for injuries.</li>
                <li>Exchange info; take photos; notify office.</li>
                <li>Do not admit fault; wait for instructions.</li>
              </ol>
              <div class="row" style="gap:8px; margin-top:8px">
                {% if incident_url %}<a class="btn" href="{{ incident_url }}">Start Incident Report</a>{% endif %}
                {% if office_phone %}<a class="btn" href="tel:{{ office_phone }}">Call Office</a>{% endif %}
              </div>
            </details>
          </div>

          <!-- Contacts -->
          <div style="margin-top:12px">
            <h3 style="margin:0 0 8px; font-size:1.05rem">Key Contacts</h3>
            {% if emergency %}
              <ul class="list">
                {% for e in emergency %}
                  <li>
                    <div style="font-weight:700; text-transform:uppercase">{{ e.kind }}</div>
                    <div>
                      {{ e.name }}
                      {% if e.phone %} ¬∑ <a href="tel:{{ e.phone }}">{{ e.phone }}</a>{% endif %}
                    </div>
                    {% if e.notes %}<div class="subtle">{{ e.notes }}</div>{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="subtle">No emergency contacts configured.</div>
            {% endif %}
            {% if admin_emergency_url %}
              <div class="row" style="gap:8px; margin-top:8px">
                <a class="btn" href="{{ admin_emergency_url }}">Manage Contacts</a>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Vehicle Inspection & Maintenance Status -->
        <div class="panel" role="region" aria-label="Vehicle Inspection & Maintenance Status">
          <h2>Vehicle Inspection &amp; Maintenance Status</h2>
          {% if vehicles %}
            <ul class="list">
              {% for v in vehicles %}
              <li class="row" style="justify-content:space-between;align-items:flex-start">
                <div>
                  <div style="font-weight:700">{{ v.license_plate }} <span class="subtle">({{ v.vehicle_type }})</span></div>
                  {% set rows = maint_by_vehicle.get(v.vehicle_id, []) %}
                  {% if rows %}
                    <ul class="list" style="margin-top:6px">
                      {% for r in rows %}
                      <li style="padding:4px 0;border-top:none">
                        {{ r.service_type }} ‚Äî due at {{ r.due_at }} mi
                        {% if r.status == 'overdue' %}
                          <span class="badge badge-crit">Overdue</span>
                        {% elif r.status == 'due_soon' %}
                          <span class="badge badge-warn">Due Soon</span>
                        {% else %}
                          <span class="badge badge-ok">OK</span>
                        {% endif %}
                      </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <div class="subtle">No reminders on file.</div>
                  {% endif %}
                </div>
                <a class="btn" href="/vehicles/{{ v.vehicle_id }}">Open</a>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="subtle">No vehicles assigned.</div>
          {% endif %}
        </div>
      </div>
    </section>
  </div>

  <div class="footer">¬© {{ current_year or '' }} Palm Coast ‚Ä¢ All rights reserved</div>

  <!-- Emergency helpers -->
  <script>
    // --- Detect platform (Apple Maps support) ---
    const isApple = /iPad|iPhone|Mac/i.test(navigator.userAgent);

    // --- Nearest ER + Share Location buttons ---
    const erBtn = document.getElementById('btnNearestER');
    const smsBtn = document.getElementById('btnShareSMS');

    // Fallback links if location blocked
    const fallbackER = isApple
      ? 'maps://?q=Emergency%20Room'
      : 'https://www.google.com/maps/search/?api=1&query=Emergency%20Room%20near%20me';

    const officeSms = '{{ office_sms or "" }}'; // e.g., +15615551212 (E.164)
    const smsBase   = officeSms ? ('sms:' + officeSms) : 'sms:';

    function setFallbacks(){
      if (erBtn && !erBtn.getAttribute('href')) erBtn.setAttribute('href', fallbackER);
      if (smsBtn && !smsBtn.getAttribute('href')) smsBtn.setAttribute('href', smsBase);
    }

    function setWithLocation(lat, lng){
      // ER directions (Apple Maps vs Google Maps)
      const mapsLink = isApple
        ? `maps://?q=Emergency%20Room&ll=${lat},${lng}`
        : `https://www.google.com/maps/dir/?api=1&origin=${lat},${lng}&destination=Emergency%20Room`;
      if (erBtn) erBtn.setAttribute('href', mapsLink);

      // SMS with live location + map link
      const body = encodeURIComponent(`EMERGENCY: My location is https://maps.google.com/?q=${lat},${lng}`);
      const smsLink = `${smsBase}${smsBase.includes('?') ? '&' : '?'}body=${body}`;
      if (smsBtn) smsBtn.setAttribute('href', smsLink);
    }

    // Initialize with safe fallbacks first
    setFallbacks();

    // Try geolocation
    try {
      if ('geolocation' in navigator){
        navigator.geolocation.getCurrentPosition(
          pos => {
            const { latitude, longitude } = pos.coords || {};
            if (latitude && longitude) setWithLocation(latitude.toFixed(6), longitude.toFixed(6));
          },
          () => { /* keep fallbacks */ },
          { enableHighAccuracy: true, timeout: 5000, maximumAge: 15000 }
        );
      }
    } catch { /* keep fallbacks */ }

    // --- Eye-rinse 15:00 timer ---
    (function(){
      const display = document.getElementById('rinseTimer');
      const start   = document.getElementById('startRinse');
      const reset   = document.getElementById('resetRinse');

      let remaining = 15 * 60; // seconds
      let tid = null;

      function render(){
        const m = Math.floor(remaining / 60);
        const s = remaining % 60;
        if (display) display.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      }

      function tick(){
        if (remaining > 0){
          remaining--;
          render();
        } else {
          clearInterval(tid);
          tid = null;
          try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const o = ctx.createOscillator(); const g = ctx.createGain();
            o.connect(g); g.connect(ctx.destination);
            o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.05;
            o.start(); setTimeout(()=>{ o.stop(); ctx.close(); }, 400);
          } catch {}
        }
      }

      if (start){
        start.addEventListener('click', () => {
          if (tid) return;
          if (remaining <= 0) remaining = 15 * 60;
          render();
          tid = setInterval(tick, 1000);
        });
      }
      if (reset){
        reset.addEventListener('click', () => {
          clearInterval(tid); tid = null; remaining = 15 * 60; render();
        });
      }
      render();
    })();
  </script>

  <!-- Bug photo previews + geolocation -->
  <script>
    (() => {
      const MAX_FILES = 5;
      const previews = document.getElementById('photoPreview');
      const input = document.getElementById('photosInput');
      const btnLoc = document.getElementById('btnAttachLocation');
      const latEl = document.getElementById('bug_lat');
      const lngEl = document.getElementById('bug_lng');

      if (input){
        input.addEventListener('change', () => {
          previews.innerHTML = '';
          const raw = Array.from(input.files || []);
          const files = raw.slice(0, MAX_FILES);

          if (raw.length > MAX_FILES){
            alert(`Please select up to ${MAX_FILES} photos.`);
            const dt = new DataTransfer();
            files.forEach(f => dt.items.add(f));
            input.files = dt.files;
          }

          files.forEach(file => {
            if (!file.type.startsWith('image/')) return;
            const img = document.createElement('img');
            img.alt = 'Preview';
            img.style.cssText = 'width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid var(--border)';
            const reader = new FileReader();
            reader.onload = e => img.src = e.target.result;
            reader.readAsDataURL(file);
            previews.appendChild(img);
          });
        });
      }

      if (btnLoc){
        btnLoc.addEventListener('click', () => {
          if (!navigator.geolocation) return alert('Geolocation not available.');
          navigator.geolocation.getCurrentPosition(
            pos => {
              const { latitude, longitude } = pos.coords || {};
              if (latitude && longitude){
                latEl.value = latitude.toFixed(6);
                lngEl.value = longitude.toFixed(6);
                btnLoc.textContent = 'üìç Location Attached';
                btnLoc.disabled = true;
              }
            },
            () => alert('Unable to get location. Check permissions.'),
            { enableHighAccuracy: true, timeout: 6000, maximumAge: 15000 }
          );
        });
      }
    })();
  </script>

  <!-- Commission estimator (Initial + Ongoing, using default rate) -->
  <script>
  (function(){
    const recur = document.getElementById('comm_amount'); // ongoing price
    const init  = document.querySelector("input[name='initial_amount']") || document.getElementById('comm_initial');
    const rate  = document.getElementById('comm_rate');
    const freq  = document.querySelector("select[name='frequency']");
    const out   = document.getElementById('comm_preview');

    const CYCLES = { one_time:1, monthly:12, bi_monthly:6, quarterly:4, semi_annual:2, annual:1 };
    const num = v => parseFloat(v) || 0;
    const fmt = n => n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

    function render(){
      const f = (freq?.value || 'monthly').toLowerCase();
      const cycles = CYCLES[f] ?? 12;
      const recurringCycles = Math.max(cycles - 1, 0);

      const i = num(init?.value);
      const a = num(recur?.value);
      const r = num(rate?.value);

      const base = i + (a * recurringCycles);
      const comm = base * (r/100);

      if(out) out.textContent =
        `Est. Commission (${r.toFixed(1)}%): $${fmt(comm)} ‚Äî base $${fmt(base)} (Init $${fmt(i)} + ${recurringCycles}√ó$${fmt(a)})`;
    }
    [recur, init, rate].forEach(el => el?.addEventListener('input', render));
    freq?.addEventListener('change', render);
    render();
  })();
  </script>
</body>
</html>
