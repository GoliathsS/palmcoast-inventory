<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SDS & Labels ¬∑ Palm Coast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>

  <style>
    /* ‚Äî‚Äî‚Äî Visual polish tuned for Palm Coast ‚Äî‚Äî‚Äî */
    :root{
      /* Safeguard tokens in case globals are missing */
      --primary: #14532d;        /* Palm Coast green */
      --primary-ink: #ffffff;
      --surface-0: #0b1220;      /* dark ink (used for text if you run dark mode) */
      --surface-1: #ffffff;      /* card/page */
      --surface-2: #f8fafc;      /* subtle bg */
      --border: #e6e7ec;
      --text-1: #0b1220;
      --text-2: #6c7280;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --radius: 14px;
    }

    body{ background:var(--surface-2); color:var(--text-1) }

    .container{ max-width:1100px; margin:0 auto; padding: 12px 16px 48px; }

    /* Header with logo, title and coverage meter */
    .header-wrap{ position:sticky; top:0; z-index:10; backdrop-filter: blur(8px); background:color-mix(in oklab, var(--surface-2), transparent 12%); border-bottom:1px solid var(--border); }
    .header{ display:flex; align-items:center; gap:12px; padding:12px 16px; }
    .logo{ width:36px; height:36px; border-radius:8px; object-fit:cover; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .title{ margin:0; line-height:1.2; font-size:1.25rem; color:var(--primary) }
    .sub{ margin:2px 0 0; color:var(--text-2); font-size:.95rem }

    .kpis{ display:flex; gap:.5rem; flex-wrap:wrap; padding:0 16px 12px }
    .chip{ display:inline-flex; align-items:center; gap:.45rem; padding:.4rem .65rem; border-radius:999px; background:var(--surface-1); color:var(--text-1); border:1px solid var(--border); font-weight:600; box-shadow:0 1px 6px rgba(0,0,0,.04) }

    .coverage{ padding:0 16px 14px }
    .meter{ height:10px; background:#eef2f6; border:1px solid var(--border); border-radius:999px; overflow:hidden }
    .meter > i{ display:block; height:100%; background:linear-gradient(90deg, var(--primary), #0ea5e9); }
    .meter-label{ display:flex; justify-content:space-between; font-size:.85rem; color:var(--text-2); margin:6px 2px 0 }

    /* Toolbar */
    .toolbar{ display:grid; gap:.6rem; grid-template-columns: 1fr; padding:14px 16px; }
    @media(min-width:820px){ .toolbar{ grid-template-columns: 1fr auto auto auto; align-items:center } }

    .search{ position:relative; }
    .search input{ padding:10px 12px 10px 40px; border-radius:10px; border:1px solid var(--border); background:var(--surface-1); outline:none; width:100%; font-weight:600 }
    .search .icon{ position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:.55; }

    .filters{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .filters .select, .filters .check, .filters .chipbtn{ display:flex; align-items:center; gap:.45rem; background:var(--surface-1); border:1px solid var(--border); padding:8px 10px; border-radius:10px; font-weight:600; color:var(--text-1) }
    .filters .select select{ border:none; background:transparent; font-weight:600; color:inherit; outline:none }
    .filters .chipbtn{ cursor:pointer; user-select:none }
    .filters .chipbtn[aria-pressed="true"]{ outline:2px solid color-mix(in oklab, var(--primary), #000 10%); background: color-mix(in oklab, var(--primary), #fff 88%); }

    .btn.primary{ display:inline-flex; align-items:center; gap:.5rem; padding:.6rem .85rem; border-radius:10px; background:var(--primary); color:#fff; border:1px solid color-mix(in oklab, var(--primary), #000 12%); text-decoration:none; font-weight:700 }

    /* Grid and cards */
    .grid{ display:grid; gap:14px; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); padding:0 16px }
    .card{ background:var(--surface-1); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:0 2px 12px rgba(0,0,0,.05); display:flex; flex-direction:column; gap:.55rem; position:relative }
    .card h3{ margin:0; font-size:1.05rem; color:var(--text-1) }
    .meta{ color:var(--text-2); font-size:.95rem }
    .badges{ display:flex; gap:.4rem; flex-wrap:wrap; margin-top:.25rem }
    .badge{ display:inline-flex; align-items:center; gap:.35rem; font-size:.82rem; font-weight:700; padding:.35rem .55rem; border-radius:999px; border:1px solid var(--border); background:var(--surface-2) }
    .badge.ok{ background:color-mix(in oklab, var(--success), #fff 85%); color:#065f46; border-color:color-mix(in oklab, var(--success), #000 14%) }
    .badge.warn{ background:color-mix(in oklab, var(--warning), #fff 86%); color:#92400e; border-color:color-mix(in oklab, var(--warning), #000 14%) }
    .badge.danger{ background:color-mix(in oklab, var(--danger), #fff 86%); color:#7f1d1d; border-color:color-mix(in oklab, var(--danger), #000 14%) }

    .links{ display:flex; flex-wrap:wrap; gap:.45rem; margin-top:.25rem }
    .links a{ text-decoration:none; border:1px solid var(--border); padding:.5rem .66rem; border-radius:10px; background:var(--surface-1); color:var(--text-1); font-weight:700; transition: transform .12s ease, box-shadow .12s ease }
    .links a:hover{ transform: translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.08) }

    .empty{ text-align:center; color:var(--text-2); padding:28px 12px; border:1px dashed var(--border); border-radius:12px; background:var(--surface-1); margin:12px 16px 0 }

    .helper{ color:var(--text-2); font-size:.85rem; padding:10px 16px }
  </style>
</head>
<body>
  <div class="header-wrap">
    <div class="header container">
      <img src="{{ url_for('static', filename='LOGO.jpg') }}" alt="Palm Coast" class="logo" loading="lazy"/>
      <div>
        <h2 class="title">SDS & Label Portal</h2>
        <p class="sub">Fast access to safety docs for field techs. Type <kbd>/</kbd> to search. Press <kbd>Esc</kbd> to clear.</p>
      </div>
    </div>

    {# ---- Counters: support new keys and legacy URL fields ---- #}
    {% set counts = namespace(total=0, sds=0, label=0, barcode=0) %}
    {% for p in products %}
      {% set counts.total = counts.total + 1 %}
      {% set sds_val = (p.sds_key if p.sds_key is defined else (p.sds_url if p.sds_url is defined else None)) %}
      {% set label_val = (p.label_key if p.label_key is defined else (p.label_url if p.label_url is defined else None)) %}
      {% set barcode_val = (p.barcode_key if p.barcode_key is defined else (p.barcode_img_url if p.barcode_img_url is defined else None)) %}
      {% if sds_val %}{% set counts.sds = counts.sds + 1 %}{% endif %}
      {% if label_val %}{% set counts.label = counts.label + 1 %}{% endif %}
      {% if barcode_val %}{% set counts.barcode = counts.barcode + 1 %}{% endif %}
    {% endfor %}

    <div class="kpis container">
      <span class="chip">üì¶ {{ counts.total }} products</span>
      <span class="chip">üìÑ SDS: {{ counts.sds }}</span>
      <span class="chip">üßæ Labels: {{ counts.label }}</span>
      <span class="chip">üß∑ Barcodes: {{ counts.barcode }}</span>
    </div>

    {% set pct = ( (counts.sds / counts.total) * 100 ) if counts.total else 0 %}
    <div class="coverage container" aria-label="SDS coverage meter">
      <div class="meter" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ pct|round(0, 'floor') }}">
        <i style="width:{{ '%.0f' % pct }}%"></i>
      </div>
      <div class="meter-label"><span>SDS coverage</span><strong>{{ '%.0f' % pct }}%</strong></div>
    </div>
  </div>

  <div class="container">
    <!-- Controls -->
    <section class="toolbar" role="region" aria-label="Filters and actions">
      <div class="search">
        <span class="icon">üîé</span>
        <input id="q" type="search" placeholder="Search by product name or EPA number‚Ä¶" aria-label="Search products" autocomplete="off">
      </div>

      <div class="filters" role="group" aria-label="Document filters">
        <label class="check"><input type="checkbox" id="f-sds"> Has SDS</label>
        <label class="check"><input type="checkbox" id="f-label"> Has Label</label>
        <label class="check"><input type="checkbox" id="f-barcode"> Has Barcode</label>
      </div>

      <div class="filters" role="group" aria-label="Status and sort">
        <div class="select">
          <span>Status:</span>
          <select id="f-status" aria-label="SDS status">
            <option value="all" selected>All</option>
            <option value="valid">Valid</option>
            <option value="expired">Expired</option>
            <option value="unknown">Unknown</option>
          </select>
        </div>
        <div class="select">
          <span>Sort:</span>
          <select id="f-sort" aria-label="Sort order">
            <option value="name">A ‚Üí Z</option>
            <option value="updated">Recently Updated</option>
            <option value="status">Status (Missing first)</option>
          </select>
        </div>
      </div>

      <div class="filters" role="group" aria-label="Categories">
        <button class="chipbtn" data-cat="Pest" aria-pressed="false">ü™≥ Pest</button>
        <button class="chipbtn" data-cat="Lawn" aria-pressed="false">üåø Lawn</button>
        <button class="chipbtn" data-cat="Wildlife" aria-pressed="false">ü¶ù Wildlife</button>
      </div>

      <div class="filters">
        <a href="/edit-sds" class="btn primary">üõ† Manage SDS Library</a>
      </div>
    </section>

    <!-- Grid -->
    <section id="grid" class="grid" aria-live="polite">
      {% for p in products %}
        {# Support both row types: objects and tuples #}
        {% set pid = (p.id if p.id is defined else p[0]) %}
        {% set name = (p.name if p.name is defined else p[1]) %}
        {% set epa  = (p.epa_number if p.epa_number is defined else (p[2] if p|length > 2 else None)) %}

        {% set sds   = (p.sds_key   if p.sds_key   is defined else (p.sds_url if p.sds_url is defined else None)) %}
        {% set label = (p.label_key if p.label_key is defined else (p.label_url if p.label_url is defined else None)) %}
        {% set barcode = (p.barcode_key if p.barcode_key is defined else (p.barcode_img_url if p.barcode_img_url is defined else None)) %}
        {% set uploaded = (p.sds_uploaded_on if p.sds_uploaded_on is defined else None) %}
        {% set category = (p.category if p.category is defined else (p[3] if p|length > 3 else 'Unknown')) %}

        {# Status based on upload date if "today" provided; else "unknown" #}
        {% if uploaded and today is defined %}
          {% set cutoff = today.replace(year=today.year - 3) %}
          {% if uploaded < cutoff %}
            {% set status = 'expired' %}{% set status_text = 'üî¥ SDS Expired' %}{% set badge_class = 'danger' %}
          {% else %}
            {% set status = 'valid' %}{% set status_text = '‚úÖ SDS Valid' %}{% set badge_class = 'ok' %}
          {% endif %}
        {% elif uploaded %}
          {% set status = 'valid' %}{% set status_text = '‚úÖ SDS Uploaded' %}{% set badge_class = 'ok' %}
        {% else %}
          {% set status = 'unknown' %}{% set status_text = '‚ö™ No SDS date' %}{% set badge_class = 'warn' %}
        {% endif %}

        <article class="card"
          data-name="{{ name|lower }}"
          data-epa="{{ (epa or '')|lower }}"
          data-sds="{{ 1 if sds else 0 }}"
          data-label="{{ 1 if label else 0 }}"
          data-barcode="{{ 1 if barcode else 0 }}"
          data-status="{{ status }}"
          data-updated="{{ uploaded or '' }}"
          data-category="{{ category }}"
          data-sds-href="{% if sds %}{{ url_for('sds_open', product_id=pid, kind='sds') }}{% endif %}"
        >
          <h3>{{ name }}</h3>
          <div class="meta">
            {% if epa %}EPA Reg #: <strong>{{ epa }}</strong> ¬∑ {% endif %}
            Category: <strong>{{ category }}</strong>
          </div>

          <div class="badges">
            <span class="badge {{ badge_class }}">{{ status_text }}{% if uploaded %} ¬∑ {{ uploaded }}{% endif %}</span>
            {% if sds %}<span class="badge ok">SDS</span>{% else %}<span class="badge warn">No SDS</span>{% endif %}
            {% if label %}<span class="badge ok">Label</span>{% else %}<span class="badge warn">No Label</span>{% endif %}
            {% if barcode %}<span class="badge ok">Barcode</span>{% else %}<span class="badge warn">No Barcode</span>{% endif %}
          </div>

          <div class="links">
            {% if sds %}
              <a href="{{ url_for('sds_open', product_id=pid, kind='sds') }}" target="_blank" rel="noopener" aria-label="Open SDS for {{ name }}">üìÑ SDS</a>
              <a href="#" class="copy" data-kind="sds" aria-label="Copy SDS link for {{ name }}">üîó Copy SDS</a>
            {% endif %}
            {% if label %}
              <a href="{{ url_for('sds_open', product_id=pid, kind='label') }}" target="_blank" rel="noopener" aria-label="Open Label for {{ name }}">üßæ Label</a>
            {% endif %}
            {% if barcode %}
              <a href="{{ url_for('sds_open', product_id=pid, kind='barcode') }}" target="_blank" rel="noopener" aria-label="Open Barcode for {{ name }}">üß∑ Barcode</a>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </section>

    <div id="empty" class="empty" style="display:none">
      No products match your filters. Try clearing filters or changing your search.
    </div>

    <p class="helper">SDS validity is based on upload date{% if today is defined %} ({{ today }}){% endif %}. Items older than 3 years are flagged as expired. Press <kbd>/</kbd> to search, <kbd>Esc</kbd> to clear filters.</p>
  </div>

  <script>
    // ‚Äî‚Äî‚Äî Fast client-side filtering + sorting + small UX niceties ‚Äî‚Äî‚Äî
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const q = $('#q');
    const fSds = $('#f-sds');
    const fLabel = $('#f-label');
    const fBarcode = $('#f-barcode');
    const fStatus = $('#f-status');
    const fSort = $('#f-sort');
    const catButtons = $$('.chipbtn');
    const grid = $('#grid');
    const cards = $$('#grid .card');
    const empty = $('#empty');

    // Persist filters in localStorage
    const LS_KEY = 'sds_filters_v2';
    function saveFilters(){
      const data = {
        term: q.value || '',
        sds: fSds.checked, label: fLabel.checked, barcode: fBarcode.checked,
        status: fStatus.value, sort: fSort.value,
        cats: catButtons.filter(b => b.getAttribute('aria-pressed') === 'true').map(b => b.dataset.cat)
      };
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    }
    function loadFilters(){
      try{
        const data = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
        if(data.term) q.value = data.term;
        if('sds' in data) fSds.checked = data.sds;
        if('label' in data) fLabel.checked = data.label;
        if('barcode' in data) fBarcode.checked = data.barcode;
        if(data.status) fStatus.value = data.status;
        if(data.sort) fSort.value = data.sort;
        if(Array.isArray(data.cats)){
          catButtons.forEach(b => b.setAttribute('aria-pressed', String(data.cats.includes(b.dataset.cat))));
        }
      }catch(e){ /* ignore */ }
    }

    function applyFilters(){
      const term = (q.value || '').trim().toLowerCase();
      const wantSds = fSds.checked;
      const wantLabel = fLabel.checked;
      const wantBarcode = fBarcode.checked;
      const status = fStatus.value; // all|valid|expired|unknown
      const cats = new Set( catButtons.filter(b => b.getAttribute('aria-pressed') === 'true').map(b => b.dataset.cat) );

      let visible = 0;
      cards.forEach(card => {
        const name = card.dataset.name;
        const epa = card.dataset.epa;
        const hasSds = card.dataset.sds === '1';
        const hasLabel = card.dataset.label === '1';
        const hasBarcode = card.dataset.barcode === '1';
        const st = card.dataset.status;
        const cat = card.dataset.category || 'Unknown';

        const textMatch = !term || name.includes(term) || (epa && epa.includes(term));
        const sdsMatch = !wantSds || hasSds;
        const labelMatch = !wantLabel || hasLabel;
        const barcodeMatch = !wantBarcode || hasBarcode;
        const statusMatch = (status === 'all') || (st === status);
        const catMatch = (cats.size === 0) || cats.has(cat);

        const show = textMatch && sdsMatch && labelMatch && barcodeMatch && statusMatch && catMatch;
        card.style.display = show ? '' : 'none';
        if (show) visible++;
      });

      // Sorting (works on visible nodes only by re-inserting)
      const cmp = {
        name: (a,b) => a.dataset.name.localeCompare(b.dataset.name),
        updated: (a,b) => (b.dataset.updated || '').localeCompare(a.dataset.updated || ''),
        status: (a,b) => (a.dataset.sds === '1' ? 1:0) - (b.dataset.sds === '1' ? 1:0) // missing first
      }[fSort.value] || ((a,b)=>0);

      // Rebuild order
      const visibleCards = cards.filter(c => c.style.display !== 'none');
      visibleCards.sort(cmp).forEach(c => grid.appendChild(c));

      empty.style.display = visible === 0 ? '' : 'none';
      saveFilters();
    }

    // Debounce helper
    const debounce = (fn, ms=150) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; };

    // Event wiring
    q.addEventListener('input', debounce(applyFilters, 120));
    [fSds, fLabel, fBarcode, fStatus, fSort].forEach(el => el.addEventListener('change', applyFilters));
    catButtons.forEach(b => b.addEventListener('click', () => { const on = b.getAttribute('aria-pressed') === 'true'; b.setAttribute('aria-pressed', String(!on)); applyFilters(); }));

    // Keyboard shortcuts: / to focus search, Esc to clear all
    window.addEventListener('keydown', (e) => {
      if(e.key === '/' && document.activeElement !== q){ e.preventDefault(); q.focus(); q.select(); }
      if(e.key === 'Escape'){
        q.value=''; fSds.checked=fLabel.checked=fBarcode.checked=false; fStatus.value='all'; catButtons.forEach(b=>b.setAttribute('aria-pressed','false')); applyFilters();
      }
    });

    // Copy SDS link
    grid.addEventListener('click', async (e) => {
      const a = e.target.closest('a.copy');
      if(!a) return;
      e.preventDefault();
      const card = e.target.closest('.card');
      const href = card?.dataset?.sdsHref || card?.getAttribute('data-sds-href');
      if(!href){ alert('No SDS link for this product.'); return; }
      try{ await navigator.clipboard.writeText(location.origin + href); a.textContent = '‚úÖ Copied'; setTimeout(()=> a.textContent = 'üîó Copy SDS', 1400); }
      catch{ alert('Copy failed'); }
    });

    // Load + apply initial state
    loadFilters();
    applyFilters();

    // Optional: gentle A2HS prompt if installed as PWA is desired
    let deferPrompt;
    window.addEventListener('beforeinstallprompt', (e) => { deferPrompt = e; /* you can show a custom button and call deferPrompt.prompt() */ });
  </script>
</body>
</html>
