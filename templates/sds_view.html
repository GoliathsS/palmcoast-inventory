<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SDS & Labels Â· Field Ops Ultra</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>
  <style>
    :root{
      --pc:#14532d; --ink:#0b1220; --muted:#6c7280; --border:#e6e7ec; --bg:#f6f7fb; --card:#fff;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --radius:14px;
    }
    body{background:var(--bg); color:var(--ink)}
    .container{max-width:1100px; margin:0 auto; padding:12px 16px 96px}

    /* Header */
    .hdr{position:sticky; top:0; z-index:30; backdrop-filter:blur(8px); background:color-mix(in oklab, var(--bg), transparent 8%); border-bottom:1px solid var(--border)}
    .hdr-inner{display:flex; align-items:center; gap:10px; padding:10px 16px}
    .logo{width:36px; height:36px; border-radius:8px; object-fit:cover; box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .title{margin:0; font-size:1.12rem; color:var(--pc)}
    .subtitle{margin:1px 0 0; color:var(--muted); font-size:.92rem}

    .toolbar{display:grid; grid-template-columns:1fr; gap:.6rem; padding:10px 16px}
    @media(min-width:900px){.toolbar{grid-template-columns: 1fr auto auto auto}}

    /* Search */
    .search{position:relative}
    .search input{width:100%; padding:12px 14px 12px 44px; border-radius:12px; border:1px solid var(--border); background:var(--card); font-weight:700}
    .search .icon{position:absolute; left:14px; top:50%; transform:translateY(-50%); opacity:.6}
    .search .clear{position:absolute; right:8px; top:50%; transform:translateY(-50%); border:none; background:transparent; font-size:1rem; opacity:.45; cursor:pointer}

    /* Quick result popover */
    .ac{position:absolute; left:0; right:0; top:calc(100% + 6px); background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,.12); overflow:hidden; display:none}
    .ac.open{display:block}
    .ac-list{max-height:56vh; overflow:auto}
    .ac-item{display:grid; grid-template-columns:1fr auto; gap:10px; padding:10px 12px; border-bottom:1px solid #f1f5f9}
    .ac-item[aria-selected="true"]{background:#eef6ff}
    .ac-name{font-weight:800}
    .ac-meta{color:var(--muted); font-size:.9rem}
    .ac-actions{display:flex; gap:.35rem}
    .pill{display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .55rem; border:1px solid var(--border); border-radius:999px; font-weight:800; background:var(--card)}

    /* Controls */
    .controls{display:flex; gap:.5rem; flex-wrap:wrap}
    .select, .check, .btn{display:inline-flex; align-items:center; gap:.45rem; padding:8px 10px; border-radius:10px; background:var(--card); border:1px solid var(--border); font-weight:800}
    .select select{border:none; background:transparent; font-weight:800; outline:none}
    .btn.primary{background:var(--pc); color:#fff; border-color:color-mix(in oklab,var(--pc),#000 12%)}

    /* Layout */
    .layout{display:grid; grid-template-columns: 1fr; gap:12px; padding:12px 16px}
    @media(min-width:1080px){ .layout{grid-template-columns:260px 1fr} }
    .side{position:sticky; top:140px; align-self:start; display:flex; flex-direction:column; gap:8px}
    .side .block{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px}
    .side .block h5{margin:0 0 6px; color:var(--muted); font-size:.92rem}
    .side .flt{display:flex; flex-direction:column; gap:6px}

    /* List rows */
    .list{}
    .row{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:10px}
    .row .name{margin:0; font-size:1.02rem}
    .row .meta{color:var(--muted); font-size:.92rem}
    .row .badges{display:flex; gap:.35rem; flex-wrap:wrap; margin-top:4px}
    .badge{display:inline-flex; align-items:center; gap:.3rem; padding:.3rem .55rem; border-radius:999px; border:1px solid var(--border); font-size:.82rem; font-weight:900}
    .ok{background:color-mix(in oklab, var(--ok), #fff 87%); color:#065f46; border-color:color-mix(in oklab, var(--ok), #000 14%)}
    .warn{background:color-mix(in oklab, var(--warn), #fff 88%); color:#92400e; border-color:color-mix(in oklab, var(--warn), #000 14%)}
    .bad{background:color-mix(in oklab, var(--bad), #fff 88%); color:#7f1d1d; border-color:color-mix(in oklab, var(--bad), #000 14%)}

    .actions{display:flex; gap:.45rem; align-items:center}
    .actions a{display:inline-flex; align-items:center; gap:.4rem; padding:.5rem .7rem; border:1px solid var(--border); border-radius:10px; background:var(--card); text-decoration:none; font-weight:900}
    .act.copy{padding:.5rem;}
    .star{cursor:pointer; border:none; background:transparent; font-size:1.1rem}

    /* Letter rail */
    .alpha{position:fixed; right:6px; top:160px; display:flex; flex-direction:column; gap:2px; background:rgba(255,255,255,.65); backdrop-filter:blur(6px); padding:6px; border-radius:10px; border:1px solid var(--border)}
    .alpha a{display:block; padding:2px 5px; font-weight:900; text-decoration:none; color:#475569}

    /* Bottom dock (mobile) */
    .dock{position:fixed; z-index:40; left:0; right:0; bottom:0; background:rgba(255,255,255,.9); backdrop-filter:blur(8px); border-top:1px solid var(--border); padding:8px 10px}
    .dock .row{display:flex; gap:8px; justify-content:space-between}
    .toggle{display:inline-flex; align-items:center; gap:.4rem; padding:.5rem .7rem; border-radius:10px; border:1px solid var(--border); background:#fff; font-weight:900}

    /* Command palette */
    dialog{border:none; border-radius:14px; padding:0; width:min(720px, 92vw); box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .cmdk{background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden}
    .cmdk input{width:100%; padding:14px; border:none; border-bottom:1px solid var(--border); outline:none; font-size:1.05rem}
    .results{max-height:60vh; overflow:auto}
    .res{display:flex; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #f1f5f9}
    .res strong{font-weight:800}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:.8rem; color:#475569}

    @media(max-width:720px){
      .layout{grid-template-columns:1fr}
      .alpha{display:none}
    }
  </style>
</head>
<body>
  <div class="hdr">
    <div class="hdr-inner container">
      <img src="{{ url_for('static', filename='LOGO.jpg') }}" alt="Palm Coast" class="logo"/>
      <div>
        <h2 class="title">SDS & Label Portal â€” Field Ops</h2>
        <p class="subtitle">Type to find. Enter opens SDS. Shift+Enter opens Label. âŒ˜/Ctrl+K for full palette.</p>
      </div>
    </div>
    <div class="toolbar">
      <div class="search">
        <span class="icon">ðŸ”Ž</span>
        <input id="q" type="search" placeholder="Search: product, EPA #, aliasâ€¦" autocomplete="off"/>
        <button id="qclear" class="clear" title="Clear">âœ•</button>
        <div id="ac" class="ac" role="listbox" aria-label="Quick results">
          <div class="ac-list" id="acList"></div>
          <div class="kbd" style="display:flex; justify-content:space-between; padding:8px 12px"><span>â†‘/â†“ to navigate â€¢ Enter = SDS â€¢ Shift+Enter = Label</span><span>Esc to close</span></div>
        </div>
      </div>
      <div class="controls">
        <label class="check"><input type="checkbox" id="f-sds"> SDS</label>
        <label class="check"><input type="checkbox" id="f-label"> Label</label>
        <label class="check"><input type="checkbox" id="f-barcode"> Barcode</label>
      </div>
      <div class="controls">
        <div class="select"><span>Status:</span>
          <select id="f-status"><option value="all">All</option><option value="valid">Valid</option><option value="expired">Expired</option><option value="unknown">Unknown</option></select>
        </div>
        <div class="select"><span>Sort:</span>
          <select id="f-sort"><option value="name">A â†’ Z</option><option value="updated">Recently Updated</option><option value="missing">Missing first</option></select>
        </div>
      </div>
      <div class="controls"><a class="btn primary" href="/edit-sds">ðŸ›  Manage SDS</a></div>
    </div>
  </div>

  <div class="container layout">
    <aside class="side">
      <div class="block">
        <h5>Categories</h5>
        <div class="flt">
          <label><input type="checkbox" class="cat" value="Pest"> Pest</label>
          <label><input type="checkbox" class="cat" value="Lawn"> Lawn</label>
          <label><input type="checkbox" class="cat" value="Wildlife"> Wildlife</label>
        </div>
      </div>
      <div class="block">
        <h5>Truck</h5>
        <div class="flt">
          <input id="truck" type="text" placeholder="Truck ID (e.g., 12)">
          <small class="muted">Append <code>?truck=12</code> to URL to pre-filter.</small>
        </div>
      </div>
    </aside>

    <main>
      <nav class="alpha" aria-label="Jump to letter" id="alpha"></nav>
      <section id="list" class="list" aria-live="polite">
        {% set last = '' %}
        {% for p in products|sort(attribute='name') if p.name is defined %}
          {% set first = (p.name[0]|upper) %}
          {% if first != last %}
            <h3 id="L{{ first }}" style="margin:10px 0 6px; color:#475569">{{ first }}</h3>
            {% set last = first %}
          {% endif %}
          {% set pid = p.id %}
          {% set name = p.name %}
          {% set epa = p.epa_number %}
          {% set sds = p.sds_key or p.sds_url %}
          {% set label = p.label_key or p.label_url %}
          {% set barcode = p.barcode_key or p.barcode_img_url %}
          {% set uploaded = p.sds_uploaded_on %}
          {% set category = p.category or 'Unknown' %}
          {% set aliases = p.aliases or '' %}

          {% if uploaded and today is defined %}
            {% set cutoff = today.replace(year=today.year - 3) %}
            {% if uploaded < cutoff %}
              {% set status='expired' %}{% set badge='bad' %}{% set status_text='SDS Expired' %}
            {% else %}
              {% set status='valid' %}{% set badge='ok' %}{% set status_text='SDS Valid' %}
            {% endif %}
          {% elif uploaded %}
            {% set status='valid' %}{% set badge='ok' %}{% set status_text='SDS Uploaded' %}
          {% else %}
            {% set status='unknown' %}{% set badge='warn' %}{% set status_text='No SDS date' %}
          {% endif %}

          <article class="row" data-name="{{ name|lower }}" data-aliases="{{ (aliases|string)|lower }}" data-epa="{{ (epa or '')|lower }}" data-sds="{{ 1 if sds else 0 }}" data-label="{{ 1 if label else 0 }}" data-barcode="{{ 1 if barcode else 0 }}" data-status="{{ status }}" data-updated="{{ uploaded or '' }}" data-category="{{ category }}">
            <div class="col-main">
              <h4 class="name"><a href="{% if sds %}{{ url_for('sds_open', product_id=pid, kind='sds') }}{% else %}#{% endif %}" class="open-sds" data-name="{{ name }}" style="text-decoration:none; color:inherit">{{ name }}</a></h4>
              <div class="meta">{% if epa %}EPA: <strong>{{ epa }}</strong> Â· {% endif %}Category: <strong>{{ category }}</strong>{% if aliases %} Â· aka: <em>{{ aliases }}</em>{% endif %}</div>
              <div class="badges">
                <span class="badge {{ badge }}">{{ status_text }}{% if uploaded %} Â· {{ uploaded }}{% endif %}</span>
                <span class="badge {{ sds and 'ok' or 'warn' }}">{{ sds and 'SDS' or 'No SDS' }}</span>
                <span class="badge {{ label and 'ok' or 'warn' }}">{{ label and 'Label' or 'No Label' }}</span>
                <span class="badge {{ barcode and 'ok' or 'warn' }}">{{ barcode and 'Barcode' or 'No Barcode' }}</span>
              </div>
            </div>
            <div class="actions">
              {% if sds %}
                <a href="{{ url_for('sds_open', product_id=pid, kind='sds') }}" target="_blank" class="act sds" data-name="{{ name }}">ðŸ“„ SDS</a>
                <a href="{{ url_for('sds_open', product_id=pid, kind='sds') }}?download=1" class="act copy" title="Download SDS" aria-label="Download SDS for {{ name }}">â¬‡ï¸Ž</a>
              {% endif %}
              {% if label %}<a href="{{ url_for('sds_open', product_id=pid, kind='label') }}" target="_blank" class="act lab" data-name="{{ name }}">ðŸ§¾ Label</a>{% endif %}
              {% if barcode %}<a href="{{ url_for('sds_open', product_id=pid, kind='barcode') }}" target="_blank" class="act bar" data-name="{{ name }}">ðŸ§· Barcode</a>{% endif %}
              <button class="star" title="Toggle favorite" aria-label="Favorite" data-name="{{ name }}">â˜†</button>
            </div>
          </article>
        {% endfor %}
      </section>
    </main>
  </div>

  <!-- Bottom quick filter dock (mobile/any) -->
  <div class="dock">
    <div class="row">
      <button class="toggle" id="t-sds">SDS</button>
      <button class="toggle" id="t-label">Label</button>
      <button class="toggle" id="t-barcode">Barcode</button>
      <button class="toggle" id="t-missing">Missing first</button>
    </div>
  </div>

  <!-- Command palette (Cmd/Ctrl+K) -->
  <dialog id="cmd">
    <div class="cmdk">
      <input id="cmdq" placeholder="Type a product, EPA #, or actionâ€¦" />
      <div id="cmdres" class="results"></div>
      <div style="display:flex; justify-content:space-between; padding:8px 12px" class="kbd"><span>Enter â†’ open SDS Â· Shift+Enter â†’ Label</span><span>Esc to close</span></div>
    </div>
  </dialog>

  <script>
    const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
    const q=$('#q'), qclear=$('#qclear');
    const fSds=$('#f-sds'), fLabel=$('#f-label'), fBarcode=$('#f-barcode'), fStatus=$('#f-status'), fSort=$('#f-sort');
    const cards=$$('#list .row');
    const ac=$('#ac'), acList=$('#acList');

    // Build alpha rail
    const letters = [...new Set($$('#list h3[id^="L"]').map(h => h.id.replace('L','')))].sort();
    const alpha = $('#alpha');
    letters.forEach(l => { const a=document.createElement('a'); a.href='#L'+l; a.textContent=l; alpha.appendChild(a); });

    // Filtering
    function visibleCards(){ return cards.filter(c=>c.style.display!== 'none'); }
    function apply(){
      const term=(q.value||'').trim().toLowerCase();
      const cats = new Set($$('.cat:checked').map(c=>c.value));
      cards.forEach(c=>{
        const name=c.dataset.name, aliases=c.dataset.aliases||'', epa=c.dataset.epa, cat=c.dataset.category||'Unknown', st=c.dataset.status;
        const show = (!term || name.includes(term) || aliases.includes(term) || (epa && epa.includes(term))) &&
          (!fSds.checked || c.dataset.sds==='1') && (!fLabel.checked || c.dataset.label==='1') && (!fBarcode.checked || c.dataset.barcode==='1') &&
          (fStatus.value==='all' || st===fStatus.value) && (cats.size===0 || cats.has(cat));
        c.style.display = show? 'grid':'none';
      });
      // sort
      const cmp = {
        name:(a,b)=>a.dataset.name.localeCompare(b.dataset.name),
        updated:(a,b)=>(b.dataset.updated||'').localeCompare(a.dataset.updated||''),
        missing:(a,b)=>(a.dataset.sds==='1')-(b.dataset.sds==='1')
      }[fSort.value] || (()=>0);
      visibleCards().sort(cmp).forEach(c=>c.parentNode.appendChild(c));
      drawAC();
    }

    [q,fSds,fLabel,fBarcode,fStatus,fSort, ...$$('.cat')].forEach(el=>el.addEventListener('input', apply));
    qclear.addEventListener('click', ()=>{ q.value=''; apply(); closeAC(); q.focus(); });

    // Quick results popover under search
    function drawAC(){
      const term=(q.value||'').trim().toLowerCase();
      acList.innerHTML='';
      if(term.length < 2){ closeAC(); return; }
      const items = visibleCards().map(el=>({
        el,
        name: el.dataset.name,
        epa: el.dataset.epa,
        sds: el.querySelector('.actions .sds'),
        label: el.querySelector('.actions .lab'),
        barcode: el.querySelector('.actions .bar')
      }));
      const score = (t,s)=> s===t?100 : s.startsWith(t)?70 : s.includes(t)?40 : 0;
      const ranked = items.map(o=>({o, sc: Math.max(score(term,o.name), score(term,o.epa||''))}))
        .filter(v=>v.sc>0)
        .sort((a,b)=>b.sc-a.sc || a.o.name.localeCompare(b.o.name))
        .slice(0,20);
      if(!ranked.length){ closeAC(); return; }
      ranked.forEach((v,i)=>{
        const row=document.createElement('div'); row.className='ac-item'; row.setAttribute('role','option'); row.dataset.idx=i;
        row.innerHTML=`<div><div class="ac-name">${v.o.name}</div><div class="ac-meta">EPA ${v.o.epa||'â€”'}</div></div>
          <div class="ac-actions">${v.o.sds?'<span class="pill">SDS</span>':''}${v.o.label?'<span class="pill">Label</span>':''}${v.o.barcode?'<span class="pill">Barcode</span>':''}</div>`;
        row.onclick=()=>{ openPrimary(v.o); };
        acList.appendChild(row);
      });
      openAC(); highlightAC(0);
    }
    function openAC(){ ac.classList.add('open'); }
    function closeAC(){ ac.classList.remove('open'); }
    let acIndex=0;
    function highlightAC(i){ const rows=$$('.ac-item'); if(!rows.length) return; acIndex=Math.max(0, Math.min(i, rows.length-1)); rows.forEach(r=>r.setAttribute('aria-selected','false')); rows[acIndex].setAttribute('aria-selected','true'); rows[acIndex].scrollIntoView({block:'nearest'}); }
    function currentAC(){ return $$('.ac-item')[acIndex]; }

    function openPrimary(o){ if(o.sds){ o.sds.click(); } else { o.el.scrollIntoView({behavior:'smooth', block:'center'}); o.el.animate([{outline:'2px solid #0ea5e9'},{outline:'0px solid transparent'}],{duration:900}); } closeAC(); }
    function openSecondary(o){ if(o.label){ o.label.click(); } else { openPrimary(o); } }

    q.addEventListener('keydown', (e)=>{
      if(!ac.classList.contains('open')) return;
      const rows=$$('.ac-item'); if(!rows.length) return;
      if(e.key==='ArrowDown'){ e.preventDefault(); highlightAC(acIndex+1); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); highlightAC(acIndex-1); }
      else if(e.key==='Enter'){ e.preventDefault(); const idx=currentAC()?.dataset.idx; if(idx==null) return; const v=rows[idx]; const name=v.querySelector('.ac-name').textContent.toLowerCase(); const match=visibleCards().find(el=>el.dataset.name===name); if(!match) return; const obj={ el:match, sds: match.querySelector('.sds'), label: match.querySelector('.lab') }; if(e.shiftKey) openSecondary(obj); else openPrimary(obj); }
      else if(e.key==='Escape'){ closeAC(); }
    });

    // Clicking product name opens SDS if present
    $$('#list .open-sds').forEach(a=> a.addEventListener('click', (e)=>{ const has=a.getAttribute('href') && !a.getAttribute('href').endsWith('#'); if(!has){ e.preventDefault(); } }));

    // Bottom dock bindings
    $('#t-sds').addEventListener('click', ()=>{ fSds.checked=!fSds.checked; apply(); });
    $('#t-label').addEventListener('click', ()=>{ fLabel.checked=!fLabel.checked; apply(); });
    $('#t-barcode').addEventListener('click', ()=>{ fBarcode.checked=!fBarcode.checked; apply(); });
    $('#t-missing').addEventListener('click', ()=>{ fSort.value = (fSort.value==='missing' ? 'name' : 'missing'); apply(); });

    // Command palette (optional power users)
    const dlg=$('#cmd'), cmdq=$('#cmdq'), cmdres=$('#cmdres');
    function openCmd(){ dlg.showModal(); cmdq.value=''; drawCmd(''); cmdq.focus(); }
    function closeCmd(){ dlg.close(); }
    window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){ e.preventDefault(); openCmd(); } });
    dlg.addEventListener('close', ()=> cmdres.innerHTML='');

    function drawCmd(qs){
      cmdres.innerHTML='';
      const items = cards.map(c=>({name:c.dataset.name, epa:c.dataset.epa, el:c, sds:c.querySelector('.sds'), label:c.querySelector('.lab')}));
      const term=qs.trim().toLowerCase();
      const score = (s)=>{ if(!term) return 0; if(s===term) return 100; if(s.startsWith(term)) return 70; if(s.includes(term)) return 40; return 0; };
      items.map(o=>({o, sc: Math.max(score(o.name), score(o.epa||''))})).filter(v=>v.sc>0 || !term).sort((a,b)=>b.sc-a.sc || a.o.name.localeCompare(b.o.name)).slice(0,40).forEach(v=>{
        const row=document.createElement('div'); row.className='res';
        row.innerHTML=`<div><strong>${v.o.name}</strong><div class="kbd">EPA ${v.o.epa||'â€”'}</div></div><div class="kbd">Enter â†’ SDS â€¢ Shift+Enter â†’ Label</div>`;
        row.onclick=()=>{ closeCmd(); if(window.event && window.event.shiftKey && v.o.label) v.o.label.click(); else if(v.o.sds) v.o.sds.click(); else v.o.el.scrollIntoView({behavior:'smooth', block:'center'}); };
        cmdres.appendChild(row);
      });
    }
    cmdq.addEventListener('input', ()=> drawCmd(cmdq.value));
    dlg.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeCmd(); });

    // Truck prefilter via URL ?truck=12
    (function(){ const u=new URL(location.href); const t=u.searchParams.get('truck'); if(t){ $('#truck').value=t; document.title += ` Â· Truck ${t}`; }})();

    // Init
    apply();
  </script>
</body>
</html>
