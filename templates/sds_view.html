<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SDS & Labels ¬∑ Field Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>
  <style>
    :root{
      --pc-green:#14532d; --ink:#0b1220; --muted:#6c7280; --border:#e6e7ec; --bg:#f6f7fb; --card:#fff;
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --radius:14px;
    }
    body{background:var(--bg); color:var(--ink)}
    .container{max-width:1100px; margin:0 auto; padding:14px 16px 60px}

    /* Header */
    .hdr{position:sticky; top:0; z-index:20; backdrop-filter:blur(8px); background:color-mix(in oklab, var(--bg), transparent 10%); border-bottom:1px solid var(--border)}
    .hdr-inner{display:flex; align-items:center; gap:10px; padding:10px 16px}
    .logo{width:36px; height:36px; border-radius:8px; object-fit:cover; box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .title{margin:0; font-size:1.1rem; color:var(--pc-green)}
    .subtitle{margin:1px 0 0; color:var(--muted); font-size:.92rem}

    .toolbar{display:grid; grid-template-columns:1fr; gap:.6rem; padding:10px 16px}
    @media(min-width:820px){.toolbar{grid-template-columns: 1fr auto auto auto}}

    /* Search */
    .search{position:relative}
    .search input{width:100%; padding:12px 14px 12px 44px; border-radius:12px; border:1px solid var(--border); background:var(--card); font-weight:600}
    .search .icon{position:absolute; left:14px; top:50%; transform:translateY(-50%); opacity:.6}

    /* Toggle + sort */
    .controls{display:flex; gap:.5rem; flex-wrap:wrap}
    .select, .check, .btn{display:inline-flex; align-items:center; gap:.45rem; padding:8px 10px; border-radius:10px; background:var(--card); border:1px solid var(--border); font-weight:700}
    .select select{border:none; background:transparent; font-weight:700; outline:none}
    .btn.primary{background:var(--pc-green); color:#fff; border-color:color-mix(in oklab,var(--pc-green),#000 12%)}

    /* Quick lanes */
    .lanes{display:grid; gap:10px; padding:0 16px 10px}
    .lane{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px}
    .lane h4{margin:0 0 6px; font-size:.95rem; color:var(--muted)}
    .chips{display:flex; gap:.5rem; overflow:auto; scroll-snap-type:x mandatory}
    .chip{scroll-snap-align:start; display:inline-flex; align-items:center; gap:.4rem; padding:.45rem .65rem; background:#f1f5f9; border:1px solid var(--border); border-radius:999px; font-weight:700; white-space:nowrap}

    /* Layout: sidebar filters + list */
    .layout{display:grid; grid-template-columns: 1fr; gap:12px; padding:12px 16px}
    @media(min-width:1000px){ .layout{grid-template-columns:260px 1fr} }
    .side{position:sticky; top:126px; align-self:start; display:flex; flex-direction:column; gap:8px}
    .side .block{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:10px}
    .side .block h5{margin:0 0 6px; color:var(--muted); font-size:.92rem}
    .side .flt{display:flex; flex-direction:column; gap:6px}

    /* List rows */
    .list{display:block}
    .row{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:10px}
    .row .name{margin:0; font-size:1.02rem}
    .row .meta{color:var(--muted); font-size:.92rem}
    .row .badges{display:flex; gap:.35rem; flex-wrap:wrap; margin-top:4px}
    .badge{display:inline-flex; align-items:center; gap:.3rem; padding:.3rem .55rem; border-radius:999px; border:1px solid var(--border); font-size:.82rem; font-weight:800}
    .ok{background:color-mix(in oklab, var(--ok), #fff 87%); color:#065f46; border-color:color-mix(in oklab, var(--ok), #000 14%)}
    .warn{background:color-mix(in oklab, var(--warn), #fff 88%); color:#92400e; border-color:color-mix(in oklab, var(--warn), #000 14%)}
    .bad{background:color-mix(in oklab, var(--bad), #fff 88%); color:#7f1d1d; border-color:color-mix(in oklab, var(--bad), #000 14%)}

    .actions{display:flex; gap:.45rem; align-items:center}
    .actions a{display:inline-flex; align-items:center; gap:.4rem; padding:.5rem .7rem; border:1px solid var(--border); border-radius:10px; background:var(--card); text-decoration:none; font-weight:800}
    .star{cursor:pointer; border:none; background:transparent; font-size:1.1rem}

    /* Alpha index */
    .alpha{position:fixed; right:6px; top:160px; display:flex; flex-direction:column; gap:2px; background:rgba(255,255,255,.6); backdrop-filter:blur(6px); padding:6px; border-radius:10px; border:1px solid var(--border)}
    .alpha a{display:block; padding:2px 5px; font-weight:900; text-decoration:none; color:#475569}

    /* Command palette */
    dialog{border:none; border-radius:14px; padding:0; width:min(720px, 92vw); box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .cmdk{background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden}
    .cmdk input{width:100%; padding:14px; border:none; border-bottom:1px solid var(--border); outline:none; font-size:1.05rem}
    .results{max-height:60vh; overflow:auto}
    .res{display:flex; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #f1f5f9}
    .res strong{font-weight:800}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:.8rem; color:#475569}

    /* Field mode spacing for one-hand use on mobile */
    @media(max-width:640px){
      .row{grid-template-columns: 1fr;}
      .actions{justify-content:space-between}
      .alpha{display:none}
    }
  </style>
</head>
<body>
  <div class="hdr">
    <div class="hdr-inner container">
      <img src="{{ url_for('static', filename='LOGO.jpg') }}" alt="Palm Coast" class="logo"/>
      <div>
        <h2 class="title">SDS & Label Portal ‚Äî Field Mode</h2>
        <p class="subtitle">Find any SDS in <strong>2 taps</strong>. Press <kbd>‚åò/Ctrl + K</kbd> for quick search.</p>
      </div>
    </div>
    <div class="toolbar">
      <div class="search"><span class="icon">üîé</span><input id="q" type="search" placeholder="Search: product, EPA #, alias‚Ä¶" autocomplete="off"></div>
      <div class="controls">
        <label class="check"><input type="checkbox" id="f-sds"> SDS</label>
        <label class="check"><input type="checkbox" id="f-label"> Label</label>
        <label class="check"><input type="checkbox" id="f-barcode"> Barcode</label>
      </div>
      <div class="controls">
        <div class="select"><span>Status:</span>
          <select id="f-status"><option value="all">All</option><option value="valid">Valid</option><option value="expired">Expired</option><option value="unknown">Unknown</option></select>
        </div>
        <div class="select"><span>Sort:</span>
          <select id="f-sort"><option value="name">A ‚Üí Z</option><option value="updated">Recently Updated</option><option value="missing">Missing first</option></select>
        </div>
      </div>
      <div class="controls"><a class="btn primary" href="/edit-sds">üõ† Manage SDS</a></div>
    </div>

    <!-- Quick lanes: Favorites + Recent + Job Packs (localStorage driven) -->
    <div class="lanes container">
      <div class="lane" id="lane-fav"><h4>‚≠ê Favorites</h4><div class="chips" id="chips-fav"></div></div>
      <div class="lane" id="lane-rec"><h4>üïë Recent</h4><div class="chips" id="chips-rec"></div></div>
      <div class="lane"><h4>üì¶ Job Packs</h4><div class="chips">
        <a class="chip" href="#" data-pack='["Termidor SC","Alpine WSG","Taurus SC"]'>üè† General Pest</a>
        <a class="chip" href="#" data-pack='["Bifen 7.9%","Honor Guard","Cy-Kick"]'>üêú Ants</a>
        <a class="chip" href="#" data-pack='["SpeedZone","Celsius WG","Vessel"]'>üåø Weed Control</a>
      </div></div>
    </div>
  </div>

  <div class="container layout">
    <aside class="side">
      <div class="block">
        <h5>Categories</h5>
        <div class="flt">
          <label><input type="checkbox" class="cat" value="Pest"> Pest</label>
          <label><input type="checkbox" class="cat" value="Lawn"> Lawn</label>
          <label><input type="checkbox" class="cat" value="Wildlife"> Wildlife</label>
        </div>
      </div>
      <div class="block">
        <h5>Truck</h5>
        <div class="flt">
          <input id="truck" type="text" placeholder="Truck ID (e.g., 12)">
          <small class="muted">Append <code>?truck=12</code> to URL to pre-filter.</small>
        </div>
      </div>
    </aside>

    <main>
      <nav class="alpha" aria-label="Jump to letter" id="alpha"></nav>
      <section id="list" class="list" aria-live="polite">
      {% set last = '' %}
      {% for p in products|sort(attribute='name') if p.name is defined %}
        {% set first = (p.name[0]|upper) %}
        {% if first != last %}
          <h3 id="L{{ first }}" style="margin:10px 0 6px; color:#475569">{{ first }}</h3>
          {% set last = first %}
        {% endif %}
        {% set pid = p.id %}
        {% set name = p.name %}
        {% set epa = p.epa_number %}
        {% set sds = p.sds_key or p.sds_url %}
        {% set label = p.label_key or p.label_url %}
        {% set barcode = p.barcode_key or p.barcode_img_url %}
        {% set uploaded = p.sds_uploaded_on %}
        {% set category = p.category or 'Unknown' %}

        {% if uploaded and today is defined %}
          {% set cutoff = today.replace(year=today.year - 3) %}
          {% if uploaded < cutoff %}
            {% set status='expired' %}{% set badge='bad' %}{% set status_text='SDS Expired' %}
          {% else %}
            {% set status='valid' %}{% set badge='ok' %}{% set status_text='SDS Valid' %}
          {% endif %}
        {% elif uploaded %}
          {% set status='valid' %}{% set badge='ok' %}{% set status_text='SDS Uploaded' %}
        {% else %}
          {% set status='unknown' %}{% set badge='warn' %}{% set status_text='No SDS date' %}
        {% endif %}

        <article class="row" data-name="{{ name|lower }}" data-epa="{{ (epa or '')|lower }}" data-sds="{{ 1 if sds else 0 }}" data-label="{{ 1 if label else 0 }}" data-barcode="{{ 1 if barcode else 0 }}" data-status="{{ status }}" data-updated="{{ uploaded or '' }}" data-category="{{ category }}">
          <div>
            <h4 class="name">{{ name }}</h4>
            <div class="meta">{% if epa %}EPA: <strong>{{ epa }}</strong> ¬∑ {% endif %}Category: <strong>{{ category }}</strong></div>
            <div class="badges">
              <span class="badge {{ badge }}">{{ status_text }}{% if uploaded %} ¬∑ {{ uploaded }}{% endif %}</span>
              <span class="badge {{ sds and 'ok' or 'warn' }}">{{ sds and 'SDS' or 'No SDS' }}</span>
              <span class="badge {{ label and 'ok' or 'warn' }}">{{ label and 'Label' or 'No Label' }}</span>
              <span class="badge {{ barcode and 'ok' or 'warn' }}">{{ barcode and 'Barcode' or 'No Barcode' }}</span>
            </div>
          </div>
          <div class="actions">
            {% if sds %}<a href="{{ url_for('sds_open', product_id=pid, kind='sds') }}" target="_blank" class="act sds" data-name="{{ name }}">üìÑ SDS</a>{% endif %}
            {% if label %}<a href="{{ url_for('sds_open', product_id=pid, kind='label') }}" target="_blank" class="act lab" data-name="{{ name }}">üßæ Label</a>{% endif %}
            {% if barcode %}<a href="{{ url_for('sds_open', product_id=pid, kind='barcode') }}" target="_blank" class="act bar" data-name="{{ name }}">üß∑ Barcode</a>{% endif %}
            <button class="star" title="Toggle favorite" aria-label="Favorite" data-name="{{ name }}">‚òÜ</button>
          </div>
        </article>
      {% endfor %}
      </section>
    </main>
  </div>

  <!-- Command palette (Cmd/Ctrl+K) -->
  <dialog id="cmd">
    <div class="cmdk">
      <input id="cmdq" placeholder="Type a product, EPA #, or action‚Ä¶" />
      <div id="cmdres" class="results"></div>
      <div style="display:flex; justify-content:space-between; padding:8px 12px" class="kbd"><span>Enter ‚Üí open SDS ¬∑ Tab ‚Üí cycle</span><span>Esc to close</span></div>
    </div>
  </dialog>

  <script>
    const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
    const q=$('#q'), fSds=$('#f-sds'), fLabel=$('#f-label'), fBarcode=$('#f-barcode'), fStatus=$('#f-status'), fSort=$('#f-sort');
    const cards=$$('#list .row'), chipsFav=$('#chips-fav'), chipsRec=$('#chips-rec');

    // Alpha index
    const letters = [...new Set($$('#list h3[id^="L"]').map(h => h.id.replace('L','')))].sort();
    const alpha = $('#alpha');
    letters.forEach(l => { const a=document.createElement('a'); a.href='#L'+l; a.textContent=l; alpha.appendChild(a); });

    // Favorites & Recents
    const FAV_KEY='sds_favorites_v3', REC_KEY='sds_recent_v3';
    function favs(){ try{return JSON.parse(localStorage.getItem(FAV_KEY)||'[]')}catch{return[]} }
    function setFavs(v){ localStorage.setItem(FAV_KEY, JSON.stringify(v)); renderFavs(); }
    function recents(){ try{return JSON.parse(localStorage.getItem(REC_KEY)||'[]')}catch{return[]} }
    function pushRecent(name){ const arr=recents().filter(n=>n!==name); arr.unshift(name); localStorage.setItem(REC_KEY, JSON.stringify(arr.slice(0,12))); renderRecents(); }

    function renderFavs(){ chipsFav.innerHTML=''; favs().forEach(n=>{ const el=document.createElement('a'); el.className='chip'; el.textContent=n; el.href='#'; el.onclick=(e)=>{e.preventDefault(); jumpTo(n)}; chipsFav.appendChild(el); }); }
    function renderRecents(){ chipsRec.innerHTML=''; recents().forEach(n=>{ const el=document.createElement('a'); el.className='chip'; el.textContent=n; el.href='#'; el.onclick=(e)=>{e.preventDefault(); jumpTo(n)}; chipsRec.appendChild(el); }); }

    function jumpTo(name){ const c=cards.find(c=>c.dataset.name===name.toLowerCase()); if(!c) return; c.scrollIntoView({behavior:'smooth', block:'center'}); c.animate([{outline:'2px solid #0ea5e9'},{outline:'0px solid transparent'}],{duration:900}); }

    // Star favorite
    $('#list').addEventListener('click', (e)=>{
      const star = e.target.closest('.star'); if(!star) return;
      const name=star.dataset.name; const list=favs();
      const i=list.indexOf(name); if(i>=0){ list.splice(i,1); star.textContent='‚òÜ'; } else { list.unshift(name); star.textContent='‚òÖ'; }
      setFavs(list.slice(0,20));
    });

    // Mark stars on load
    function paintStars(){ const f=new Set(favs()); $$('.star').forEach(b=> b.textContent = f.has(b.dataset.name)?'‚òÖ':'‚òÜ'); }

    // Track recents when open SDS/Label
    $$('#list .actions a.act').forEach(a=> a.addEventListener('click', ()=> pushRecent(a.dataset.name)) );

    // Filters
    function apply(){
      const term=(q.value||'').trim().toLowerCase();
      const cats = new Set($$('.cat:checked').map(c=>c.value));
      let visible=0;
      cards.forEach(c=>{
        const name=c.dataset.name, epa=c.dataset.epa, cat=c.dataset.category||'Unknown';
        const st=c.dataset.status;
        const show = (!term || name.includes(term) || (epa && epa.includes(term))) &&
          (!fSds.checked || c.dataset.sds==='1') && (!fLabel.checked || c.dataset.label==='1') && (!fBarcode.checked || c.dataset.barcode==='1') &&
          (fStatus.value==='all' || st===fStatus.value) && (cats.size===0 || cats.has(cat));
        c.style.display = show? 'grid':'none'; if(show) visible++;
      });
      // sort
      const cmp = { name:(a,b)=>a.dataset.name.localeCompare(b.dataset.name), updated:(a,b)=>(b.dataset.updated||'').localeCompare(a.dataset.updated||''), missing:(a,b)=>(a.dataset.sds==='1')-(b.dataset.sds==='1') }[fSort.value] || (()=>0);
      cards.filter(c=>c.style.display!=='none').sort(cmp).forEach(c=>c.parentNode.appendChild(c));
    }

    [q,fSds,fLabel,fBarcode,fStatus,fSort, ...$$('.cat')].forEach(el=>el.addEventListener('input', apply));
    apply(); renderFavs(); renderRecents(); paintStars();

    // Command palette
    const dlg=$('#cmd'), cmdq=$('#cmdq'), cmdres=$('#cmdres');
    function openCmd(){ dlg.showModal(); cmdq.value=''; drawCmd(''); cmdq.focus(); }
    function closeCmd(){ dlg.close(); }
    window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){ e.preventDefault(); openCmd(); } });
    dlg.addEventListener('close', ()=> cmdres.innerHTML='');

    function drawCmd(qs){
      cmdres.innerHTML='';
      const items = cards.map(c=>({name:c.dataset.name, epa:c.dataset.epa, el:c}));
      const term=qs.trim().toLowerCase();
      const score = (s)=>{
        if(!term) return 0; if(s===term) return 100; if(s.startsWith(term)) return 70; if(s.includes(term)) return 40; return 0;
      };
      items
        .map(o=>({o, sc: Math.max(score(o.name), score(o.epa||'')) }))
        .filter(v=>v.sc>0 || !term)
        .sort((a,b)=>b.sc-a.sc || a.o.name.localeCompare(b.o.name))
        .slice(0,40)
        .forEach(v=>{
          const row=document.createElement('div'); row.className='res';
          row.innerHTML=`<div><strong>${v.o.name}</strong><div class="kbd">EPA ${v.o.epa||'‚Äî'}</div></div><div class="kbd">Enter ‚Üí SDS</div>`;
          row.onclick=()=>{ closeCmd(); const btn=v.o.el.querySelector('.actions .sds'); if(btn) btn.click(); else jumpTo(v.o.name); };
          cmdres.appendChild(row);
        });
    }
    cmdq.addEventListener('input', ()=> drawCmd(cmdq.value));
    dlg.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeCmd(); });

    // Job Packs: filters by a short curated list
    $$('.lane [data-pack]').forEach(ch=> ch.addEventListener('click', (e)=>{ e.preventDefault(); const lst=JSON.parse(ch.dataset.pack||'[]').map(x=>x.toLowerCase()); q.value=''; $$('.cat').forEach(c=>c.checked=false); [fSds,fLabel,fBarcode].forEach(c=>c.checked=false); fStatus.value='all'; cards.forEach(c=>{ c.style.display = lst.includes(c.dataset.name) ? 'grid':'none'; }); }));

    // Truck prefilter via URL ?truck=12
    (function(){ const u=new URL(location.href); const t=u.searchParams.get('truck'); if(t){ $('#truck').value=t; document.title += ` ¬∑ Truck ${t}`; }})();
  </script>
</body>
</html>
