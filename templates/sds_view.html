<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SDS & Labels Â· Palm Coast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>

  <style>
    /* Page-local polish (uses your global tokens) */
    .header-bar{
      position:sticky; top:0; z-index:10;
      background: color-mix(in oklab, var(--surface-1), transparent 4%);
      backdrop-filter: blur(6px);
      border-bottom:1px solid var(--border);
      padding: 12px 0;
    }
    .title{ margin:0 0 4px; color:var(--primary) }
    .kpis{ display:flex; gap:.5rem; flex-wrap:wrap }
    .kpis .chip{
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.35rem .55rem; border-radius:.6rem;
      background:var(--accent); color:var(--primary-ink);
      border:1px solid color-mix(in oklab, var(--primary), #000 12%);
      font-weight:600; font-size:.9rem;
    }

    .toolbar{
      display:grid; gap:.6rem;
      grid-template-columns: 1fr;
      margin: 12px 0 16px;
    }
    @media(min-width:720px){
      .toolbar{ grid-template-columns: 1fr auto auto auto; align-items:center }
    }
    .search{ position:relative; }
    .search input{ padding-left:36px; }
    .search .icon{
      position:absolute; left:10px; top:50%; transform:translateY(-50%);
      opacity:.55;
    }
    .filters{ display:flex; gap:.5rem; flex-wrap:wrap; }
    .filters .select,
    .filters .check{
      display:flex; align-items:center; gap:.4rem;
      background:var(--surface-1);
      border:1px solid var(--border);
      padding:8px 10px; border-radius:8px;
      font-weight:600; color:var(--text-1)
    }
    .filters .select select{ border:none; background:transparent; font-weight:600; color:inherit; outline:none }

    .grid{
      display:grid; gap:12px;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
    .card{
      background:var(--surface-1);
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      box-shadow:0 2px 12px rgba(0,0,0,.05);
      display:flex; flex-direction:column; gap:.55rem;
    }
    .card h3{ margin:0; font-size:1.02rem; color:var(--text-1) }
    .meta{ color:var(--text-2); font-size:.95rem }

    .badges{ display:flex; gap:.4rem; flex-wrap:wrap; margin-top:.25rem }
    .badge{
      display:inline-flex; align-items:center; gap:.35rem;
      font-size:.85rem; font-weight:700;
      padding:.35rem .55rem; border-radius:999px;
      border:1px solid var(--border); background:var(--surface-2);
    }
    .badge.ok{ background:color-mix(in oklab, var(--success), #fff 85%); color:#065f46; border-color:color-mix(in oklab, var(--success), #000 14%) }
    .badge.warn{ background:color-mix(in oklab, var(--warning), #fff 86%); color:#92400e; border-color:color-mix(in oklab, var(--warning), #000 14%) }
    .badge.danger{ background:color-mix(in oklab, var(--danger), #fff 86%); color:#7f1d1d; border-color:color-mix(in oklab, var(--danger), #000 14%) }
    .links{ display:flex; flex-wrap:wrap; gap:.4rem; margin-top:.25rem }
    .links a{
      text-decoration:none;
      border:1px solid var(--border);
      padding:.45rem .6rem; border-radius:8px;
      background:var(--surface-1); color:var(--text-1); font-weight:600;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .links a:hover{ transform: translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.08) }

    .empty{
      text-align:center; color:var(--text-2); padding:28px 12px;
      border:1px dashed var(--border); border-radius:12px; background:var(--surface-1)
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <header class="header-bar">
      <div class="container">
        <h2 class="title">SDS & Label Portal</h2>
        <div class="kpis">
          {% set total = products|length %}
          {% set sds_count = products|selectattr('sds_url')|list|length %}
          {% set label_count = products|selectattr('label_url')|list|length %}
          {% set barcode_count = products|selectattr('barcode_img_url')|list|length %}
          <span class="chip">ðŸ“¦ {{ total }} products</span>
          <span class="chip">ðŸ“„ SDS: {{ sds_count }}</span>
          <span class="chip">ðŸ§¾ Labels: {{ label_count }}</span>
          <span class="chip">ðŸ§· Barcodes: {{ barcode_count }}</span>
        </div>
      </div>
    </header>

    <!-- Controls -->
    <section class="toolbar">
      <div class="search">
        <span class="icon">ðŸ”Ž</span>
        <input id="q" type="search" placeholder="Search by product name or EPA numberâ€¦" aria-label="Search products">
      </div>

      <div class="filters">
        <label class="check"><input type="checkbox" id="f-sds"> Has SDS</label>
        <label class="check"><input type="checkbox" id="f-label"> Has Label</label>
        <label class="check"><input type="checkbox" id="f-barcode"> Has Barcode</label>
      </div>

      <div class="filters">
        <div class="select">
          <span>Status:</span>
          <select id="f-status" aria-label="SDS status">
            <option value="all" selected>All</option>
            <option value="valid">Valid</option>
            <option value="expired">Expired</option>
            <option value="unknown">Unknown</option>
          </select>
        </div>
      </div>

      <div class="filters">
        <a href="/edit-sds" class="btn primary-btn">ðŸ›  Manage SDS Library</a>
      </div>
    </section>

    <!-- Grid -->
    <section id="grid" class="grid" aria-live="polite">
      {% for p in products %}
        {% set pid = p.id %}
        {% set name = p.name %}
        {% set epa = p.epa_number %}
        {% set sds = p.sds_url %}
        {% set label = p.label_url %}
        {% set barcode = p.barcode_img_url %}
        {% set uploaded = p.sds_uploaded_on %}

        {% set cutoff = today.replace(year=today.year - 3) %}
        {% if uploaded %}
          {% if uploaded < cutoff %}
            {% set status = 'expired' %}
            {% set status_text = 'ðŸ”´ SDS Expired' %}
            {% set badge_class = 'danger' %}
          {% else %}
            {% set status = 'valid' %}
            {% set status_text = 'âœ… SDS Valid' %}
            {% set badge_class = 'ok' %}
          {% endif %}
        {% else %}
          {% set status = 'unknown' %}
          {% set status_text = 'âšª No SDS date' %}
          {% set badge_class = 'warn' %}
        {% endif %}

        <article class="card"
          data-name="{{ name|lower }}"
          data-epa="{{ (epa or '')|lower }}"
          data-sds="{{ 1 if sds else 0 }}"
          data-label="{{ 1 if label else 0 }}"
          data-barcode="{{ 1 if barcode else 0 }}"
          data-status="{{ status }}"
        >
          <h3>{{ name }}</h3>
          {% if epa %}<div class="meta">EPA Reg #: <strong>{{ epa }}</strong></div>{% endif %}

          <div class="badges">
            <span class="badge {{ badge_class }}">{{ status_text }}{% if uploaded %} Â· {{ uploaded }}{% endif %}</span>
            {% if sds %}<span class="badge ok">SDS</span>{% else %}<span class="badge warn">No SDS</span>{% endif %}
            {% if label %}<span class="badge ok">Label</span>{% endif %}
            {% if barcode %}<span class="badge ok">Barcode</span>{% endif %}
          </div>

          <div class="links">
            {% if sds %}
              <!-- Use presigned URL from route, or switch to always-fresh redirect below -->
              <a href="{{ sds }}" target="_blank" rel="noopener" aria-label="Open SDS for {{ name }}">ðŸ“„ SDS</a>
              {# Alternatively: <a href="{{ url_for('sds_open', product_id=pid, kind='sds') }}" target="_blank" rel="noopener">ðŸ“„ SDS</a> #}
            {% endif %}
            {% if label %}
              <a href="{{ label }}" target="_blank" rel="noopener" aria-label="Open Label for {{ name }}">ðŸ§¾ Label</a>
              {# Or: <a href="{{ url_for('sds_open', product_id=pid, kind='label') }}" target="_blank" rel="noopener">ðŸ§¾ Label</a> #}
            {% endif %}
            {% if barcode %}
              <a href="{{ barcode }}" target="_blank" rel="noopener" aria-label="Open Barcode for {{ name }}">ðŸ§· Barcode</a>
              {# Or: <a href="{{ url_for('sds_open', product_id=pid, kind='barcode') }}" target="_blank" rel="noopener">ðŸ§· Barcode</a> #}
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </section>

    <div id="empty" class="empty" style="display:none">
      No products match your filters. Try clearing filters or changing your search.
    </div>

    <p class="small-muted" style="margin-top:18px">
      SDS validity is based on upload date ({{ today }}). Items older than 3 years are flagged as expired.
    </p>
  </div>

  <script>
    // --- Fast client-side filtering with debounce ---
    const q = document.getElementById('q');
    const fSds = document.getElementById('f-sds');
    const fLabel = document.getElementById('f-label');
    const fBarcode = document.getElementById('f-barcode');
    const fStatus = document.getElementById('f-status');
    const cards = Array.from(document.querySelectorAll('#grid .card'));
    const empty = document.getElementById('empty');

    function applyFilters(){
      const term = (q.value || '').trim().toLowerCase();
      const wantSds = fSds.checked;
      const wantLabel = fLabel.checked;
      const wantBarcode = fBarcode.checked;
      const status = fStatus.value; // all|valid|expired|unknown

      let visible = 0;
      cards.forEach(card => {
        const name = card.dataset.name;
        const epa = card.dataset.epa;
        const hasSds = card.dataset.sds === '1';
        const hasLabel = card.dataset.label === '1';
        const hasBarcode = card.dataset.barcode === '1';
        const st = card.dataset.status;

        const textMatch = !term || name.includes(term) || (epa && epa.includes(term));
        const sdsMatch = !wantSds || hasSds;
        const labelMatch = !wantLabel || hasLabel;
        const barcodeMatch = !wantBarcode || hasBarcode;
        const statusMatch = (status === 'all') || (st === status);

        const show = textMatch && sdsMatch && labelMatch && barcodeMatch && statusMatch;
        card.style.display = show ? '' : 'none';
        if (show) visible++;
      });
      empty.style.display = visible === 0 ? '' : 'none';
    }

    const debounce = (fn, ms=150) => {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    };

    q.addEventListener('input', debounce(applyFilters, 120));
    [fSds, fLabel, fBarcode, fStatus].forEach(el => el.addEventListener('change', applyFilters));
    // Initial
    applyFilters();
  </script>
</body>
</html>
