<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Analytics | Palm Coast</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    canvas { margin-bottom: 40px; }
    h2 { margin-top: 40px; }
    .chart-container { max-width: 900px; margin: auto; }
  </style>
</head>
<body>
  <h1>üìä Inventory Analytics</h1>

  <div class="chart-container">
    <h2>1Ô∏è‚É£ Product Price History</h2>
    <form method="GET">
      <label for="product">Select Product:</label>
      <select name="product_id" id="product" onchange="this.form.submit()">
        {% for product in all_products %}
          <option value="{{ product[0] }}" {% if selected_id == product[0] %}selected{% endif %}>
            {{ product[1] }}
          </option>
        {% endfor %}
      </select>
    </form>
    <canvas id="priceHistoryChart" height="100"></canvas>
  </div>

  <div class="chart-container">
    <h2>2Ô∏è‚É£ Monthly Inventory Usage</h2>
    <canvas id="usageChart" height="100"></canvas>
  </div>

  <div class="chart-container">
    <h2>3Ô∏è‚É£ Pest vs Lawn Monthly Totals</h2>
    <canvas id="categoryChart" height="100"></canvas>
  </div>
  <div class="chart-container">
    <h2>4Ô∏è‚É£ Tech Chemical % vs Production</h2>
    <form method="POST" action="/update-production" style="margin-bottom: 20px;">
      <label>Technician:</label>
      <select name="technician_id">
        {% for tech in technicians %}
          <option value="{{ tech[0] }}">{{ tech[1] }}</option>
        {% endfor %}
      </select>

      <label>Month:</label>
      <input type="month" name="month" required>

      <label>Production $:</label>
      <input type="number" step="0.01" name="production" required>

      <button type="submit">Save</button>
    </form>

    <table border="1" cellpadding="8" cellspacing="0" style="width:100%; text-align:center;">
      <thead>
        <tr>
          <th>Technician</th>
          <th>Month</th>
          <th>Production $</th>
          <th>Chemical Used $</th>
          <th>% Used</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for row in tech_chemical_table %}
          <tr>
            <td>{{ row.tech_name }}</td>
            <td>{{ row.month }}</td>
            <td>${{ "%.2f"|format(row.production) }}</td>
            <td>${{ "%.2f"|format(row.chemical_used) }}</td>
            <td>{{ "%.2f"|format(row.percent_used) }}%</td>
            <td style="color: {{ 'red' if row.percent_used > 4 else 'green' }}">
              {{ '‚ùå Over' if row.percent_used > 4 else '‚úÖ OK' }}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    const priceCtx = document.getElementById('priceHistoryChart').getContext('2d');
    new Chart(priceCtx, {
      type: 'line',
      data: {
        labels: {{ price_labels|tojson }},
        datasets: [{
          label: 'Unit Price ($)',
          data: {{ price_values|tojson }},
          borderColor: 'blue',
          tension: 0.3,
          fill: false
        }]
      }
    });

    const usageCtx = document.getElementById('usageChart').getContext('2d');
    new Chart(usageCtx, {
      type: 'bar',
      data: {
        labels: {{ usage_labels|tojson }},
        datasets: [
          {
            label: 'Start Value ($)',
            data: {{ start_values|tojson }},
            backgroundColor: 'green'
          },
          {
            label: 'End Value ($)',
            data: {{ end_values|tojson }},
            backgroundColor: 'orange'
          },
          {
            label: '% Used',
            data: {{ percent_used|tojson }},
            type: 'line',
            borderColor: 'red',
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        scales: {
          y: { beginAtZero: true },
          y1: {
            position: 'right',
            beginAtZero: true,
            grid: { drawOnChartArea: false },
            title: { display: true, text: "% Used" }
          }
        }
      }
    });

    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
      type: 'bar',
      data: {
        labels: {{ category_labels|tojson }},
        datasets: [
          {
            label: 'Pest ($)',
            data: {{ pest_values|tojson }},
            backgroundColor: 'purple'
          },
          {
            label: 'Lawn ($)',
            data: {{ lawn_values|tojson }},
            backgroundColor: 'teal'
          }
        ]
      },
      options: {
        scales: { y: { beginAtZero: true } }
      }
    });
  </script>
</body>
</html>
